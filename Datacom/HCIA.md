[toc]

# 数据通信基础

##  通信与网络

- 通信：是指人与人、人与物、物与物之间通过某种媒介和行为进行的信息传递与交流。
- 网络通信，是指终端设备之间通过计算机网络进行的通信。

### 常见术语

|   术语   |                       说明                       |
| :------: | :----------------------------------------------: |
| 数据载荷 |                最终想要传递的信息                |
|   报文   |            网络中交换与传输的数据单元            |
|   头部   |           在数据载荷的前面添加的信息段           |
|   尾部   |           在数据载荷的后面添加的信息段           |
|   封装   |   对数据载荷添加头部和尾部，形成新的报文的过程   |
|  解封装  |     去掉报文的头部和尾部，获取数据载荷的过程     |
|   网关   | 提供协议转换、路由选择、数据交换等功能的网络设备 |
|  路由器  |           为报文选择传递路径的网络设备           |
| 终端设备 |  数据通信系统的端设备，作为数据的发送者或接收者  |

数据通信网络，Data Communication Network

### 网络设备

#### 交换机

- 距离终端用户最近的设备

- 以太网交换机可以实现：数据帧的交换、终端用户设备的接入、基本的接入安全功能、二层链路的冗余等

- 广播域：一个节点发送一个广播报文其余节点都能够收到的节点的集合

#### 路由器

- 实现同类型网络或异种网络之间的通信

- 隔离广播域

- 维护路由表（Routing Table）、运行路由协议

- 路径（路由信息）选择、IP报文转发

- 广域网接入、网络地址转换

- 连接通过交换机组建的二层网络

#### 防火墙

- 隔离不同安全级别的网络

- 实现不同安全级别的网络之间的访问控制（安全策略）

- 用户身份认证

- 实现远程接入功能

- 实现数据加密及虚拟专用网业务

- 执行网络地址转换

- 其他安全功能

#### 无线设备

IEEE 802.11标准上的无线局域网技术。

- 无线接入点 (AP, Access Point)
  - 一般支持FAT AP、FIT AP和云管理工作模式
  - FAT AP：适用于家庭，独立工作，需单独配置，功能较为单一，成本低。
  - FIT AP：适用于大中型企业，需要配合AC使用，由AC统一管理和配置，功能丰富。
  - 云管理：适用于中小型企业，需要配合云管理平台使用，由云管理平台统一管理和配置，功能丰富，即插即用。

- 无线接入控制器 (AC, Access Controller)
  - 一般位于整个网络的汇聚层，提供高速、安全、可靠的WLAN业务。
  - 提供大容量、高性能、高可靠性、易安装、易维护的无线数据控制业务，具有组网灵活、绿色节能等优势。

## 网络类型与网络拓补

### 网络类型

- LAN 局域网 (Local Area Network)
  - 使用技术：以太网、Wi-Fi等

- MAN 城域网 (Metropolitan Area Network)
  - 使用技术：以太网 (10Gbps/100Gbps)、WiMAX (全球互通微波访问)

- WAN 广域网 (Wide Area Network)
  - 使用技术：HDLC、PPP等

### 网络拓补

网络拓扑（Network Topology）是指用传输介质互连各种设备所呈现的结构化布局。

- 星型网络
  - 所有节点通过一个中心节点连接在一起。
  - 优点：容易在网络中增加新的节点。通信数据必须经过中心节点中转，易于实现网络监控。
  - 缺点：中心节点的故障会影响到整个网络的通信。

- 总线型网络
  - 所有节点通过一条总线连接在一起。
  - 优点：安装简便，节省线缆。某一节点的故障一般不会影响到整个网络的通信。
  - 缺点：总线故障会影响到整个网络的通信。某一节点发出的信息可以被所有其他节点收到，安全性低。

- 环型网络
  - 所有节点连成一个封闭的环形。
  - 优点：节省线缆。
  - 缺点：增加新的节点比较麻烦，必须先中断原来的环，才能插入新节点以形成新环。

- 树型网络
  - 树型结构实际上是一种层次化的星型结构。
  - 优点：能够快速将多个星型网络连接在一起，易于扩充网络规模。
  - 缺点：层级越高的节点故障导致的网络问题越严重。

- 全网状网络
  - 所有节点都通过线缆两两互联。
  - 优点：具有高可靠性和高通信效率。
  - 缺点：每个节点都需要大量的物理端口，同时还需要大量的互连线缆。成本高，不易扩展。

- 部分网状网络
  - 只是重点节点之间才两两互连。
  - 优点：成本低于全网状网络。
  - 缺点：可靠性比全网状网络有所降低。

**在实际组网中，通常都会根据成本、通信效率、可靠性等具体需求而采用多种拓扑形态相结合的方法。**

## 网络工程与网络工程师

### 网络工程

在信息系统工程方法和完善的组织机构指导下，根据网络应用的需求，按照计算机网络系统的标准、规范和技术，规划设计可行性方案，将计算机网络硬件设备、软件和技术系统地集成在一起，以成为满足用户需求、高性价比的网络系统的组建工作。

### 网络工程师

在网络工程领域，掌握专业的网络技术，具备一定的职业技能及职业素养，具有一定项目实施经验，能够在项目现场与客户或者其他项目干系人充分沟通，根据客户的需求及环境因素制定实施方案及项目计划（得到项目干系人认可），并充分调动各方资源保证项目按时、保质保量落地，以及在项目实施后对干系人进行培训及工程文档交付的职业。

## 华为数通认证

- HCIA-Datacom：一门课程（考试）
  - 数据通信基本概念、路由交换技术基础、安全、WLAN，SDN与NFV，编程自动化基础、网络部署案例

- HCIP-Datacom：一门必选课程（考试），六门任选子认证课程（考试）

  - 必选课程（考试）：

    - HCIP-Datacom-Core Technology

  - 任选课程（考试）：
    - HCIP-Datacom-Advanced Routing & Switching Technology 
    - HCIP-Datacom-Campus Network Planning and Deployment 
    - HCIP-Datacom-Enterprise Network Solution Design 
    - HCIP-Datacom-WAN Planning and Deployment 
    - HCIP-Datacom-SD-WAN Planning and Deployment 
    - HCIP-Datacom-Network Automation Developer

- HCIE-Datacom：一门课程（考试），融合两大模块

  - 经典网络：

    - 基于命令行的经典数通技术理论

    - 基于命令行的经典数通技术部署

  - 华为SDN解决方案：

    - 企业SDN解决方案技术理论

    - 企业SDN解决方案规划部署

# 网络参考模型

## OSI 参考模型

OSI 模型(Open Systems Interconnection Model)，由国际化标准组织ISO (The International Organization for Standardization ) 收录在ISO 7489标准中并于1984年发布。

|   应用层   |                      对应用程序提供接口                      |
| :--------: | :----------------------------------------------------------: |
|   表示层   | 进行数据格式的转换，以确保一个系统生成的应用层数据能够被另外一个系统的应用层所识别和理解。 |
|   会话层   |             在通信双方之间建立、管理和终止会话。             |
|   传输层   | 建立、维护和取消一次端到端的数据传输过程。控制传输节奏的快慢，调整数据的排序等等。 |
|   网络层   |          定义逻辑地址；实现数据从源到目的地的转发。          |
| 数据链路层 | 将分组数据封装成帧；在数据链路上实现数据的点到点、或点到多点方式的直接通信；差错检测。 |
|   物理层   |         在媒介上传输比特流；提供机械的和电气的规约。         |

## TCP/IP 参考模型

### TCP/IP标准模型

- 应用层
- 主机到主机层
- 英特网层
- 网络接入层

### TCP/IP对等模型

- 应用层
- 传输层
- 网络层
- 数据链路层
- 物理层

###  TCP/IP常见协议

- 应用层
  - Telnet  23（TCP）远程登录协议
  - FTP（File Transfer Protocol，文件传输协议）20、21（TCP）
  - TFTP 69（UDP）简单文件传输协议
  - SNMP（UDP）
  - HTTP（Hypertext Transfer Protocol，超文本传输协议） 80（TCP）
  - SMTP 25（TCP）简单邮件传输协议
  - DNS（Domain Name Service，域名解析服务）
  - DHCP

- 传输层
  - TCP（Transmission Control Protocol，传输控制协议）IETF-RFC 793
  - UDP（User Datagram Protocol，用户数据报协议）IETF-RFC 768

- 网络层
  - ICMP（Internet Control Message Protocol，网际报文控制协议）
  - IGMP（Internet Group Management Protocol，因特网组管理协议）
  - IP（Internet Protocol，互联网协议）
  - IPv4( Internet Protocol Version 4)，简称IP
    - ARP（Address Resolution Protocol，地址解析协议）
  - VLSM（Variable Length Subnet Mask）可变长子网掩码
  - IPX（Internet Packet Exchange）

- 数据链路层
  - Ethernet ( 以太网协议 )
  - PPP（Point-to-Point Protocol，点对点协议）
  - PPPoE（Point-to-Point Protocol over Ethernet，以太网承载PPP协议）
  - HDLC
  - Frame Relay
  - ATM
  - CSMA/CD（Carrier Sense Multiple Access/Collision Detection）载波监听多路访问/冲突检测
  - VLAN（Virtual LAN）虚拟局域网
  - IEEE 802.1Q（Dot1Q）标准 VLAN Tag
  - Smart Link
  - Monitor Link
  - STP IEEE802.1d
  - RSTP IEEE802.1w
  - MSTP IEEE802.1s

- 物理层
  - RS232
  - V.24
  - V.35
  - G.703

**PDU**

- PDU（Packet Data Unit，协议数据单元）
  - Data 数据
  - Segment 断
  - Packet 包
  - Frame 帧
  - Bitstream 比特流

#### TCP和UDP报文格式

![image-20220719163030000](./assets/image-20220719163030000.png)

**TCP报文头部**

- Source Port：源端口，标识哪个应用程序发送。长度为16比特。

- Destination Port目：的端口，标识哪个应用程序接收。长度为16比特。

- Sequence Number：序号字段。TCP链接中传输的数据流每个字节都编上一个序号。序号字段的值指的是本报文段所发送数据的第一个字节的序号。长度为32比特。

- Acknowledgment Number：确认序列号，是期望收到对方下一个报文段数据的第1个字节的序号，即上次已成功接收到的数据段的最后一个字节数据的序号加1。只有Ack标识为1，此字段有效。长度为32比特。

- Header Length：头部长度，指出TCP报文头部长度，以32比特（4字节）为计算单位。若无选项内容，则该字段为5，即头部为20字节。

- Reserved：保留，必须填0。长度为6比特。

- Control bits：控制位，包含FIN、ACK、SYN等标志位，代表不同状态下的TCP数据段。

- Window：窗口TCP的流量控制，这个值表明当前接收端可接受的最大的数据总数（以字节为单位）。窗口最大为65535字节。长度为16比特。

- Checksum：校验字段，是一个强制性的字段，由发端计算和存储，并由收端进行验证。在计算检验和时，要包括TCP头部和TCP数据，同时在TCP报文段的前面加上12字节的伪头部。长度为16比特。
- Urgent:紧急指针，只有当URG标志置1时紧急指针才有效。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式。紧急指针指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）。长度为16比特。
- Options：选项字段（可选），长度为0-40字节。

**UDP报文头部**

- Source Port:源端口，标识哪个应用程序发送。长度为16比特。

- Destination Port:目的端口，标识哪个应用程序接收。长度为16比特。

- Length:该字段指定UDP报头和数据总共占用的长度。可能的最小长度是8字节，因为UDP报头已经占用了8字节。由于这个字段的存在，UDP报文总长不可能超过65535字节（包括8字节的报头，和65527字节的数据）。

- Checksum:覆盖UDP头部和UDP数据的校验和，长度为16比特。

**TCP**

- 建立连接-三次握手
- 序列号seq、确认序列号ack、flags：SYN、ACK、FIN
- 窗口滑动机制
- 关闭连接-四次握手

**ARP**

ARP缓存表有效期（缺省180s）

**双绞线**

- STP-屏蔽双绞线
- UTP-非屏蔽双绞线

**数据通信过程**

封装——解封装

# VRP

## VRP基础

### 文件系统

- 系统软件（.cc）
- 补丁文件（.pat）
- 配置文件（.cfg、.zip、.dat）
- PAF文件（.bin）提供简单有效的方式来裁剪产品的资源占用和功能特性

### 存储设备

- SDRAM 内存
- Flash（系统软件、配置文件；补丁文件、PAF文件）
- NVRAM 缓存（启动配置文件、日志缓存文件）
- SD Card（系统文件、配置文件、日志等）
- USB（外接）

### 设备管理

- Web网管
- 命令行
  - Consolo用户界面
    - Consolo口：RS232串口标准的RJ45口：
    - Serial COM 9600 连接
  - VTY（Virtual Type Terminal，虚拟类型终端）用户界面

### 用户级别

| 用户等级 |  命令等级  |  名称  |                        说明                        |
| :------: | :--------: | :----: | :------------------------------------------------: |
|    0     |     0      | 参观级 |         ping、tracert、Telnet、部分display         |
|    1     |    0、1    | 监控级 |                 系统维护、display                  |
|    2     |  0、1、2   | 配置级 |                      配置命令                      |
|   3-15   | 0、1、2、3 | 管理级 | 文件系统、FTP、TFTP下载、命令级别设置、debugging等 |

## 命令行基础

**命令字  [ 关键字  [ 参数名  参数值 ] ]**

- 每条命令有最多一个命令字，若干个关键字和参数，形成一条命令，参数必须由参数名和参数值组成。

- 命令字、关键字、参数名、参数值之间，需要用空格分隔开。

**用户视图——系统视图——其它视图**

### 命令行错误信息

```shell
[Huawei] sysname 
                  ^
Error:Incomplete command found at ‘^’ position. # 箭头所指地方提示命令不完整，需要进一步补齐

[Huawei] router if 1.1.1.1
                 ^
Error: Unrecognized command found at ‘^’ position. # 箭头所指地方提示该命令不能识别，需要确认命令正确性

[Huawei] a
         ^
Error:Ambiguous command found at ‘^’ position. # 箭头所指的命令不明确，有多个a开头的关键字

[Huawei-GigabitEthernet0/0/0]ospf cost 800000 # 箭头所指的参数值越界
                                         ^
Error: Wrong parameter found at '^' position.

```

### 文件系统操作命令

```shell
pwd 命令用来显示当前工作目录
dir [ /all ] [ filename | directory ]命令用来查看当前目录下的文件信息
more [ /binary ] filename [ offset ] [ all ]命令用来查看文本文件的具体内容
cd 修改用户当前的工作目录
mkdir 创建目录
rmdir 删除目录,只有空目录才能被删除
copy 复制
move 移动，move命令只适用于在同一储存设备中移动文件
rename 重命名
delete [ /unreserved ] [ /force ] { filename | devicename }命令可以用来删除文件 
       /unreserved参数，永久删除   /force 参数，系统将不会给出任何提示信息
undelete 恢复删除
reset recycle-bin [ filename | devicename ] 清空回收站
```

### 基本配置命令

```
sysname name 设备命名

clock timezone <time-zone-name> { add | minus } <offset> 用来配置本地时区信息。本地时间加上或减去offset即为UTC
clock datetime [ utc ] HH:MM:SS YYYY-MM-DD  用来修改UTC时间
colock daylight-saving-time 设置夏令时

command-privilege level <level> view <view-name> <command-key> 设置指定视图内的命令的级别

# password 登陆
user-interface vty 0 4  0-4五个用户，一般最多15个同时登陆
set authentication password cipher <pwd> 
idle-timeout <minutes> [seconds] 断开连接超时时间，缺省为10分钟

display current-configuration 查看当前运行的配置文件
save 配置文件保存
display saved-configuration 查看保存的配置
reset saved-configuration 清除已保存的配置
display startup 查看系统启动配置参数
startup saved-configuration <configuration-file> 配置系统下次启动时使用的配置文件
reboot 重启
```

# 以太网

## 以太网交换基础

### 以太网协议

以太网是建立在CSMA/CD (Carrier Sense Multiple Access/Collision Detection，载波监听多路访问/冲突检测)机制上的广播型网络。

- 冲突域是指连接在同一共享介质上的所有节点的集合，冲突域内所有节点竞争同一带宽，一个节点发出的报文（无论是单播、组播、广播），其余节点都可以收到。
- 广播报文所能到达的整个访问范围称为二层广播域，简称广播域，同一广播域内的主机都能收到广播报文。

**CSMA/CD的基本工作过程如下**

- 终端设备不停的检测共享线路的状态。

- 如果线路空闲则发送数据。

- 如果线路不空闲则一直等待。

- 如果有另外一个设备同时发送数据，两个设备发送的数据必然产生冲突，导致线路上的信号不稳定。

- 终端设备检测到这种不稳定之后，马上停止发送自己的数据。

- 终端设备发送一连串干扰脉冲，然后等待一段时间之后再进行发送数据。发送干扰脉冲的目的是为了通知其他设备，特别是跟自己在同一个时刻发送数据的设备，线路上已经产生了冲突。

**CSMA/CD的工作原理可简单总结为：先听后发，边发边听，冲突停发，随机延迟后重发。**

全1MAC地址FF-FF-FF-FF-FF-FF为广播地址，所有节点都会处理目的地址为广播地址的数据帧，该数据帧所能到达的整个访问范围称为二层广播域，简称广播域。

MAC (Medium Access Control)地址

NIC (Network Interface Card,网络接口卡)

### 以太网帧

以太帧的格式有两个标准：Ethernet_II格式和IEEE 802.3格式。

![image-20220720184029671](./assets/image-20220720184029671.png)

**Ethernet Ⅱ以太帧：**

- DMAC：6字节，目的MAC地址，6字节，该字段标识帧的接收者。

- SMAC：6字节，源MAC地址，6字节，该字段标识帧的发送者。

- Type：2字节，协议类型。常见值：
  - **0x0800：Internet Protocol Version 4 (IPv4) ；**
  - **0x0806：Address Resolution Protocol (ARP) 。**

**IEEE 802.3 LLC以太帧：**

- 逻辑链路控制LLC（Logical Link Control）由目的服务访问点DSAP（Destination Service Access Point）、源服务访问点SSAP（Source Service Access Point）和Control字段组成。
  - DSAP：1字节，目的服务访问点，若后面类型为IP值设为0x06。服务访问点的功能类似于Ethernet II帧中的Type字段或TCP/UDP传输协议中的端口号。
  - SSAP：1字节，源服务访问点，若后面类型为IP值设为0x06。 
  - Ctrl：1字节，该字段值通常设为0x03，表示无连接服务的IEEE 802.2无编号数据格式。

- SNAP（Sub-network Access Protocol）由机构代码（Org Code）和类型（Type）字段组成。
  - Org Code三个字节都为0。
  - Type字段的含义与Ethernet_II帧中的Type字段相同。

**数据帧的总长度为64-1518字节，以太网口的最大传输单元是1500字节，即MTU=1500B。**

- 以太网中，最小帧长为64字节，这是由最大传输距离和CSMA/CD机制共同决定的。

- 规定最小帧长是为了避免这种情况发生：A站点已经将一个数据包的最后一个Bit发送完毕，但这个报文的第一个Bit还没有传送到距离很远的B站点。B站点认为线路空闲继续发送数据，导致冲突。

- 高层协议必须保证Data域至少包含46字节，这样加上以太网帧头的14字节和帧尾的4字节校验码正好满足64字节的最小帧长，如果实际数据不足46个字节，则高层协议必须填充一些数据单元。

- 而出于对传输效率和传输可靠性的折中考虑，使得以太网帧的最大长度为1518字节，对应IP数据包就是1500字节。

- 较大的帧长度，数据的有效传输效率会更高；但是数据帧过长，传输时会占用共享链路过多的时间，对时延敏感应用造成极大的影响。

- 因此最终选择了一个折中的长度：1518字节的数据帧长，对应1500字节的IP数据包长度，这就是最大传输单元MTU的由来。

### MAC地址

- IP地址的作用是唯一标识网络中的一个节点，可以通过IP地址进行不同网段的数据访问。

- MAC地址的作用是唯一标识一个网卡，可以通过MAC地址进行同网段的数据访问。

**MAC地址由48比特（6个字节）长，12位的16进制数字组成**

- OUI （Organizationally Unique Identifier）：厂商代码，由IEEE分配，3 Byte，24 bit

6Byte，前3Byte为厂商代码

- 单播MAC地址：第8个bit置0
- 组播MAC地址：第8个bit置1
- 广播MAC地址：FF-FF-FF-FF-FF-FF

### 以太网交换机

**以太网二层交换机：**

- 在园区网络中，交换机一般来说是距离终端用户最近的设备，用于终端接入园区网，接入层的交换机一般为二层交换机。

**以太网三层交换机：**

- 不同局域网之间的网络互通由需要由路由器来完成。随着数据通信网络范围的不断扩大，网络业务的不断丰富，网络间互访的需求越来越大，而路由器由于自身成本高、转发性能低、接口数量少等特点无法很好的满足网络发展的需求。因此出现了三层交换机这样一种能实现高速三层转发的设备。

### 交换机工作原理

- 二层交换机工作在数据链路层，它对数据帧的转发是建立在MAC地址基础之上的。交换机不同的接口发送和接收数据是独立的，各接口属于不同的冲突域，因此有效地隔离了网络中的冲突域。

- 二层交换设备通过学习以太网数据帧的**源MAC地址**来维护MAC地址与接口的对应关系（保存MAC与接口对应关系的表称为MAC地址表），通过其目的MAC地址来查找MAC地址表决定向哪个接口转发。

交换机会通过传输介质进入其端口的每一个帧都进行转发操作，交换机的基本作用就是用来转发数据帧。

**交换机对帧的处理行为一共有三种：泛洪（Flooding），转发（Forwarding），丢弃（Discarding）。**

- 泛洪：交换机把从某一端口进来的帧通过所有其它的端口转发出去（注意，“所有其它的端口”是指除了这个帧进入交换机的那个端口以外的所有端口）。
  - 如果从传输介质进入交换机的某个端口的帧是一个单播帧，交换机会去MAC表查这个帧的目的MAC地址。如果查不到这个MAC地址，则交换机将对该单播帧执行泛洪操作。
  - 如果从传输介质进入交换机的某个端口的帧是一个广播帧，交换机不会去查MAC地址表，而是直接对该广播帧执行泛洪操作。

- 转发：交换机把从某一端口进来的帧通过另一个端口转发出去（注意，“另一个端口”不能是这个帧进入交换机的那个端口）。
  - 如果从传输介质进入交换机的某个端口的帧是一个单播帧，则交换机会去MAC表查这个帧的目的MAC地址。如果查到了这个MAC地址表，则比较这个MAC地址在MAC地址表中对应的端口编号是不是这个帧从传输介质进入交换机的那个端口的端口编号。如果不是，则交换机执行转发操作。

- 丢弃：交换机把从某一端口进来的帧直接丢弃。
  - •如果从传输介质进入交换机的某个端口的帧是一个单播帧，则交换机会去MAC表查这个帧的目的MAC地址。如果查到了这个MAC地址表，则比较这个MAC地址在MAC地址表中对应的端口编号是不是这个帧从传输介质进入交换机的那个端口的端口编号。如果是，则交换机将对该帧执行丢弃操作。

**MAC地址表中动态学习的表项并非永远有效，每一条表项都有一个生存周期，到达生存周期仍得不到更新的表项将被删除，这个生存周期被称作老化时间。例如华为S系列交换机的老化时间缺省值是300秒。**

## VLAN

### VLAN概述

- 在典型交换网络中，当某台主机发送一个广播帧或未知单播帧时，该数据帧会被泛洪，甚至传递到整个广播域。

- 广播域越大，产生的网络安全问题、垃圾流量问题，就越严重。

为了解决广播域带来的问题，人们引入了**VLAN (Virtual Local Area Network)**，即虚拟局域网技术

**特点：**

- VLAN的特点：

  - 一个VLAN就是一个广播域，所以在同一个VLAN内部，计算机可以直接进行二层通信，而不同VLAN内的计算机，无法直接进行二层通信，只能进行三层通信来传递信息，即广播报文被限制在一个VLAN内。
  - VLAN的划分不受地域的限制。
- VLAN的好处：
- 灵活构建虚拟工作组：用VLAN可以划分不同的用户到不同的工作组，同一工作组的用户也不必局限于某一固定的物理范围，网络构建和维护更方便灵活。
  - 限制广播域：广播域被限制在一个VLAN内，节省了带宽，提高了网络处理能力。
- 增强局域网的安全性：不同VLAN内的报文在传输时是相互隔离的，即一个VLAN内的用户不能和其它VLAN内的用户直接通信。
  - 提高了网络的健壮性：故障被限制在一个VLAN内，本VLAN内的故障不会影响其他VLAN的正常工作。

### VLAN基本原理

#### VLAN标签

IEEE 802.1Q协议规定，在以太网数据帧中加入4个字节的VLAN标签，又称VLAN Tag，简称Tag。

#### VLAN数据帧

![image-20220720191848715](./assets/image-20220720191848715.png)

**在一个VLAN交换网络中，以太网帧主要有以下两种形式：**

- 有标记帧（Tagged帧）：IEEE 802.1Q协议规定，在以太网数据帧的目的MAC地址和源MAC地址字段之后、协议类型字段之前加入4个字节的VLAN标签（又称VLAN Tag，简称Tag）的数据帧。

- 无标记帧（Untagged帧）：原始的、未加入4字节VLAN标签的数据帧。

**VLAN数据帧中的主要字段：**

- TPID：2字节，Tag Protocol Identifier（标签协议标识符），表示数据帧类型。
  - 取值为0x8100时表示IEEE 802.1Q的VLAN数据帧。如果不支持802.1Q的设备收到这样的帧，会将其丢弃。
  - 各设备厂商可以自定义该字段的值。当邻居设备将TPID值配置为非0x8100时，为了能够识别这样的报文，实现互通，必须在本设备上修改TPID值，确保和邻居设备的TPID值配置一致。

- PRI：3 bit，Priority，表示数据帧的优先级，用于QoS。
  - **取值范围为0～7**，值越大优先级越高。当网络阻塞时，交换机优先发送优先级高的数据帧。

- CFI：1 bit，Canonical Format Indicator（标准格式指示位），表示MAC地址在不同的传输介质中是否以标准格式进行封装，用于兼容以太网和令牌环网
  - CFI取值为0表示MAC地址以标准格式进行封装，为1表示以非标准格式封装。
  - 在以太网中，CFI的值为0。

- VID：12 bit，VLAN ID，表示该数据帧所属VLAN的编号。
  - VLAN ID取值范围是0～4095。由于0和4095为协议保留取值，所以**VLAN ID的有效取值范围是1～4094**。

**如何识别带VLAN标签的数据帧：**数据帧的Length/Type = 0x8100。

**注意：**计算机无法识别Tagged数据帧，因此计算机处理和发出的都是Untagged数据帧；为了提高处理效率，交换机内部处理的数据帧一律都是Tagged帧。

#### VLAN的划分方式

**VLAN的划分包括如下5种方法：**

- 基于接口划分：根据交换机的接口来划分VLAN。
  - 网络管理员预先给交换机的每个接口配置不同的PVID，当一个数据帧进入交换机时，如果没有带VLAN标签，该数据帧就会被打上接口指定PVID的标签，然后数据帧将在指定VLAN中传输。

- 基于MAC地址划分：根据数据帧的源MAC地址来划分VLAN。
  - 网络管理员预先配置MAC地址和VLAN ID映射关系表，当交换机收到的是Untagged帧时，就依据该表给数据帧添加指定VLAN的标签，然后数据帧将在指定VLAN中传输。

- 基于IP子网划分：根据数据帧中的源IP地址和子网掩码来划分VLAN。
  - 网络管理员预先配置IP地址和VLAN ID映射关系表，当交换机收到的是Untagged帧，就依据该表给数据帧添加指定VLAN的标签，然后数据帧将在指定VLAN中传输。

- 基于协议划分：根据数据帧所属的协议（族）类型及封装格式来划分VLAN。
  - 网络管理员预先配置以太网帧中的协议域和VLAN ID的映射关系表，如果收到的是Untagged帧，就依据该表给数据帧添加指定VLAN的标签，然后数据帧将在指定VLAN中传输。

- 基于策略划分：根据配置的策略划分VLAN，能实现多种组合的划分方式，包括接口、MAC地址、IP地址等。
  - 网络管理员预先配置策略，如果收到的是Untagged帧，且匹配配置的策略时，给数据帧添加指定VLAN的标签，然后数据帧将在指定VLAN中传输。

#### 接口类型

- Access接口
  - Access接口一般用于和不能识别Tag的用户终端（如用户主机、服务器等）相连，或者不需要区分不同VLAN成员时使用。

- Trunk接口
  - Trunk接口一般用于连接交换机、路由器、AP以及可同时收发Tagged帧和Untagged帧的语音终端。

- Hybrid接口
  - Hybrid接口既可以用于连接不能识别Tag的用户终端（如用户主机、服务器等），也可以用于连接交换机、路由器以及可同时收发Tagged帧和Untagged帧的语音终端、AP。
  - 华为设备默认的接口类型是Hybrid。

|   接口类型   |               Access                |                 Trunk                  |               Hybrid                |
| :----------: | :---------------------------------: | :------------------------------------: | :---------------------------------: |
| 接收Untagged |         接收，打Tag（PVID）         |  打Tag（PVID），查 allowed-pass vlan   | 打Tag（PVID），查 allowed-pass vlan |
|  接收Tagged  | VLAN ID与PVID相同则接收，不同则丢弃 |          查 allowed-pass vlan          |        查 allowed-pass vlan         |
|     发送     |        比较 VLAN ID 与 PVID         | 查 allowed-pass vlan,比较VLAN ID和PVID |        查 allowed-pass vlan         |
|     发送     |     相同则去Tag转发，不同则丢弃     |    相同则去Tag发送，不同则带Tag转发    |    查Tagged vlan、Untagged vlan     |

#### VLAN的规划

**VLAN分配原则**

- 按业务规划：可分为语音、视频和数据。

- 按部门规划：可分为工程部、市场部、财经部等。

- 按应用规划：可分为服务器、办公、教室等。

**VLAN分配技巧**

VLAN ID的分配在有效范围内，可以随意分配和选取，但是为了提高VLAN ID的连续性，可以采用VLAN ID和子网关联的方式进行分配。

**VLAN编号建议连续分配，以保证VLAN资源合理利用。最常用的划分方式是基于接口的方式。**

#### VLAN配置命令

```shell
display vlan 查看VLAN的相关信息

vlan <vlan-id> 创建VLAN
vlan batch {<vlan-id1>[to <vlan-id2>]}  批量创建VLAN

port link-type { access|Trunk|hybrid } 配置接口类型

port default vlan <vlan-id>  配置Access口缺省VLAN
port Trunk pvid vlan <vlan-id> 配置Trunk口缺省VLAN
port Hybrid pvid vlan <vlan-id> 配置Hybrid口缺省VLAN

# 配置Trunk口允许通过的VLAN
port trunk allowed-pass vlan {{<vlan-id1>[to <vlan-id2>]}|all} 
# 配置Hybrid口允许通过的Untagged VLAN
port hybrid untagged vlan {{<vlan-id1>[to <vlan-id2>]}|all} 
# 配置Hybrid口允许通过的Tagged VLAN
port hybrid tagged vlan {{<vlan-id1>[to <vlan-id2>]}|all}

# 关联MAC地址与VLAN
[Huawei-vlan10] mac-vlan mac-address <mac-address> [ <mac-address-mask> | <mac-address-mask-length> ]
[Huawei-GigabitEthernet0/0/1] mac-vlan enable  使能 mac-vlan（接口视图下）

mac-address-mask：指定MAC地址掩码。
格式为H-H-H，其中H为1至4位的十六进制数。
mac-address-mask-length：指定MAC地址掩码长度。
整数形式，取值范围是1～48。
```

**基于MAC划分VLAN配置接口为Hybrid接口**：在Access接口和Trunk接口上，只有基于MAC划分的VLAN和PVID相同时，才能使用MAC VLAN功能。所以基于MAC地址划分VLAN推荐在Hybrid口上配置。

## 生成树

### 生成树概述

STP（Spanning Tree Protocol）

RSTP（Rapid Spanning Tree Protocol）

- 在以太网中，二层网络的环路会带来广播风暴，MAC地址表震荡，重复数据帧等问题，为解决交换网络中的环路问题，提出了STP。

- STP通过构造一棵树来消除交换网络中的环路。

- 运行STP算法，判断网络中存在环路的地方并阻断冗余链路，将环路网络修剪成无环路的树型网络，从而避免了数据帧在环路网络中的增生和无穷循环。

**常见环路主要分为二层环路和三层环路。**

- 二层环路主要因为网络中部署了二层冗余环境，或人为的误接线缆导致，可以通过借助特定的协议或机制实现二层防环；

- 三层环路主要因为路由环路，可以通过动态路由协议防环和IP报文头部中的TTL字段用于防止报文被无止尽地转发。

### STP

#### 基本概念

- BID（Bridge ID）：桥ID
  - 桥优先级（Bridge priority）（16bit）.桥MAC（48bit）
  - 0~65535，默认值32768，,可以修改但是**修改值必须为4096的倍数**。
- 根桥（Root Bridge）：BID最小的设备
  - 网络收敛后，根桥会按照一定的时间间隔产生并向外发送配置BPDU
  - 其他设备仅对该报文进行处理，传达拓扑变化记录，从而保证拓扑的稳定。
- 开销（Cost）：
  - 交换机的每个端口都有一个端口开销（Port Cost）参数，此参数表示该端口在STP中的开销值
  - 默认情况下端口的开销和端口的带宽有关，带宽越高，开销越小。
  - 华为交换机支持多种STP的路径开销计算标准，提供多厂商场景下最大程度的兼容性。
  - 缺省情况下，华为交换机使用IEEE 802.1t标准来计算路径开销。
- RPC（Root Path Cost）：
  - 根路径开销，从根桥到某台设备沿途**所有入方向cost累加**。
  - 根桥的根路径开销是0。
- PID（Port ID）：接口ID，优先级（4bit）.接口编号（12bit）**???**
  - 端口优先级取值范围是0到240，步长为16，即取值必须为16的整数倍。
  - 缺省情况下，端口优先级是128。
- BPDU（Bridge Protocol Data Unit）：网桥协议数据单元
  - 配置BPDU（Configuration BPDU）
    - 配置BPDU包含了桥ID、路径开销和端口ID等参数。STP协议通过在交换机之间传递配置BPDU来选举根交换机，以及确定每个交换机端口的角色和状态。在初始化过程中，每个桥都主动发送配置BPDU。在网络拓扑稳定以后，只有根桥主动发送配置BPDU，其他交换机在收到上游传来的配置BPDU后，才会发送自己的配置BPDU。
  - TCN BPDU（Topology Change Notification BPDU）
    - TCN BPDU是指下游交换机感知到拓扑发生变化时向上游发送的拓扑变化通知。

#### 配置BPDU的报文格式

| **字节** |   **字段**    |                           **描述**                           |
| :------: | :-----------: | :----------------------------------------------------------: |
|    2     |      PID      |            协议ID  ，对于STP而言，该字段的值总为0            |
|    1     |      PVI      |           协议版本ID，对于STP而言，该字段的值总为0           |
|    1     |   BPDU Type   | 指示本BPDU的类型，若值为0x00，则表示本报文为配置BPDU；若值为0x80，则为TCN  BPDU |
|    1     |     Flags     | 标志，STP只使用了该字段的最高及最低两个比特位，最低位是TC（Topology  Change，拓扑变更）标志，最高位是TCA（Topology  Change Acknowledgment，拓扑变更确认）标志 |
|    8     |    Root ID    |                         根网桥的桥ID                         |
|    4     |      RPC      |                根路径开销，到达根桥的STP Cost                |
|    8     |   Bridge ID   |                        BPDU发送桥的ID                        |
|    2     |    Port ID    |            BPDU发送网桥的接口ID（优先级+接口号）             |
|    2     | Message  Age  | 消息寿命，从根网桥发出BPDU之后的秒数，每经过一个网桥都减1，所以它本质上是到达根桥的跳数 |
|    2     |   Max  Age    | 最大寿命，当一段时间未收到任何BPDU，生存期到达最大寿命时，网桥认为该接口连接的链路发生故障。默认20s |
|    2     |  Hello Time   |          根网桥连续发送的BPDU之间的时间间隔，默认2s          |
|    2     | Forward Delay |   转发延迟，在**侦听和学习**状态所停留的时间间隔，默认15s    |

#### 配置BPDU的比较原则

**STP按照如下顺序选择最优的配置BPDU：**

1. 最小的根桥ID

2. 最小的RPC

3. 最小的网桥ID
4. 最小的接口ID

**STP操作：**

1. 选举一个根桥。

2. 每个非根交换机选举一个根端口。

3. 每个网段选举一个指定端口。

4. 阻塞非根、非指定端口。

**STP中定义了三种端口角色：指定端口，根端口和预备端口。**

- 指定端口是交换机向所连网段转发配置BPDU的端口，每个网段有且只能有一个指定端口。一般情况下，根桥的每个端口总是指定端口。

- 根端口是非根交换机去往根桥路径最优的端口。在一个运行STP协议的交换机上最多只有一个根端口，但根桥上没有根端口。

- 如果一个端口既不是指定端口也不是根端口，则此端口为预备端口。预备端口将被阻塞。

#### STP 计算过程

- 选举根桥

  - STP交换机初始启动之后，都会认为自己是根桥，并在发送给其他交换机的BPDU中宣告自己为根桥。
  - 当交换机收到网络中其他设备发送来的BPDU后，会比较BPDU中的根桥ID和自己的BID。
  - 交换机不断交互BPDU，同时对BID进行比较，最终选举一台BID最小的交换机作为根桥，其他的则为非根桥。
  - 根桥的角色可抢占。当有更优的BID的交换机加入网络时，网络会重新进行STP计算，选出新的根桥。

- 选举根接口

  - 每一台非根桥交换机都会在自己的接口中选举出一个接口。

  - 非根桥交换机上有且只会有一个根接口。

  - 当非根桥交换机有多个接口接入网络中时，根接口是其收到最优配置BPDU的接口。

    - 交换机有多个端口接入网络，各个端口都会收到BPDU报文，报文中会携带“RootID、RPC、BID、PID”等关键字段，端口会针对这些字段进行PK。
    - 首先比较根路径开销（RPC），STP协议把根路径开销作为确定根端口的重要依据。RPC值越小，越优选，因此交换机会选RPC最小的端口作为根端口。
    - 当RPC相同时，比较上行交换机的BID，即比较交换机各个端口收到的BPDU中的BID，值越小，越优选。
    - 当上行交换机BID相同时，比较上行交换机的PID，即比较交换机各个端口收到的BPDU中的PID，值越小，越优选。
    - 当上行交换机的PID相同时，则比较本地交换机的PID，即比较本端交换机各个端口各自的PID，值越小，越优选。
  
- 选举指定接口 

  - 网络中的每个链路与根桥之间的工作路径必须是唯一的且最优的。

  - 当一个链路有两条及以上的路径通往根桥时，与该链路相连的交换机（可能不止一台）就必须确定出一个唯一的指定端口。

  - 因此，每个链路（Link）选举一个指定端口，用于向这个链路发送BPDU。

  - 一般情况下，根桥上不存在任何根端口，只存在指定端口。

  - 选举过程：

    - 首先比较根路径开销（RPC），值越小，越优选，因此交换机会选RPC最小的端口作为指定端口。
    
    - 若RPC相等，则比较链路两端交换机的BID，值越小，越优选。
    - 若BID相等，则比较链路两端端口的PID，值越小，越优选。
  
- 阻塞非指定接口（预备端口）

  - 在确定了根端口和指定端口之后，交换机上所有剩余的非根端口和非指定端口统称为预备端口
  
  - STP会对这些非指定端口进行逻辑阻塞，即这些端口不能转发由终端计算机产生并发送的帧（用户数据帧）。

  - 一旦非指定端口被逻辑阻塞后，STP树（无环路工作拓扑）就生成了。

**注意：**

- 非指定端口可以接收并处理BPDU。
- 根端口和指定端口既可以接收和发送BPDU，也可以转发用户数据帧。

#### STP接口状态

- 禁用（Disable）：

  - 不能收发BPDU，不能收发业务数据帧

- 阻塞（Blocking）：

  - 端口仅仅能接收并处理BPDU，不能转发BPDU，也不能转发用户流量。

  - 此状态是预备端口的最终状态。

- 侦听（Listing）：

  - 可以收发BPDU，不能收发业务数据帧

- 学习（learning）：

  - 端口可根据收到的用户流量构建MAC地址表，但不转发用户流量。
  - 增加Learning状态是为了防止临时环路。

- 转发（Forwarding）

  - 端口既可转发用户流量也可转发BPDU报文
  - 只有根端口或指定端口才能进入Forwarding状态。

#### 拓补变化

- 根桥故障：Max Age 计时20s，重新选举根桥，经历两个Forward Delay 15s时间，总计50s收敛时间恢复
- 直连链路故障：经历两个Forward Delay 15s时间，总计30s收敛时间恢复
- 非直连链路故障：50s收敛时间恢复

MAC地址表错误 ：老化时间300s，触发TCN BPDU，老化时间缩短为15s

**TCN BPDU先发给根桥，根桥再通知**

- 拓扑变化过程中，根桥通过TCN BPDU报文获知生成树拓扑里发生了故障。

- 根桥生成TC用来通知其他交换机加速老化现有的MAC地址表项。

**拓扑变更以及MAC地址表项更新的具体过程如下：**

- SW3感知到网络拓扑发生变化后，会不间断地向SW2发送TCN BPDU报文。

- SW2收到SW3发来的TCN BPDU报文后，会把配置BPDU报文中的Flags的TCA位设置1，然后发送给SW3，告知SW3停止发送TCN BPDU报文。

- SW2向根桥转发TCN BPDU报文。

- SW1把配置BPDU报文中的Flags的TC位设置为1后发送，通知下游设备把MAC地址表项的老化时间由默认的300 s修改为Forward Delay的时间（默认为15 s）。

- 最多等待15 s之后，SW2中的错误MAC地址表项会被自动清除。此后，SW2就能重新开始MAC表项的学习及转发操作。

### RSTP

- IEEE于2001年发布的**802.1w**标准定义了快速生成树协议RSTP（Rapid Spanning-Tree Protocol），RSTP在STP基础上进行了改进，实现了网络拓扑快速收敛。

- RSTP（快速生成树）是从STP演化而来的，基本思想一样；当交换网络拓扑结构发生变化时， RSTP可以通过Proposal/Agreement机制更快地恢复网络的连通性。
- RSTP是可以与STP实现后向兼容的，但在实际中，并不推荐这样的做法，原因是RSTP会失去其快速收敛的优势，而STP慢速收敛的缺点会暴露出来。

**RSTP对STP的其他改进:**

- 配置BPDU的处理发生变化：
  - 拓扑稳定后，配置BPDU报文的发送方式进行了优化；
  - 使用更短的BPDU超时计时；
  - 对处理次等BPDU的方式进行了优化；

- 配置BPDU格式的改变，充分利用了STP协议报文中的Flag字段，明确了接口角色。

- RSTP拓扑变化处理：相比于STP进行了优化，加速针对拓扑变更的反应速度。

#### 端口角色

通过接口角色的增补，简化了生成树协议的理解及部署

![image-20220720231043960](./assets/image-20220720231043960.png)

**RSTP的接口角色共有4种：根接口、指定接口、预备接口和备份接口**

- 从配置BPDU报文发送角度来看：
  - 预备（Alternate）接口就是由于学习到其它网桥发送的配置BPDU报文而阻塞的接口。
  - 备份（Backup）接口就是由于学习到自己发送的配置BPDU报文而阻塞的接口。

- 从用户流量角度来看：
  - Alternate接口提供了从指定桥到根的另一条可切换路径，作为根接口的备份接口。
  - Backup接口作为指定接口的备份，提供了另一条从根桥到相应网段的备份通路。

#### 边缘端口

如果指定端口位于整个域的边缘，不再与任何交换设备连接，这种端口叫做边缘端口。

- 在STP中用户终端接入交换设备端口状态由Disabled状态转到Forwarding状态需要经过15s，那么用户在这段时间无法上网，如果网络频繁变化，用户上网状态非常不稳定，时断时续。

- 边缘端口一般与用户终端设备直接连接，不与任何交换设备连接。边缘端口正常情况下接收不到配置BPDU报文，不参与RSTP运算，可以由Disabled状态直接转到Forwarding状态，且不经历时延，就像在端口上将STP禁用了一样。但是，一旦边缘端口收到配置BPDU报文，就丧失了边缘端口属性，成为普通STP端口，并重新进行生成树计算，从而引起网络震荡。

#### 端口状态

- Discarding：不转发用户流量，不学习MAC
- Learning：不转发用户流量，但学习MAC
- Forwarding：既转发用户流量，又学习MAC

| STP接口状态 | RSTP接口状态 |         接口角色         |
| :---------: | :----------: | :----------------------: |
| Forwarding  |  Forwarding  |     根接口、指定接口     |
|  Learning   |   Learning   |     根接口、指定接口     |
|  Listening  |  Discarding  |     根接口、指定接口     |
|  Blocking   |  Discarding  | Alternet接口、Backup接口 |
|  Disabled   |  Discarding  |       Disable接口        |

### MSTP（多生成树）

RSTP和STP还存在同一个缺陷：由于局域网内所有的VLAN共享一棵生成树，因此无法在VLAN间实现数据流量的负载均衡，链路被阻塞后将不承载任何流量，还有可能造成部分VLAN的报文无法转发。

stp/rstp 缺陷：所有VLAN共用一颗生成树

#### VBST

华为公司提出了VBST（VLAN-Based Spanning Tree）生成树解决方案。该解决方案中，生成树的形成是基于VLAN的，不同VLAN间可形成相互独立的生成树，不同VLAN内的流量沿着各自的生成树转发，进而可实现流量的负载分担。

**企业网中部署VBST：**

- 可消除网络中可能存在的通信环路。

- 可实现链路的复用和流量的负载分担，进而有效地提高链路带宽的利用率。

- 配置和维护简单，进而可降低配置和维护成本。

- 但是如果网络中VLAN的数量较多，为每个VLAN执行独立的生成树计算将耗费交换机大量的资源。

#### MSTP

- 为了弥补STP和RSTP的缺陷，IEEE于2002年发布的802.1s标准定义了MSTP。

- MSTP兼容STP和RSTP，既可以快速收敛，又提供了数据转发的多个冗余路径，在数据转发过程中实现VLAN数据的负载均衡。

- MSTP把一个交换网络划分成多个域，每个域内形成多棵生成树，生成树之间彼此独立。

- 每棵生成树叫做一个多**生成树实例MSTI（Multiple Spanning Tree Instance）**。

- 所谓生成树实例就是多个VLAN的一个集合。

- 通过将多个VLAN捆绑到一个实例，可以节省通信开销和资源占用率。

- MSTP各个实例拓扑的计算相互独立，在这些实例上可以实现负载均衡。

- 可以把多个相同拓扑结构的VLAN映射到一个实例里，这些VLAN在接口上的转发状态取决于接口在对应实例的状态。

### 生成树配置命令

```
#STP
stp mode {stp|rstp|mstp} 配置生成树工作模式（默认mstp）
stp root primary 配置当前设备为根桥，优先级数值自动为0且不能更改（可选）
stp root secondary 配置当前设备为备份根桥，优先级数值自动为4096且不能更改（可选）
stp priority <priorty> 配置stp优先级，缺省32768（可选）

# 配置接口路径开销计算方法，缺省为IEEE 802.1t（dot1t）标准方法（可选）
stp pathcost-standard {dot1d-1998|dot1t|legacy} 

stp cost <cost> 配置当前接口路径开销（接口视图下）（可选）
stp priority <priorty> 配置当前接口优先级（接口视图下），缺省128（可选）
stp enable 使能stp，缺省情况下，设备的STP/RSTP/MSTP功能处于启用状态。

#MSTP
stp mode {stp|rstp|mstp} 配置生成树工作模式（默认mstp）
stp region-configuration 进入MSTP配置模式
region-name <name> 配置域名
instance 1 vlan 1 3 5 7 创建实例
instance 2 vlan 2 4 6 8 创建实例
active region-configuration 激活MSTP配置
#配置实例根交换机、备份根交换机
[SW1]stp instance 1 root primary
[SW1]stp instance 2 root secondary
[SW2]stp instance 2 root primary
[SW2]stp instance 1 root secondary
```

### Smart Link

- Smart  Link 组（只能两个端口）
  - master （主）
  - slave （备）

### Monitor Link

- Monitor Link组：监控链路组，由上行端口和下行端口组成，下行端口状态跟随上行端口变化

  - 上行端口：Uplink，可以有多个，Uplink 全故障则 Downlink Down

  - 下行端口：Downlink，可以有多个，Downlink状态不影响Uplink

### Smart Link 、Monitor Link配置命令

```
#关闭STP，创建 Smart Link 组（只能两个端口），指定端口角色master和slave，使能Smart Link
stp disable （接口视图下）
smart-link group 1  （smart-link group视图下）
port GE0/0/1 master （smart-link group视图下）
port GE0/0/2 slave  （smart-link group视图下）
smart-link enable   （smart-link group视图下）

#创建monitor-link组，添加uplink和downlink组
monitor-link group 1
port ge0/0/1 uplink
port ge0/0/2 down-link
```
## VLAN间通信

- VLAN之间需要通过三层通信实现互访，三层通信需借助三层设备

- 常见的三层设备：路由器、三层交换机、防火墙等。

- 将二层交换机与路由器的三层接口互联，由三层设备进行路由转发来实现通信。

### 使用路由器的物理接口

- 在二层交换机上配置VLAN，每个VLAN单独使用一个交换机接口与路由器互联。

- 路由器使用两个物理接口，分别作为VLAN 10及VLAN 20内PC的默认网关，使用路由器的物理接口实现VLAN之间的通信。

- 路由器三层接口作为网关，转发本网段前往其它网段的流量。

- 路由器三层接口无法处理携带VLAN Tag的数据帧，因此交换机上联路由器的接口需配置为Access。

- 路由器的一个物理接口作为一个VLAN的网关，因此存在一个VLAN就需要占用一个路由器物理接口。

- 路由器作为三层转发设备其接口数量较少，方案的可扩展性太差。

### 使用路由器子接口

- R1使用一个物理接口（GE0/0/1）与交换机SW1对接，并基于该物理接口创建两个子接口：GE0/0/1.10及GE0/0/1.20，分别使用这两个子接口作为VLAN 10及VLAN 20的默认网关。

- 由于三层子接口不支持VLAN报文，当它收到VLAN报文时，会将VLAN报文当成是非法报文而丢弃。因此，需要在子接口上将VLAN Tag剥掉，也就是需要VLAN终结（VLAN Termination）。

- 子接口（Sub-Interface）是基于路由器以太网接口所创建的逻辑接口，以物理接口ID+子接口ID进行标识，子接口同物理接口一样可进行三层转发。

- 子接口不同于物理接口，可以终结携带VLAN Tag的数据帧。

- 基于一个物理接口创建多个子接口，将该物理接口对接到交换机的Trunk接口，即可实现使用一个物理接口为多个VLAN提供三层转发服务。

**子接口终结VLAN的实质包含两个方面：**

- 对接口接收到报文，剥除VLAN标签后进行三层转发或其他处理。

- 对接口发出的报文，又将相应的VLAN标签添加到报文中后再发送。

### 使用VLANIF接口

- 二层交换机（Layer 2 Switch）指的是只具备二层交换功能的交换机。

- 三层交换机（Layer 3 Switch）除了具备二层交换机的功能，还支持通过三层接口（如VLANIF接口）实现路由转发功能。

- VLANIF接口是一种三层的逻辑接口，支持VLAN Tag的剥离和添加，因此可以通过VLANIF接口实现VLAN之间的通信。

- VLANIF接口编号与所对应的VLAN ID相同，如VLAN 10对应VLANIF 10。

### 二、三层接口对比

|                二层接口（Layer2  Interface）                 |                三层接口（Layer3  Interface）                 |
| :----------------------------------------------------------: | :----------------------------------------------------------: |
|                    二层接口不能配置IP地址                    |                    三层接口可以配置IP地址                    |
|                    二层接口不具备MAC地址                     |                     三层接口具备MAC地址                      |
| 当二层接口收到数据帧时，设备在其MAC地址表中查询该帧的目的MAC地址，找到匹配的MAC地址表项后按照该表项的指示转发帧；如果没有找到匹配的MAC地址表项，则将帧进行泛洪。 | 三层接口收到数据帧后，如果数据帧的目的MAC地址与设备的本地MAC地址相同，则将数据帧解除封装，然后在路由表中查询数据包的目的IP地址，找到匹配的路由表项后按照该表项的指示转发包；如果没有找到匹配的表项，则将包丢弃。 |
| 典型的二层接口如二层交换机（只具备二层交换能力的交换机）的物理接口；大部分三层交换机（同时具备二层及三层交换能力的交换机）的物理接口缺省为二层接口。 | 典型的三层接口如路由器的三层接口。  某些三层交换机的物理接口可以切换成三层模式。  此外除了物理三层接口，还存在逻辑三层接口，例如交换机的VLANIF，或者网络设备上的逻辑子接口，如GE0/0/1.10。 |
| 二层接口并不隔离广播域，当二层接口收到广播帧时，会将数据帧进行泛洪。 | 三层接口隔离广播域，当三层接口收到广播帧时，缺省不会进行泛洪，而是直接终结。 |

### VLAN间通信配置命令

```
# 路由器子接口
[R1]interface GigabitEthernet0/0/1.10
[R1-GigabitEthernet0/0/1.10]dot1q termination vid 10
[R1-GigabitEthernet0/0/1.10]ip address 192.168.10.254 24
[R1-GigabitEthernet0/0/1.10]arp broadcast enable

[R1]interface GigabitEthernet0/0/1.20
[R1-GigabitEthernet0/0/1.20]dot1q termination vid 20
[R1-GigabitEthernet0/0/1.20]ip address 192.168.20.254 24
[R1-GigabitEthernet0/0/1.20]arp broadcast enable

# vlanif接口
[SW1]vlan batch 10 20
[SW1] interface GigabitEthernet 0/0/1
[SW1-GigabitEthernet0/0/1] port link-type access
[SW1-GigabitEthernet0/0/1] port default vlan 10
[SW1] interface GigabitEthernet 0/0/2
[SW1-GigabitEthernet0/0/2] port link-type access
[SW1-GigabitEthernet0/0/2] port default vlan 20

[SW1]interface Vlanif 10
[SW1-Vlanif10]ip address 192.168.10.254 24
[SW1]interface Vlanif 20
[SW1-Vlanif20]ip address 192.168.20.254 24

```

**路由器子接口**

- 一般情况下，为了方便记忆，子接口ID与所要终结的VLAN ID相同。

- **dot1q termination** **vid**命令用来配置子接口Dot1q终结的单层VLAN ID。
  - 缺省情况，子接口没有配置dot1q终结的单层VLAN ID。

- **arp** **broadcast enable**命令用来使能终结子接口的ARP广播功能。
  - 缺省情况下，终结子接口没有使能ARP广播功能。
  - 终结子接口不能转发广播报文，在收到广播报文后它们直接把该报文丢弃。
  - 为了允许终结子接口能转发广播报文，可以通过在子接口上执行此命令。

**vlanif接口**

- VLANIF接口的IP地址作为主机的网关IP地址，和主机的IP地址必须位于同一网段。

## 以太网链路聚合与交换机堆叠、集群

### 以太网链路聚合

以太网链路聚合Eth-Trunk：简称链路聚合，通过将多个物理接口捆绑成为一个逻辑接口，可以在不进行硬件升级的条件下，达到增加链路带宽的目的。

#### 链路聚合基本术语、概念

- 聚合组（Link Aggregation Group，LAG）：
  - 若干条链路捆绑在一起所形成的的逻辑链路。
  - 每个聚合组唯一对应着一个逻辑接口，这个逻辑接口又被称为链路聚合接口或Eth-Trunk接口。

- 成员接口和成员链路：
  - 组成Eth-Trunk接口的各个物理接口称为成员接口。
  - 成员接口对应的链路称为成员链路。

- 活动接口和活动链路：
  - 活动接口又叫选中（Selected）接口，是参与数据转发的成员接口。
  - 活动接口对应的链路被称为活动链路（Active link）

- 非活动接口和非活动链路：
  - 又叫非选中（Unselected）接口，是不参与转发数据的成员接口。
  - 非活动接口对应的链路被称为非活动链路（Inactive link）。

- 聚合模式 ：
  - 根据是否开启LACP（Link Aggregation Control Protocol，链路聚合控制协议），链路聚合可以分为手工模式和LACP模式。

- 其他概念：
  - 活动接口上限阈值和活动接口下限阈值。

链路聚合接口可以作为普通的以太网接口来使用，与普通以太网接口的差别在于：转发的时候链路聚合组需要从成员接口中选择一个或多个接口来进行数据转发。

**一个聚合组内要求成员接口以下参数相同：**

- 接口速率

- 双工模式

- VLAN配置：接口类型都是Trunk或者Access，如果为Access接口的default VLAN需要一致，如果为Trunk接口，接口放通的VLAN、缺省VLAN需要一致。

#### 手工模式

- 手工模式： Eth-Trunk的建立、成员接口的加入均由手动配置，双方系统之间不使用LACP进行协商。

- 正常情况下所有链路都是活动链路，该模式下所有活动链路都参与数据的转发，平均分担流量，如果某条活动链路故障，链路聚合组自动在剩余的活动链路中平均分担流量。

- 当聚合的两端设备中存在一个不支持LACP协议时，可以使用手工模式。

**手工模式缺陷**

- 为了使链路聚合接口正常工作，必须保证本端链路聚合接口中所有成员接口的对端接口：
  - 属于同一设备
  - 加入同一链路聚合接口

- 手工模式下，设备间没有报文交互，因此只能通过管理员人工确认。
- 手动模式下，设备只能通过物理层状态判断对端接口是否正常工作。

#### LACP

- LACP模式：采用LACP协议的一种链路聚合模式。
  - 设备间通过链路聚合控制协议数据单元（Link Aggregation Control Protocol Data Unit，LACPDU）进行交互，通过协议协商确保对端是同一台设备、同一个聚合接口的成员接口。

- LACPDU报文中包含设备优先级、MAC地址、接口优先级、接口号等。

**确定主动端：**

- 通过系统LACP优先级确定主动端，值越小优先级越高。
- 系统LACP优先级默认32768，越小越优，通常保持默认。
- 当优先级一致时LACP会通过比较MAC地址选择主动端，MAC地址越小越优。

**选择活动接口：**

- 以主动端的接口优先级来选择活动接口，优先级高的接口将优先被选为活动接口。
- 接口LACP优先级值越小，优先级越高。
- 接口LACP优先级默认为32768，越小越优，通常保持默认。
- 当优先级一致时LACP会通过接口编号选择活动接口，越小越优。

**最大活动接口数**

- LACP模式支持配置最大活动接口数目
- 当成员接口数目超过最大活动接口数目时会通过比较接口优先级、接口号选举出较优的接口成为活动接口
- 其余的则成为备份端口（非活动接口），同时对应的链路分别成为活动链路、非活动链路。
- 交换机只会从活动接口中发送、接收报文。

- 当活动链路中出现链路故障时，可以从非活动链路中找出一条优先级最高（接口优先级、接口编号比较）的链路替换故障链路，实现总体带宽不发生变化、业务的不间断转发。

**LACP通过LACPDU中的三个flags来标识该端口的状态，如果是活跃端口如下三个flags的值将会是1：**

- pSynchronization

- pCollecting

- pDistributing

**如果是非活跃端口，该三个flags字段的值将为0。**

#### 负载分担

- Eth-trunk支持基于报文的IP地址或MAC地址来进行负载分担，可以配置不同的模式（本地有效，对出方向报文生效）将数据流分担到不同的成员接口上。

- 常见的模式有：源IP、源MAC、目的IP、目的MAC、源目IP、源目MAC。
  - 如果报文的IP地址变化较频繁，那么选择基于源IP、目的IP或者源目IP的负载分担模式更有利于流量在各物理链路间合理的负载分担；
  - 如果报文的MAC地址变化较频繁，IP地址比较固定，那么选择基于源MAC、目的MAC或源目MAC的负载分担模式更有利于流量在各物理链路间合理的负载分担。

#### 链路聚合配置命令

```
#手工模式
interface eth-trunk <trunk-id> 创建链路聚合组
mode {lacp|manual load-balance} 配置链路聚合模式（默认手工模式），两端要一致（eth-trunk视图）
trunkport <interface-type> <interface num> 接口加入到聚合组（eth-trunk视图）
eth-trunk <trunk-id> 接口加入链路聚合组中（接口视图）

mixed-rate link enable 使能允许不同速率端口加入同一Eth-Trunk接口的功能，缺省未使能
lacp priority <priority> 配置系统优先级，缺省32768
lacp priority <priority> 配置接口优先级，缺省32768（接口视图）

max active-linknumber <num> 配置最大活动接口数，两端要一致，仅lacp支持（eth-trunk视图）
least active-linknumber <num> 配置最小活动接口数（eth-trunk视图）
```

- 本端和对端设备的活动接口数下限阈值可以不同，手动模式、LACP模式都支持配置最小活动接口数。

- 配置最小活动接口数目的是为了保证最小带宽，当前活动链路数目小于下限阈值时，Eth-Trunk接口的状态转为Down。

- 当带宽过小时一些对链路带宽有要求的业务将会出现异常，此时切断Eth-Trunk通过网络自身的高可靠性将业务切换到其他路径，从而保证业务的正常运行。

### 堆叠和集群

- 堆叠（iStack）：多台支持堆叠特性的交换机通过堆叠线缆连接在一起，从逻辑上变成一台交换设备，作为一个整体参与数据转发。

- 集群（Cluster Switch System，CSS ）：将两台支持集群特性的交换机设备组合在一起，从逻辑上组合成一台交换设备。

**集群只支持两台设备，一般框式交换机支持CSS，盒式设备支持iStack。**

- 交换机多合一：堆叠交换机对外表现为一台逻辑交换机，控制平面合一，统一管理。

- 转发平面合一：堆叠内物理设备转发平面合一，转发信息共享并实时同步。

- 跨设备链路聚合：跨物理设备的链路被聚合成一个Eth-Trunk端口，和下游设备实现互联。
- 逻辑上一台设备，简化运维，方便管理。
- 一台物理设备故障，其他设备可以接管转发、控制平台，避免了单点故障。
- 跨设备的链路聚合，物理上的无环网络，无需再部署STP。
- 链路聚合中的链路全部有效使用，链路利用率100%。

# 网络层

## 网络层协议

### IVP4报文格式

- Version：4 bit，4：表示为IPv4；6：表示为IPv6。
- Header Length：4 bit，首部长度，如果不带Option字段，则为20，最长为60。

- Type of Service：8 bit，服务类型。只有在有QoS差分服务要求时，这个字段才起作用。

- Total Length：16 bit，总长度，整个IP数据包的长度。

- Identification：16 bit，标识，分片重组时会用到该字段。

- Flags：3 bit，标志位。

- Fragment Offset：12 bit，片偏移，分片重组时会用到该字段。

- Time to Live：8 bit，生存时间。

- Protocol：8 bit，协议：下一层协议。
  - 1: ICMP, Internet Control Message；
  - 2: IGMP, Internet Group Management；
  - 6: TCP , Transmission Control Protocol；
  - 17: UDP, User Datagram Protocol。

- Header Checksum：16 bit，首部检验和。

- Source IP Address：32 bit，源IP地址。 

- Destination IP Address：32 bit，目的IP地址。 

- Options：可变，选项字段。

- Padding：可变，填充字段，全填0。 

#### 数据包分片

- Identification：16 bit，发送主机赋予的标识，分片重组时会用到该字段。

- Flags：3 bit，标志位。
  - 保留段位：0，保留。
  - 不分段位：1，表示“不能分片”；0，表示“能分片”。
  - 更多段位：1，表示“后面还有分片”；0，表示“最后一个数据片”。

- Fragment Offset：12 bit，片偏移，分片重组时会用到该字段。指出较长的分组在分片后，该片在原分组中的相对位置，与更多段位组合，帮助接收方组合分段的报文。

#### TTL

8bit，每经过一台三层设备，TTL值减1，TTL为0时，数据包将被丢弃，同时根据源IP发送ICMP错误信息（可配置为不发送）

#### 协议号

**Protocol**

- 0x01: ICMP
- 0x02: IGMP
- 0x06: TCP 
- 0x17: UDP

### IPV4地址

**IP地址是网络设备接口的属性，不是网络设备本身的属性**

#### IPV4地址构成

- 网络部分
- 主机部分
- 网络掩码

#### IP地址寻址

- 网络寻址
  - 二层网络寻址：可直接通过IP地址，找到对应的主机接口。
  - 三层网络寻址：利用网关转发来自不同网段之间的数据包。

- 网关
  - 报文转发过程中，首先需要确定转发路径以及通往目的网段的接口。如果目的主机与源主机不在同一网段，报文需要先转发到网关，然后通过网关将报文转发到目的网段。
  - 网关是指接收并处理本地网段主机发送的报文并转发到目的网段的设备。为实现此功能，网关必须知道目的网段的IP地址。网关设备上连接本地网段的接口地址即为该网段的网关地址。

#### IP地址分类

- A、B、C三类地址是单播IP地址 (除一些特殊地址外)，只有这三类地址才能分配给主机接口使用。

- A类网络的网络号为8 bit；首位恒定为0，地址空间为：0.0.0.0~127.255.255.255。

- B类网络的网络号为16 bit；首两位恒定为10，地址空间为：128.0.0.0~191.255.255.255。

- C类网络的网络号为24 bit；首三位恒定为110，地址空间为：192.0.0.0~223.255.255.255。
- D类地址属于组播IP地址；首四位恒定为1110，地址空间为：224.0.0.0~239.255.255.255。

- E类地址专门用于特殊的实验目的；首四位恒定为1111，地址空间为：240.0.0.0~255.255.255.255。

**主机 (Host)，通常指路由器和计算机的统称。并且常把主机的某个接口的IP地址简称为主机IP地址。**

**组播地址：组播能实现一对多传递消息。**

#### IP地址类型

- 网络地址
  - 网络号为X，主机号的每个比特都为0。
  - 不能分配给具体的主机接口使用。

- 广播地址
  - 网络号为X，主机号的每个比特都为1。
  - 不能分配给具体的主机接口使用。

- 可用地址
  - 又称主机地址，可用分配给具体的主机接口使用。

#### 私网IP地址

**IANA (Internet Assigned Numbers Authority)，因特网地址分配组织**

- A类：10.0.0.0~10.255.255.255

- B类：172.16.0.0~172.31.255.255

- C类：192.168.0.0~192.168.255.255

#### 特殊IP地址

|    特殊IP地址    |  **地址范围**   |                           **作用**                           |
| :--------------: | :-------------: | :----------------------------------------------------------: |
| **有限广播地址** | 255.255.255.255 |      可作为目的地址，发往该网段所有主机  （受限于网关）      |
|   **任意地址**   |     0.0.0.0     |   “任何网络”的网络地址；  “这个网络上这个主机接口”的IP地址   |
|   **环回地址**   |   127.0.0.0/8   |                    测试设备自身的软件系统                    |
| **本地链路地址** | 169.254.0.0/24  | 当主机自动获取地址失败后，可使用该网段中的某个地址进行临时通信 |

- 255.255.255
  - 这个地址称为有限广播地址，它可以作为一个IP报文的目的IP地址使用。
  - 路由器接收到目的IP地址为有限广播地址的IP报文后，会停止对该IP报文的转发。

- 0.0.0.0
  - 如果把这个地址作为网络地址，它的意思就是“任何网络”的网络地址；
  - 如果把这个地址作为主机接口地址，它的意思就是“这个网络上主机接口”的IP地址。
  - 例如：当一个主机接口在启动过程中尚未获得自己的IP地址时，就可以向网络发送目的IP地址为有限广播地址、源IP地址为0.0.0.0的DHCP请求报文，希望DHCP服务器在收到自己的请求后，能够给自己分配一个可用的IP地址。

- 127.0.0.0/8
  - 这个地址为环回地址，它可以作为一个IP报文的目的IP地址使用。其作用是测试设备自身的软件系统。
  - 一个设备产生的、目的IP地址为环回地址的IP报文是不可能离开这个设备本身的。

- 169.254.0.0/16
  - 如果一个网络设备获取IP地址的方式被设置成了自动获取方式，但是该设备在网络上又没有找到可用的DHCP服务器，那么该设备就会使用169.254.0.0/16网段的某个地址来进行临时通信。

#### 子网划分

VLSM (Variable Length Subnet Mask)，可变长子网掩码

#### ICMP协议

- Internet控制消息协议ICMP (Internet Control Message Protocol)是IP协议的辅助协议

- ICMP协议用来在网络设备间传递各种差错和控制信息，对于收集各种网络信息、诊断和排除各种网络故障等方面起着至关重要的作用。

##### ICMP消息

- **ICMP消息封装在IP报文中，IP报文头部Protocol值为1时表示ICMP协议。**

**字段解释：**

- ICMP消息的格式取决于Type和Code字段，其中Type字段为消息类型，Code字段包含该消息类型的具体参数。

- 校验和字段用于检查消息是否完整。

- 消息中包含32 bit的可变参数，这个字段一般不使用，通常设置为0。
  - 在ICMP重定向消息中，这个字段用来指定网关IP地址，主机根据这个地址将报文重定向到指定网关。
  - 在Echo请求消息中，这个字段包含标识符和序号，源端根据这两个参数将收到的回复消息与本端发送的Echo请求消息进行关联。尤其是当源端向目的端发送了多个Echo请求消息时，需要根据标识符和序号将Echo请求和回复消息进行一一对应。

##### ICMP重定向

- 主机A希望发送报文到服务器A，于是根据配置的默认网关地址向网关RTB发送报文。

- 网关RTB收到报文后，检查报文信息，发现报文应该转发到与源主机在同一网段的另一个网关设备RTA，此转发路径是更优的路径，所以RTB会向主机发送一个Redirect消息，通知主机直接向另一个网关RTA发送该报文。

- 主机收到Redirect消息后，会向RTA发送报文，然后RTA会将该报文再转发给服务器A。

##### ICMP差错检测

- ICMP Echo消息常用于诊断源和目的地之间的网络连通性，同时还可以提供其他信息，如报文往返时间等

- ICMP的一个典型应用是Ping。Ping是检测网络连通性的常用工具，同时也能够收集其他相关信息。用户可以在Ping命令中指定不同参数，如ICMP报文长度、发送的ICMP报文个数、等待回复响应的超时时间等，设备根据配置的参数来构造并发送ICMP报文，进行Ping测试。

##### ICMP错误报告

- ICMP定义了各种错误消息，用于诊断网络连接性问题；根据这些错误消息，源设备可以判断出数据传输失败的原因。

- 如果网络中发生了环路，导致报文在网络中循环，且最终TTL超时，这种情况下网络设备会发送TTL超时消息给发送端设备。

- 如果目的地不可达，则中间的网络设备会发送目的不可达消息给发送端设备。目的不可达的情况有多种，如果是网络设备无法找到目的网络，则发送目的网络不可达消息；如果网络设备无法找到目的网络中的目的主机，则发送目的主机不可达消息。

- ICMP的另一个典型应用是Tracert。Tracert基于报文头中的TTL值来逐跳跟踪报文的转发路径。为了跟踪到达某特定目的地址的路径，源端首先将报文的TTL值设置为1。该报文到达第一个节点后，TTL超时，于是该节点向源端发送TTL超时消息，消息中携带时间戳。然后源端将报文的TTL值设置为2，报文到达第二个节点后超时，该节点同样返回TTL超时消息，以此类推，直到报文到达目的地。这样，源端根据返回的报文中的信息可以跟踪到报文经过的每一个节点，并根据时间戳信息计算往返时间。

##### IP地址配置命令

```
[Huawei] interface <interface-type> <interface-number> 进入指定的接口视图
[Huawei-GigabitEthernet0/0/1] ip address <ip-address> { <mask> | <mask-length> } 配置IP地址
```

- 物理接口：物理接口是指网络设备上实际存在的接口，分为负责承担业务传输的业务接口和负责管理设备的管理接口，例如GE业务接口和MEth管理接口。

- 逻辑接口：逻辑接口是指能够实现数据交换功能但物理上不存在、需要通过配置建立的接口，需要承担业务传输，例如VLANIF接口、Loopback接口。
  - Loopback接口：用户需要一个接口状态永远是Up的接口的IP地址时，可以选择Loopback接口的IP地址。
  - Loopback接口一旦被创建，其物理状态和链路协议状态永远是Up，即使该接口上没有配置IP地址。
  - Loopback接口配置IP地址后，就可以对外发布。Loopback接口上可以配置32位掩码的IP地址，达到节省地址空间的目的。
  - Loopback接口不能封装任何链路层协议，数据链路层也就不存在协商问题，其协议状态永远都是Up。
  - 对于目的地址不是本地IP地址，出接口是本地Loopback接口的报文，设备会将其直接丢弃。

##### IP地址规划

- IP地址规划要和网络结构、路由协议、流量规划、业务规则等结合起来考虑
- IP地址的规划应尽可能和网络层次相对应，应该是自顶向下的一种规划。
- IP地址规划的目标是：易管理、易扩展、利用率高

**规划原则**

- 唯一性：一个IP网络中不能有两个主机采用相同的IP地址。

- 连续性：连续地址在层次结构网络中易于进行路由汇总，大大缩减路由表，提高路由计算的效率、加速路由收敛。

- 扩展性：地址分配在每一层次上都要有合理的预留，在网络规模扩展时能保证路由汇总所需的连续性。避免网络扩展造成的地址、路由重新规划。

- 结构化、业务相关性：地址规划与网络拓扑结构和网络承载业务结合起来，便于路由规划和QoS部署。好的IP地址规划使得每个地址都具有实际含义，看到一个地址就可以大致判断出该地址所属的设备和对应的业务。

## IP路由基础

### 路由概述

#### 路由基本概念

为了实现不同网段之间的相互通信，网络设备需要能够转发来自不同网段的IP报文，将其送达不同的IP网段。

- 路由是指导报文转发的路径信息，通过路由可以确认转发IP报文的路径。

- 路由设备是依据路由转发报文到目的网段的网络设备，最常见的路由设备：路由器。

- 路由设备维护着一张路由表，保存着路由信息。

#### 路由条目生成

##### 路由信息

路由中包含以下信息

- 目的网络：标识目的网段

- 掩码：与目的地址共同标识一个网段

- 出接口：数据包被路由后离开本路由器的接口

- 下一跳：路由器转发到达目的网段的数据包所使用的下一跳地址

##### 路由表

- 路由器通过各种方式发现路由

- 路由器选择最优的路由条目放入路由表中

- 路由表指导设备对IP报文的转发

- 路由器通过对路由表的管理实现对路径信息的管理

**路由表由路由条目组成，但不代表路由表中保存了所有路由，路由表中只会保存“最优的”路由**

##### 路由信息获取方式

- 直连路由：直连接口所在网段的路由，由设备自动生成。

- 静态路由：由网络管理员手工配置的路由条目

- 动态路由：路由器通过动态路由协议（如OSPF、IS-IS、BGP等）学习到的路由

##### 直连路由

- 直连路由指向本地直连网络的路由，由设备自动生成。

- 当路由器为路由转发的最后一跳路由器时，IP报文匹配直连路由，路由器转发IP报文到目的主机。

- 使用直连路由进行路由转发时，报文的目的IP和路由器接口IP在一个网段之中。
- 当匹配中直连路由进行转发时，此时路由器会查看ARP表项，将报文直接转到目的地址，此时该路由器为路由转发的最后一跳路由器。
- 直连路由的下一跳地址并不是其他设备上的接口地址，因为该路由的目的网段为接口所在网段，本接口就是最后一跳，不需要再转发给下一跳，所以在路由表中的下一跳地址就是接口自身地址。
- 使用直连路由进行路由转发时，转发的动作不是交给下一跳，而是查询ARP表项，根据ARP表项封装报文，将报文发送到目的IP。
- 并不是所有接口生成的直连路由都会出现在路由表中，直连路由出现在路由表中的前提是该接口的物理状态、协议状态都为UP。

#### 最优路由条目优选

**路由表**

- Destination/Mask：表示此路由的目的网络地址与网络掩码。

- Proto（Protocol）：该路由的协议类型，也即路由器是通过什么协议获知该路由的。

- Pre（Preference）：表示此路由的路由协议优先级。

- Cost：路由开销。

- NextHop：表示对于本路由器而言，到达该路由指向的目的网络的下一跳地址。

- Interface：表示此路由的出接口。

**Preference用于不同路由协议间路由优先级的比较，Cost用于同一种路由协议内部不同路由的优先级的比较。**

在业界，Cost也被称为路由度量值（Metric）。

**优选Preference值小，Cost值小的路由条目加入路由表**

|   路由类型   | 优先级 |
| :----------: | :----: |
|   直连路由   |   0    |
|   静态路由   |   60   |
| OSPF内部路由 |   10   |
| OSPF外部路由 |  150   |

#### 路由转发

- 最长匹配原则

### 静态路由

#### 静态路由配置

```
#关联下一跳IP的方式
[Huawei] ip route-static <ip-address> { <mask> | <mask-length> } <nexthop-address>
#关联出接口的方式
[Huawei] ip route-static <ip-address> { <mask> | <mask-length> } <interface-type> <interface-number>
#关联出接口和下一跳IP方式
[Huawei] ip route-static <ip-address> { <mask> | <mask-length> } <interface-type> <interface-number> [ <nexthop-address> ]
```

在创建静态路由时，可以同时指定出接口和下一跳。对于不同的出接口类型，也可以只指定出接口或只指定下一跳。

- 对于点到点接口（如串口），必须指定出接口。

- 对于广播接口（如以太网接口）和VT（Virtual-template）接口，必须指定下一跳。

#### 缺省路由

缺省路由在路由表中的形式为0.0.0.0/0，缺省路由也被叫做默认路由

缺省路由一般用于企业网络出口，配置一条缺省路由让出口设备能够转发前往Internet上任意地址的IP报文。

#### 动态路由

##### 动态路由分类

- 按工作区域分类
  - IGP（Interior Gateway Protocols，内部网关协议）
    - RIP、OSPF、IS-IS
  - EGP（Exterior Gateway Protocols，外部网关协议）
    - BGP
- 按工作机制和算法分类
  - 距离矢量路由协议（Distance Vector Routing Protocols）
    - RIP
  - 链路状态路由协议（Link-State Routing Protocols）
    - OSPF、IS-IS

#### 路由高级特性

- 路由递归
  - 30.1.2.0 24 20.1.1.3
  - 20.1.1.0 24 10.0.0.2
- 等价路由：来源相同、开销相同的路由（目的网段相同，下一跳不同，负载分担）
  - 10.0.0.30 20.1.1.2
  - 10.0.0.30 30.1.1.2
- 浮动路由：备份路由，可以通过配置目的地址/掩码相同、优先级不同、下一跳不同的静态路由，实现转发路径的备份
  - [RTA] **ip** **route-static 20.0.0.0 30 10.1.1.2**
  - [RTA] **ip** **route-static 20.0.0.0 30 10.1.2.2 preference 70**
- CIDR（classless inter-domain routing）无类别域间路由
  - CIDR容许任意长度的掩码长度，可以有效减少路由表条目数量
  - 路由汇总（Route Summarization）又称路由聚合（Route Aggregation）
  - 路由汇总采用了CIDR的思想：将相同前缀的地址聚合成一个。
  - 可能带来环路问题
  - 增加一条指向Null0的路由，即可解决环路问题
    - [RTB] **ip** **route-static** **10.1.0.0 16 0 NULL0**

Null（无效）接口：这种类型的接口只有一个编号，也就是0。Null0是一个系统保留的逻辑接口，当网络设备在转发某些数据包时，如果使用出接口为Null0的路由，那么这些报文将被直接丢弃，就像被扔进了一个黑洞里，因此出接口为Null0的路由又被称为黑洞路由。

## OSPF基础

OSPF（Open Shortest Path First，开放式最短路径优先）

#### OSPF概述

##### 距离矢量路由协议

- 运行距离矢量路由协议的路由器周期性的泛洪自己的路由表。通过路由的交互，每台路由器都从相邻的路由器学习到路由，并且加载进自己的路由表中。

- 对于网络中的所有路由器而言，路由器并不清楚网络的拓扑，只是简单的知道要去往某个目的方向在哪里，距离有多远。这即是距离矢量算法的本质。

##### 链路状态路由协议 

**LAS泛洪**

- 链路状态路由协议通告的的是链路状态而不是路由表。
- 运行链路状态路由协议的路由器之间首先会建立一个协议的邻居关系，然后彼此之间开始交互LSA（Link State Advertisement，链路状态通告）。
- 链路状态通告，可以简单的理解为每台路由器都产生一个描述自己直连接口状态（包括接口的开销、与邻居路由器之间的关系等）的通告。

**LSDB组建**

- 每台路由器都会产生LSAs，路由器将接收到的LSAs放入自己的LSDB（Link State DataBase，链路状态数据库）。
- 路由器通过LSDB，掌握了全网的拓扑。

**SPF计算**

- 每台路由器基于LSDB，使用SPF（Shortest Path First，最短路径优先）算法进行计算。
- 每台路由器都计算出一棵以自己为根的、无环的、拥有最短路径的“树”。

**路由表生成**

- 路由器将计算出来的优选路径，加载进自己的路由表（Routing Table）

**链路状态路由协议有四个步骤**

- 第一步是建立相邻路由器之间的邻居关系。

- 第二步是邻居之间交互链路状态信息和同步LSDB。

- 第三步是进行优选路径计算。

- 第四步是根据最短路径树生成路由表项加载到路由表。

##### OSPF简介

- OSPF是典型的链路状态路由协议，是目前业内使用非常广泛的IGP协议之一。

- 目前针对IPv4协议使用的是OSPF Version 2（RFC2328）；针对IPv6协议使用OSPF Version 3（RFC2740）。

- 运行OSPF路由器之间交互的是LS（Link State，链路状态）信息，而不是直接交互路由。

- OSPF路由器将网络中的LS信息收集起来，存储在LSDB中。路由器都清楚区域内的网络拓扑结构，这有助于路由器计算无环路径。

- 每台OSPF路由器都采用SPF算法计算达到目的地的最短路径。路由器依据这些路径形成路由加载到路由表中。

- OSPF支持VLSM（Variable Length Subnet Mask，可变长子网掩码），支持手工路由汇总。

- 多区域的设计使得OSPF能够支持更大规模的网络。

##### OSPF基本术语

- 区域

  - OSPF Area用于标识一个OSPF的区域。
  - 区域是从逻辑上将设备划分为不同的组，每个组用区域号（Area ID）来标识。

- Router ID

  - Router-ID（Router Identifier，路由器标识符），用于在一个OSPF域中唯一地标识一台路由器
  - Router-ID的设定可以通过手工配置的方式，或使用系统自动配置的方式

  - 在实际项目中，通常会通过手工配置方式为设备指定OSPF Router-ID。请注意必须保证在OSPF域中任意两台设备的Router-ID都不相同。通常的做法是将Router-ID配置为与该设备某个接口（通常为Loopback接口）的IP地址一致。

- 度量值

  - OSPF使用Cost（开销）作为路由的度量值。每一个激活了OSPF的接口都会维护一个接口Cost值。
  - 缺省时接口Cost值="100 Mbit/s " /"接口带宽" 。其中100 "Mbit/s"为OSPF指定的缺省参考值，该值是可配置的。

##### OSPF协议报文类型

- Hello：周期性发送，用来发现和维护OSPF邻居关系。 
- DD（Database Description）：  描述本地LSDB的摘要信息，用于两台设备进行数据库同步。  
- LSR（Link States Request）：向对方请求所需的LSA，邻居双方成功交换DD报文后才会发出LSR
- LSU（Link State Update）：向对方发送其所需的LSA
- LS ACK（Link State ACK）：对收到的LSA进行确认

##### OSPF三大表项

- OSPF邻居表

  - 使用display ospf peer查看。

- LSDB表
  
  - ▫使用display ospf lsdb查看。
  
  - Type标识LSA的类型，AdvRouter标识发送LSA的路由器。
  
- OSPF路由表

  - 使用display ospf routing查看。
  - OSPF路由表和路由器路由表是两张不同的表项。
  - OSPF路由表包含Destination、Cost和NextHop等指导转发的信息。

#### OSPF工作原理

- 邻居关系：通过Hello报文发现彼此后，这两台路由器便形成了邻居关系。
- 邻接关系：当两台路由器LSDB同步完成，并开始独立计算路由时，这两台路由器形成了邻接关系。

##### OSPF邻接关系建立过程

- 建立双向邻居关系
  - A hello B，B（Init）
  - B hello A，A（2-way）
  - A hello B， B（2-way）
  - 当一台OSPF路由器收到其他路由器发来的首个Hello报文时会从初始Down状态切换为Init状态。
  - 当OSPF路由器收到的Hello报文中的邻居字段包含自己的Router ID时，从Init切换2-way状态。
- 协商主从
  - A DD B，A（Exchange Start）B（Exchange Start）
  - B DD A，A（Exchange）
  - 邻居状态机从2-way转为Exstart状态后开始主从关系选举：
  - R1向R2发送的第一个DD报文内容为空，其Seq序列号假设为X。
  - R2也向R1发出第一个DD报文，其Seq序列号假设为Y。
  - **选举主从关系的规则是比较Router ID，越大越优。**
  - R2的Router ID比R1大，因此R2成为真正的主设备。
  - 主从关系比较结束后，R1的状态从Exstart转变为Exchange。
- 相互描述LSDB摘要，交互LSDB信息
  - A DD B ，B（Exchange）
  - B DD A
  - A DD B
  - R1邻居状态变为Exchange后，R1发送一个新的DD报文，包含自己LSDB的描述信息，其序列号采用主设备R2的序列号。
  - R2收到后邻居状态从Exstart转变为Exchange。
  - R2向R1发送一个新的DD报文，包含自己LSDB的描述信息，序列号为Y+1。
  - R1作为从路由器需要对主路由R2发送的每个DD报文进行确认，回复报文的序列号与主路由R2一致。
  - 发送完最后一个DD报文后，R1将邻居状态切换为Loading。
- 更新LSA，同步LSDB
  - A LSR B，A（Loading）B（Loading）
  - B LSU A
  - A LA ACK B
  - 。。。。。。
  - A（Full）B（Full）
  - 邻居状态转变为Loading后，R1向R2发送LSR报文，请求那些在Exchange状态下通过DD报文发现的，但是在本地LSDB中没有的LSA。
  - R2收到后向R1回复LSU。在LSU报文中包含被请求的LSA的详细信息。
  - R1收到LSU报文后，向R2回复LS ACK报文，确认已接收到，确保信息传输的可靠性。
  - 此过程中R2也会向R1发送LSA请求。
  - 当两端LSDB完全一致时，邻居状态变为Full，表示成功建立邻接关系。
- 计算路由

##### OSPF网络类型

**OSPF有四种网络类型，Broadcast、NBMA、P2MP和P2P**

- MA（Multi-Access）多路访问网络
  - BMA（Broadcast Multiple Access）广播式多路访问，如以太网（Ethernet）
    - BMA指的是一个允许多台设备接入的、支持广播的环境，如Ethernet（以太网）
  - 当接口采用Ethernet封装时，OSPF在该接口上采用的缺省网络类型为BMA
  - NBMA（Non-Broadcast Multiple Access）非广播式多路访问
    - NBMA指的是一个允许多台网络设备接入且不支持广播的环境，如帧中继（Frame-Relay）
- P2MP（点到多点）
  - P2MP相当于将多条P2P链路的一端进行捆绑得到的网络。
  - 没有一种链路层协议会被缺省的认为是P2MP网络类型。
  - 常用做法是将非全连通的NBMA改为点到多点的网络。
- P2P（点对点）
  - P2P指的是在一段链路上只能连接两台网络设备的环境，如PPP
  - 当接口采用PPP封装时，OSPF在该接口上采用的缺省网络类型为P2P 

##### DR、BDR

为优化MA网络中OSPF邻接关系，OSPF指定了三种OSPF路由器身份

- DR（Designated Router，指定路由器）
- BDR（Backup Designated Router，备用指定路由器）
- DRother路由器。

只允许DR、BDR与其他OSPF路由器建立邻接关系。

DRother之间不会建立全毗邻的OSPF邻接关系，双方停滞在2-way状态。

BDR会监控DR的状态，并在当前DR发生故障时接替其角色。

**选举规则：OSPF DR优先级高，OSPF Router-ID高，DR具有非抢占性**

##### OSPF域、单区域、多区域

- OSPF域（Domain）：一系列使用相同策略的连续OSPF网络设备所构成的网络。

- OSPF引入区域（Area）的概念，将一个OSPF域划分成多个区域，可以使OSPF支撑更大规模组网。

- 区域的分类：区域可以分为骨干区域与非骨干区域。
- 骨干区域即Area0，除Area0以外其他区域都称为非骨干区域。

- 多区域互联原则：基于防止区域间环路的考虑，非骨干区域与非骨干区域不能直接相连，所有非骨干区域必须与骨干区域相连。

##### OSPF路由器类型

- IR（Internal Router）区域内路由器
  - 该类路由器的所有接口都属于同一个OSPF区域。
- BR（Backbone Router）骨干路由器
  - 该类路由器至少有一个接口属于骨干区域。
- ABR（Area Border Router）区域边界路由器，必须是连接骨干区域和非骨干区域
  - 该类路由器的接口同时属于两个以上的区域，但至少有一个接口属于骨干区域。
- ASBR（AS Boundary Router）自治系统边界路由器，连接其它AS
  - 该类路由器与其他AS交换路由信息。只要一台OSPF路由器引入了外部路由的信息，它就成为ASBR。

#### OSPF协议配置命令

```
# OSPF
display ospf peer 查看邻居表
display ospf lsdb 查看LSDB表
display ospf routing 查看OSPF路由表
reset ospf process 重建ospf邻接(用户视图)

ospf [ <process-id> | router-id <router-id> ] 创建并运行ospf进程
area <area-id> 创建并进入ospf区域（ospf视图）0~4294967295
network <network-add> <wildcard-mask> 指定运行OSPF的接口（area视图）

ospf cost <cost> 配置接口开销（接口视图）1~65535
bandwidth-reference <value> 设置带宽参考值（ospf视图）1～2147483648，缺省值100
ospf dr-priority <priority> 设置接口选举DR优先级（0~255），缺省值1（接口视图）
```

- Router ID的选择顺序是：优先从Loopback地址中选择**最大**的IP地址作为设备的ID号

- 如果没有配置Loopback接口，则在接口地址中选取**最大**的IP地址作为设备的ID号。

- `ospf dr-priority`命令用来设置接口在选举DR时的优先级。priority值越大，优先级越高

## ACL

ACL（Access Control List）访问控制列表

### ACL概述

- 通过ACL可以实现对网络中报文流的精确识别和控制，达到控制网络访问行为、防止网络攻击和提高网络带宽利用率的目的，从而切实保障网络环境的安全性和网络服务质量的可靠性。
  - ACL是由permit或deny语句组成的一系列有顺序的规则的集合；它通过匹配报文的相关字段实现对报文的分类。
  - ACL是能够匹配一个IP数据包中的源IP地址、目的IP地址、协议类型、源目的端口等元素的基础性工具；ACL还能够用于匹配路由条目。

### ACL的组成

- ACL编号：在网络设备上配置ACL时，每个ACL都需要分配一个编号，称为ACL编号，用来标识ACL。

- 规则：一个ACL通常由若干条“permit/deny”语句组成，每条语句就是该ACL的一条规则。

- 规则编号：每条规则都有一个相应的编号，称为规则编号，用来标识ACL规则。可以自定义，也可以系统自动分配。ACL规则的编号范围是0～4294967294，所有规则均按照规则编号从小到大进行排序。

- 动作：每条规则中的permit或deny，就是与这条规则相对应的处理动作。permit指“允许”，deny指“拒绝”，但是ACL一般是结合其他技术使用，不同的场景，处理动作的含义也有所不同。

- 匹配项：ACL定义了极其丰富的匹配项。例子中体现的源地址，ACL还支持很多其他规则匹配项。例如，二层以太网帧头信息（如源MAC、目的MAC、以太帧协议类型）、三层报文信息（如目的地址、协议类型）以及四层报文信息（如TCP/UDP端口号）等。

**规则编号**

一个ACL中的每一条规则都有一个相应的编号。

- 步长（Step）
  - 步长是系统自动为ACL规则分配编号时，每个相邻规则编号之间的差值，缺省值为5。
  - 步长的作用是为了方便后续在旧规则之间，插入新的规则。
  - 步长可以调整。

- Rule ID分配规则
  - 系统为ACL中首条未手工指定编号的规则分配编号时，使用步长值（例如步长=5，首条规则编号为5）作为该规则的起始编号
  - 为后续规则分配编号时，则使用大于当前ACL内最大规则编号且是步长整数倍的最小整数作为规则编号。

**通配符 (Wildcard)**

- 通配符是一个32比特长度的数值，用于指示IP地址中，哪些比特位需要严格匹配，哪些比特位无需匹配。

- 通配符通常采用类似网络掩码的点分十进制形式表示，但是含义却与网络掩码完全不同。

- 通配符，也是点分十进制格式，换算成二进制后，“0”表示“匹配”，“1”表示“不关心”。
- 通配符中的1或者0是可以不连续的。
- 还有两个特殊的通配符：
  - 当通配符全为0来匹配IP地址时，表示精确匹配某个IP地址；
  - 当通配符全为1来匹配0.0.0.0地址时，表示匹配了所有IP地址。

### ACL的分类与标识

**基于ACL规则定义方式的分类**

|   分类    | 编号范围 |                       规则定义描述                     |
| :-----------: | :----------: | :----------------------------------------------------------: |
|    基本ACL    |  2000~2999   |  仅使用报文的源IP地址、分片信息和生效时间段信息来定义规则。  |
|    高级ACL    |  3000~3999   | 可使用IPv4报文的源IP地址、目的IP地址、IP协议类型、ICMP类型、TCP源/目的端口号、UDP源/目的端口号、生效时间段等来定义规则。 |
|    二层ACL    |  4000~4999   | 使用报文的以太网帧头信息来定义规则，如根据源MAC地址、目的MAC地址、二层协议类型等。 |
| 用户自定义ACL |  5000~5999   | 使用报文头、偏移位置、字符串掩码和用户自定义字符串来定义规则。 |
|    用户ACL    |  6000~6999   | 既可使用IPv4报文的源IP地址或源UCL（User  Control List）组，也可使用目的IP地址或目的UCL组、IP协议类型、ICMP类型、TCP源端口/目的端口、UDP源端口/目的端口号等来定义规则。 |

**基于ACL标识方法的分类**

|   分类    |                        规则定义描述                         |
| :-------: | :---------------------------------------------------------: |
| 数字型ACL | 传统的ACL标识方法。创建ACL时，指定一个唯一的数字标识该ACL。 |
| 命名型ACL |                 通过名称代替编号来标识ACL。                 |

- 注意：用户在创建ACL时可以为其指定编号，不同的编号对应不同类型的ACL。

- 同时，为了便于记忆和识别，用户还可以创建命名型ACL，即在创建ACL时为其设置名称。
- 命名型ACL，也可以是“名称 数字”的形式，即在定义命名型ACL时，同时指定ACL编号。
- 如果不指定编号，系统则会自动为其分配一个数字型ACL的编号。

### ACL的匹配机制

**ACL的匹配机制概括来说就是：**

- 配置ACL的设备接收报文后，会将该报文与ACL中的规则逐条进行匹配，如果不能匹配上，就会继续尝试去匹配下一条规则。

- 一旦匹配上，则设备会对该报文执行这条规则中定义的处理动作，并且不再继续尝试与后续规则匹配。

**匹配流程：**

- 首先系统会查找设备上是否配置了ACL。
- 如果ACL不存在，则返回ACL匹配结果为：不匹配。
- 如果ACL存在，则查找设备是否配置了ACL规则。

- 如果规则不存在，则返回ACL匹配结果为：不匹配。

- 如果规则存在，则系统会从ACL中编号最小的规则开始查找。

- 如果匹配上了permit规则，则停止查找规则，并返回ACL匹配结果为：匹配（允许）。

- 如果匹配上了deny规则，则停止查找规则，并返回ACL匹配结果为：匹配（拒绝）。

- 如果未匹配上规则，则继续查找下一条规则，以此循环。
- 如果一直查到最后一条规则，报文仍未匹配上，则返回ACL匹配结果为：不匹配。

- 匹配（命中规则）：指存在ACL，且在ACL中查找到了符合匹配条件的规则。
- 不论匹配的动作是“permit”还是“deny”，都称为“匹配”，而不是只是匹配上permit规则才算“匹配”。

- 不匹配（未命中规则）：指不存在ACL，或ACL中无规则，再或者在ACL中遍历了所有规则都没有找到符合匹配条件的规则。以上三种情况，都叫做“不匹配”。

- 匹配原则：一旦命中即停止匹配。

### ACL的匹配顺序

华为设备支持两种匹配顺序：自动排序（auto模式）和配置顺序（config模式）。

缺省的ACL匹配顺序是config模式。

- 自动排序，是指系统使用“深度优先”的原则，将规则按照精确度从高到低进行排序，并按照精确度从高到低的顺序进行报文匹配。

- 配置顺序，系统按照ACL规则编号从小到大的顺序进行报文匹配，规则编号越小越容易被匹配。
  - 如果后面又添加了一条规则，则这条规则会被加入到相应的位置，报文仍然会按照从小到大的顺序进行匹配。

**注意：ACL技术总是与其他技术结合在一起使用的，因此，所结合的技术不同，“允许 (permit)”及“拒绝 (deny)”的内涵和作用也会不同。**

### ACL的匹配位置

- inbound (入站）方向

- outbound (出站)

### ACL配置命令

```
#使用编号创建ACL
[Huawei] acl [ number ] <acl-number> [ match-order config ]
#使用名称创建ACL
[Huawei] acl name <acl-name> { basic | <acl-number> } [ match-order config ]
#配置基本ACL规则
[Huawei-acl-basic-2000] rule [ <rule-id> ] { deny | permit } [ source { <source-address> <source-wildcard> | any } | time-range <time-name> ] 

#配置高级ACL规则
#当参数protocol为IP时，高级ACL的命令格式为
rule [ <rule-id> ] { deny | permit } ip [ 
destination { <destination-address> <destination-wildcard> | any } | 
source { <source-address> <source-wildcard> | any } | 
time-range <time-name> | [ 
dscp <dscp> | [ 
tos <tos> | precedence <precedence> ] ] ] 

#当参数protocol为TCP时，高级ACL的命令格式为
rule [ <rule-id> ] { deny | permit } { <protocol-number> | tcp } [ 
destination { <destination-address> <destination-wildcard> | any } | 
destination-port { eq <port> | gt <port> | lt <port> | range <port-start> <port-end> } | 
source { <source-address> <source-wildcard> | any } | 
source-port { eq <port> | gt <port> | lt <port> | range <port-start> <port-end> } | 
tcp-flag { ack | fin | syn } * | 
time-range <time-name> ] *

#在接口上配置基于ACL对报文进行过滤
traffic-filter { inbound | outbound } acl { <acl-number> | name <acl-name> } （接口视图）
```

**当参数protocol为IP时：**

- **ip** ：指定ACL规则匹配报文的协议类型为IP。

- **destination** { *destination-address destination-wildcard* | **any** }：指定ACL规则匹配报文的目的地址信息。如果不配置，表示报文的任何目的地址都匹配。

- **dscp** *dscp*：指定ACL规则匹配报文时，区分服务代码点（Differentiated Services Code Point），取值为：0~63。

- **tos** *tos*：指定ACL规则匹配报文时，依据服务类型字段进行过滤，取值为：0~15。

- **precedence** *precedence*：指定ACL规则匹配报文时，依据优先级字段进行过滤。precedence表示优先级字段值，取值为：0~7。

**当参数protocol为TCP时：**

- *protocol-number* | **tcp**：指定ACL规则匹配报文的协议类型为TCP。可以采用数值6表示指定TCP协议。

- **destination-port** { **eq** *port* | **gt** *port* | **lt** *port* | **range** *port-start port-end*}：指定ACL规则匹配报文的UDP或者TCP报文的目的端口，仅在报文协议是TCP或者UDP时有效。如果不指定，表示TCP/UDP报文的任何目的端口都匹配。其中：
  - **eq** *port*：指定等于目的端口；
  - **gt** *port*：指定大于目的端口；
  - **lt** *port*：指定小于目的端口；
  - **range** *port-start port-end*：指定源端口的范围。

- **tcp-flag**：指定ACL规则匹配报文的TCP报文头中SYN Flag。



▫**traffic-filter**命令，用来在接口上配置基于ACL对报文进行过滤。

▫命令格式：**traffic-filter** { **inbound** | **outbound** } **acl** { *acl**-number* | **name** *acl**-name* }

▪**inbound**：指定在接口入方向上配置报文过滤。

▪**outbound**：指定在接口出方向上配置报文过滤。

▪**acl**：指定基于IPv4 ACL对报文进行过滤。

## AAA

### AAA概述

AAA是Authentication（认证）、Authorization（授权）和Accounting（计费）的简称，是网络安全的一种管理机制，提供了认证、授权、计费三种安全功能。

- 认证（Authentication）：验证用户是否可以获得访问权，确定哪些用户可以访问网络。

- 授权（Authorization）：授权用户可以使用哪些服务。

- 计费（Accounting）：记录用户使用网络资源的情况。

网络运营商（ISP）需要验证家庭宽带用户的账号密码之后才允许其上网，并记录用户的上网时长或上网流量等内容，这就是AAA技术最常见的应用场景。

### AAA常见架构

AAA常见网络架构中包括用户、NAS（Network Access Server）、AAA服务器（AAA Server）。

- NAS负责集中收集和管理用户的访问请求。

- 在NAS上会创建多个域来管理用户。不同的域可以关联不同的AAA方案。

- 当收到用户接入网络的请求时，NAS会根据用户名来判断用户所在的域，根据该域对应的AAA方案对用户进行管控。

- 每个用户都属于某一个域。用户属于哪个域是由用户名中的域名分隔符@后的字符串决定。例如，如果用户名是user1@domain1，则用户属于domain1域。如果用户名后不带有@，则用户属于系统缺省域。

### 认证（Authentication）

**AAA支持三种认证方式:**

- 不认证：
  - 完全信任用户，不对用户身份进行合法性检查。
  - 鉴于安全考虑，这种认证方式很少被采用。

- 本地认证：
  - 将本地用户信息（包括用户名、密码和各种属性）配置在NAS上，此时NAS就是AAA Server。
  - 本地认证的优点是处理速度快、运营成本低；
  - 缺点是存储信息量受设备硬件条件限制。
  - 这种认证方式常用于对用户登录设备进行管理，如Telnet，FTP用户等。

- 远端认证：
  - 将用户信息（包括用户名、密码和各种属性）配置在认证服务器上。
  - 支持通过RADIUS协议或HWTACACS协议进行远端认证。
  - NAS作为客户端，与RADIUS服务器或HWTACACS服务器进行通信。

### 授权（Authorization）

AAA授权功能赋予用户访问的特定网络或设备的权限。

授权信息包括：所属用户组、所属VLAN、ACL编号等。

**AAA支持以下授权方式：**

- 不授权：不对用户进行授权处理。

- 本地授权：根据NAS上对应域下的配置进行授权。

- 远端授权：支持由RADIUS服务器授权或HWTACAS服务器授权。
  - HWTACACS授权，使用HWTACACS服务器对所有用户授权。
  - RADIUS授权，只支持对通过RADIUS服务器认证的用户授权。
  - RADIUS协议的认证和授权是绑定在一起的，不能单独使用RADIUS进行授权。
  - 当采用远端授权时，用户可以同时从授权服务器和NAS获取授权信息。
  - NAS配置的授权信息优先级比授权服务器下发的授权信息低。

### 计费（Accounting）

计费功能用于监控授权用户的网络行为和网络资源的使用情况。

AAA支持以下两种计费方式：

- 不计费：为用户提供免费上网服务，不产生相关活动日志。

- 远端计费：支持通过RADIUS服务器或HWTACACS服务器进行远端计费。

### RADIUS协议

- AAA可以用多种协议来实现，最常用的是RADIUS协议。

- RADIUS是一种分布式的、客户端/服务器结构的信息交互协议，可以实现对用户的认证、计费和授权功能。

- 通常由NAS作为RADIUS客户端，负责传输用户信息到指定的RADIUS服务器，然后根据从服务器返回的信息进行相应处理（如接受/拒绝用户接入）。

- RADIUS服务器一般运行在中心计算机或工作站上，维护相关的用户认证和网络服务访问信息，负责接收用户连接请求并认证用户，然后给客户端返回所有需要的信息（如接受/拒绝认证请求）。

- **RADIUS使用UDP（User Datagram Protocol）作为传输协议，并规定UDP端口1812、1813分别作为认证、计费端口，具有良好的实时性；同时也支持重传机制和备用服务器机制，从而具有较好的可靠性。**

**RADIUS客户端与服务器间的消息流程如下：**

- 当用户接入网络时，用户发起连接请求，向RADIUS客户端（即NAS）发送用户名和密码。

- RADIUS客户端向RADIUS服务器发送包含用户名和密码信息的认证请求报文。

- RADIUS服务器接收到合法的请求后，完成认证，并把所需的用户授权信息返回给客户端；对于非法的请求，RADIUS服务器返回认证失败的信息给客户端。

- RADIUS客户端通知用户认证是否成功。

- RADIUS客户端根据接收到的认证结果接入/拒绝用户。如果允许用户接入，则RADIUS客户端向RADIUS服务器发送计费开始请求报文。

- RADIUS服务器返回计费开始响应报文，并开始计费。

- 用户开始访问网络资源。

- 当用户不再想要访问网络资源时，用户发起下线请求，请求停止访问网络资源。

- RADIUS客户端向RADIUS服务器提交计费结束请求报文。

- RADIUS服务器返回计费结束响应报文，并停止计费。

- RADIUS客户端通知用户访问结束，用户结束访问网络资源。

### AAA配置命令

```
[Huawei] aaa 进入AAA视图
#创建认证方案
[Huawei-aaa] authentication-scheme <authentication-scheme-name> 
#配置当前认证方案使用的认证方式。缺省情况下，认证模式为本地认证方式。
[Huawei-aaa-authentication-scheme-name] authentication-mode { hwtacacs | local | radius }

[Huawei-aaa] domain <domain-name> 创建domain并进入相应的domain视图
#在相应的domain视图下绑定认证方案
[Huawei-aaa-domain-name] authentication-scheme <authentication-scheme-name>
#创建本地用户，并配置本地用户的密码
[Huawei-aaa] local-user <user-name>  password cipher <password>
#设置本地用户的接入类型。缺省情况下，本地用户关闭所有的接入类型。
[Huawei-aaa] local-user <user-name> service-type 
{ { terminal | telnet | ftp | ssh | snmp | http } | ppp | none }
#指定本地用户的权限级别。
[Huawei-aaa] local-user <user-name> privilege level <level>

display domain [ name <domain-name> ] 查看域的配置信息。
display aaa offline-record all 查看系统中用户下线的记录。
```

- 如果用户名中带域名分隔符，如@，则认为@前面的部分是用户名，后面部分是域名
- 如果没有@，则整个字符串为用户名，域为默认域

- **display domain** [ **name** *domain-name* ]命令用来查看域的配置信息。
  - **Domain-state**为Active表示激活状态。
  - 如果用户名后不带有@，则用户属于系统缺省域，华为设备支持两种缺省域：
    - default域为普通用户的缺省域。
    - default_admin域为管理用户的缺省域。

## NAT

### NAT概述

NAT（Network Address Translation，网络地址转换）

- 随着互联网用户的增多，IPv4的公有地址资源显得越发短缺。

- 同时IPv4公有地址资源存在地址分配不均的问题，这导致部分地区的IPv4可用公有地址严重不足。

- 为解决这个问题，NAT（Network Address Translation，网络地址转换）技术应需而生
  - 一方面NAT缓解了IPv4地址短缺的问题
  - 另一方面NAT技术让外网无法直接与使用私有地址的内网进行通信，提升了内网的安全性。

- NAT：对IP数据报文中的IP地址进行转换，是一种在现网中被广泛部署的技术，一般部署在网络出口设备，例如路由器或防火墙上。

- 通过私有地址的使用结合NAT技术，可以有效节约公网IPv4地址。

- 由于私有地址无法在Internet上路由转发，访问Internet的IP数据包将缺乏路由无法到达私有网络出口设备。

- 如果使用了私有地址的私有网络需要访问Internet，必须在网络出口设备配置NAT，将访问Internet的IP数据报文中的私有网络源地址转换成公有网络源地址。

### 静态NAT

- 静态NAT：每个私有地址都有一个与之对应并且固定的公有地址，即私有地址和公有地址之间的关系是一对一映射。

- 支持双向互访：私有地址访问Internet经过出口设备NAT转换时，会被转换成对应的公有地址。同时，外部网络访问内部网络时，其报文中携带的公有地址（目的地址）也会被NAT设备转换成对应的私有地址。

### 动态NAT

- 动态NAT：静态NAT严格地一对一进行地址映射，这就导致即便内网主机长时间离线或者不发送数据时，与之对应的公有地址也处于使用状态。为了避免地址浪费，动态NAT提出了地址池的概念：所有可用的公有地址组成地址池。

- 当内部主机访问外部网络时临时分配一个地址池中未使用的地址，并将该地址标记为“In Use”。当该主机不再访问外部网络时回收分配的地址，重新标记为“Not Use”。

### NAPT

- 动态NAT选择地址池中的地址进行地址转换时不会转换端口号，即No-PAT（No-Port Address Translation，非端口地址转换），公有地址与私有地址还是1:1的映射关系，无法提高公有地址利用率。

- NAPT（Network Address and Port Translation，网络地址端口转换）：从地址池中选择地址进行地址转换时不仅转换IP地址，同时也会对端口号进行转换，从而实现公有地址与私有地址的1:n映射，可以有效提高公有地址利用率。
- NAPT借助端口可以实现一个公有地址同时对应多个私有地址。该模式同时对IP地址和传输层端口进行转换，实现不同私有地址（不同的私有地址，不同的源端口）映射到同一个公有地址（相同的公有地址，不同的源端口）。

### Easy IP

- Easy IP：实现原理和NAPT相同，同时转换IP地址、传输层端口，**区别在于Easy IP没有地址池的概念**，使用接口地址作为NAT转换的公有地址。

- Easy IP适用于不具备固定公网IP地址的场景：如通过DHCP、PPPoE拨号获取地址的私有网络出口，可以直接使用获取到的动态地址进行转换。

### NAT Server

- NAT Server：指定**[公有地址:端口]**与**[私有地址:端口]**的一对一映射关系，将内网服务器映射到公网，当私有网络中的服务器需要对公网提供服务时使用。

- 外网主机主动访问**[公有地址:端口]**实现对内网服务器的访问。

### NAT配置命令

```
#静态NAT
#接口下配置静态NAT
nat static global <global-add> inside <host-add> 接口下配置静态NAT

#系统视图下配置静态NAT
nat static global <global-add> inside <host-add> 系统视图下配置静态NAT
nat static enable 使能NAT（接口视图）

#动态NAT配置
#创建地址池，配置公有地址范围，公有地址不能包括去往公网的接口地址
nat address-group <group-index> <start-add> <end-add> 
#配置地址转换的ACL规则
acl <num>
rule <rule-id> permit source <source-add> <souce-wildcard> 
#接口视图下关联ACL与地址池进行动态地址转换（no pat参数指定不进行端口转换）
nat outbound <acl-num> address-group <group-index> [no-pat] 

#动态NAPT配置
同NAT配置不加 no pat 参数

#Easy-IP配置
acl 2000
rule 5 permit source 192.168.1.0 0.0.0.255
nat outbound 2000 接口视图下配置NAT outbound

#NAT Server配置
nat server protocol tcp global 122.1.2.1 www inside 192.168.1.10 8080
```

# 网络服务与应用

## 文件传输协议

在互联网早期，Web（World Wide Web，万维网）还未出现，操作系统使用命令行的时代，用户使用命令行工具进行文件传输。其中最通用的方式就是使用FTP（File Transfer Protocol，文件传输协议）以及TFTP（Trivial File Transfer Protocol，简单文件传输协议）。

### FTP

- FTP采用典型的C/S架构（即服务器端与客户端模型），客户端与服务器端建立TCP连接之后即可实现文件的上传、下载。

- 针对传输的文件类型不同，FTP可以采用不同的传输模式：
  - ASCII模式：传输文本文件（TXT、LOG、CFG ）时会对文本内容进行编码方式转换，提高传输效率。当传输网络设备的配置文件、日志文件时推荐使用该模式。
  - Binary（二进制）模式：非文本文件（cc、BIN、EXE、PNG），如图片、可执行程序等，以二进制直接传输原始文件内容。当传输网络设备的版本文件时推荐使用该模式。

**FTP传输过程**

- 主动模式（PORT）
  - 客户端使用一个随机端口向服务端port 21 发起TCP三次握手，建立控制连接
  - 用户认证登陆
  - 同时FTP客户端开始监听另一随机端口P（一般大于1024），
  - 客户端通过FTP PORT命令通知服务器自身开放端口号P
  - 服务器向客户端端口P发起TCP三次握手，建立传输连接，服务器端口号20
  - 开始文件传输
  
- 被动模式（PASV）
  - 客户端使用一个随机端口向服务端port 21 发起TCP三次握手，建立控制连接
  - 用户认证登陆
  - 同时FTP客户端开始监听另一随机端口P（一般大于1024），
  - 客户端发送PASV命令
  - 客户端通过Enter PASV命令告知客户端自身开放端口号N（随机端口，一般大于1024）
  - 客户端向服务端端口N发起TCP三次握手，建立传输连接
  - 开始文件传输

**主动模式和被动模式建立数据连接方式完全不同，在实际使用中各有利弊：**

- 使用主动模式传输数据时，如果FTP客户端在私有网络中并且FTP客户端和FTP服务器端之间存在NAT设备，那么FTP服务器端收到的PORT报文中携带的端口号、IP地址并不是FTP客户端经过NAT转换之后的地址、端口号，因此服务器端无法向PORT报文中携带的私网地址发起TCP连接（此时，客户端的私网地址在公有网络中路由不可达）。
- 使用被动模式传输数据时，FTP客户端主动向服务器端的一个开放端口发起连接，如果FTP服务器端在防火墙内部区域中，并且没有放通客户端所在区域到服务器端所在区域的主动访问，那么这个连接将无法建立成功，从而导致FTP无法正常传输。

### TFTP

- 相较于FTP，TFTP的设计就是以传输小文件为目标，协议实现就简单很多：
  - 使用UDP进行传输（端口号69）
  - 无需认证
  - 只能直接向服务器端请求某个文件或者上传某个文件，无法查看服务器端的文件目录。

**TFTP存在5种报文格式：**

- RRQ：读请求包。

- WRQ：写请求包。

- DATA：数据传输报文。

- ACK：应答包，用于确认收到对端的报文。

- ERROR：差错控制报文。

### FTP配置命令

```
ftp [ipv6] server enable 开启ftp服务器端功能
#配置FTP本地用户
aaa
local-user <user-name> password irreversible-cipher <pwd>
local-user <user-name> privilege level <level> 必须3级或3级以上
local-user <user-name> service-type ftp
local-user <user-name> ftp-directory <directory>

#客户端常用命令
ascii
binary
ls
passive
get
put

#TFTP
<Huawei> tftp <TFTP_Server-IP-address> get <filename> VRP作为TFTP客户端下载文件
<Huawei> tftp <TFTP_Server-IP-address> put <filename> VRP作为TFTP客户端上传文件
TFTP无需登录，直接输入服务器端IP地址以及操作命令即可。
目前VRP设备只支持作为TFTP客户端。
```

- VRP（Versatile Routing Platform ，通用路由平台）
  - ascii    Set the file transfer type to ASCII, and it is the default type ：切换到ASCII传输模式。
  - binary  Set the file transfer type to support the binary image：切换到Binary传输模式。
  - ls      List the contents of the current or remote directory：查看FTP服务器端上的文件列表，也可以使用dir 。
  - passive  Set the toggle passive mode, the default is on：使用被动模式，undo passive使用主动模式。
  - get    Download the remote file to the local host：下载FTP服务器端的文件到本地。
  - put    Upload a local file to the remote host：上传本地文件到FTP服务器端 。

- TFTP无需登录，直接输入服务器端IP地址以及操作命令即可。
- 目前VRP设备只支持作为TFTP客户端。

## Telnet

TCP（23）

Telnet所对应的用户界面类型为VTY（Virtual Type Terminal，虚拟类型终端）

### Telnet配置命令

```
telnet server enable 使能Telnet服务器端
user-interface vty <first-ui-num> [<last-ui-num>] 进入用户视图
protocol inbound {all|telnet} 配置VTY用户界面支持的协议，缺省情况下支持SSH和Telnet
authentication-mode {aaa|none|password} 配置认证模式，缺省无认证
set authentication password cipher <pwd> 配置密码认证方式下的认证密码
```

SSH（Secure Shell Protocol ，安全外壳协议）

## DHCP

- 为解决传统的静态手工配置方式的不足，DHCP（Dynamic Host Configuration Protocol，动态主机配置协议）应运而生，其可以实现网络动态合理地分配IP地址给主机使用。

- DHCP采用C/S构架，主机无需配置，从服务器端获取地址，可实现接入网络后即插即用。
- IP地址从服务器端的地址池中获取，服务器端会记录维护IP地址的使用状态，做到IP地址统一分配、管理。
- DHCP提出了租期的概念，可有效提高地址利用率。

### DHCP工作原理

- C端  DHCP Discover（广播）
- S端 DHCP Offer（单播）
- C端 DHCP Request（广播）
- S端 DHCP Ack（单播）

### DHCP租期更新

- 50%租期
  - C端 DHCP Request（单播）
  - S端 DHCP Ack（单播）

**重绑定：如果C端未得到回应，C端87.5%租期时广播发送DHCP Request，任意一台S端都可回应**

### DHCP配置命令

```
dhcp enable 开启dhcp功能
dhcp select interface 开启接口采用接口地址池的dhcp服务器端功能(接口视图)
dhcp server dns-list <ip-add> 指定DNS服务器地址(接口视图)
#配置接口地址池中不参与自动分配的IP地址范围
dhcp server excluded-ip-address {<ip-add>|<start-ip-add> <end-ip-add>}(接口视图)
#配置DHCP服务器接口地址池中IP地址的租期，缺省值1天
dhcp server lease {day <day> [ hour <hour> [ minute <minute> ] ]|unlimited} (接口视图)

ip pool <ip-pool-name> 创建全局地址池
network ip-address [ mask <mask> ] 配置全局地址池可动态分配的IP地址范围
gateway-list <ip-add> 配置客户端的网关
dns-list <ip-add> 配置客户端的dns
lease {day <day> [ hour <hour> [ minute <minute> ] ]|unlimited} 配置租期
dhcp select golbal 接口视图下使能
```

## HTTP

- 当我们在浏览器中输入URL（Uniform Resource Locator，统一资源定位符）时，浏览器就可以从某处获取内容，并将页面内容显示在浏览器中。

- HTTP（Hypertext Transfer Protocol，超文本传输协议）：客户端浏览器或其他程序与Web服务器之间的应用层通信协议。

- HTTP是典型的C/S构架应用，作为应用层协议使用TCP进行传输。

- URL：唯一标识Internet上网页和其他资源位置的地址，可以包括如超文本网页（扩展名通常为.html或.htm）名称之类的详细信息。

- 在互联网早期，为了进行文档之间的共享，人们提出了WWW（World Wide Web，万维网）。

- WWW由三部分组成：在浏览器中显示文档内容的页面标记语言HTML（Hypertext Markup Language，超文本标记语言）、在网络上传输文档的协议HTTP、在网络上表明文档位置的URL。

- WWW早期其实是浏览HTML的客户端应用程序的名称，现在则代表三项技术的合集，也可以简称为Web。

## DNS

负责将域名解析到IP地址的协议为DNS（Domain Name System，域名解析系统）

- Internet的前身ARPAnet时就已经存在主机名称和IP地址的对应关系，只是当时主机数目很少，只需要一个HOSTS.txt文件就可以维护对应关系；
- HOSTS.txt由NIC（network information center）维护，改动自己主机名的使用者通过电子邮件将自身改动发送给NIC，NIC定期更新HOSTS.txt，这一切在主机数目很少时都没有什么问题。
- 但当ARPAnet使用TCP/IP协议之后，网络用户数量出现了激增，手动维护HOSTS.txt似乎变得困难起来：
  - 名称冲突：NIC虽然可以保证管理的主机名称一致性，但很难保证主机不会随机修改名称和别人正在使用的一致。
  - 一致性：随着网络规模扩大，用户的HOSTS.txt很难保持一致性，很可能主机的HOSTS.txt文件还未更新，其余主机的名称已经变动了数次。

- 于是接替者DNS由此诞生。

### 域名系统组成

- 域名：主机的字符标识方式。大部分情况下，我们访问网站时在浏览器内输入的URL就是该网站的域名。

- 域名解析服务器（DNS Server）：负责维护域名与IP地址对应关系的数据库，并对解析者的请求进行响应。

- 域名系统是一个分布式的结构，每个服务器上的数据库只保存了部分域名与IP的对应关系。

### 域名的表示方法

域名的表示方法为：主机名.次顶级域名.顶级域名.根域，根域为“.”，一般最后的根域不表示。

### DNS查询方式

DNS是一个分布式系统，绝大多数的DNS服务器端的数据库不会拥有所有的域名记录，当客户端向一个DNS服务器端查询域名但该DNS服务器端上却没有该域名的记录时，此时会有两种继续查询的方式：

- 递归查询：由DNS服务器向其他DNS服务器进行查询，将最终查询结果返回给DNS客户端

- 迭代查询：DNS服务器告知DNS客户端其他DNS服务器地址，客户端自行向其他DNS服务器进行查询。

## NTP

当今企业园区网络中很多场景都需要所有设备保持时钟一致：

- 网络管理：对从不同路由器采集来的日志信息、调试信息进行分析时，需要以时间作为参照依据。
- 计费系统：要求所有设备的时钟保持一致。
- 多个系统协同处理同一个复杂事件：为保证正确的执行顺序，多个系统必须参考同一时钟。
- 备份服务器和客户机之间进行增量备份：要求备份服务器和所有客户机之间的时钟同步。
- 系统时间：某些应用程序需要知道用户登录系统的时间以及文件修改的时间。

### NTP简介

- 网络时间协议NTP（Network Time Protocol）是TCP/IP协议族里面的一个应用层协议。
- NTP用于在一系列分布式时间服务器与客户端之间同步时钟。
- **NTP的实现基于IP和UDP。**
- **NTP报文通过UDP传输，端口号是123。**

- 目前主流的网络设备，如：AC（Access Controller，无线控制器）、AP（Access Point，接入点）、Firewall、Router、Switch、Server等基本都作为NTP的客户端，同时其中部分还可以作为NTP服务器端。

### NTP网络结构

- 主时间服务器：通过线缆或无线电直接同步到标准参考时钟，标准参考时钟通常是Radio Clock或卫星定位系统等。

- 二级时间服务器：通过网络中的主时间服务器或者其他二级服务器取得同步。二级时间服务器通过NTP将时间信息传送到局域网内部的其它主机。

- 层数（stratum）：层数是对时钟同步情况的一个分级标准，代表了一个时钟的精确度，取值范围1～15，数值越小，精确度越高。1表示时钟精确度最高，15表示未同步。

# WLAN

WLAN (Wireless Local Area Network，无线局域网)

## WLAN概述

- WLAN即Wireless LAN（无线局域网），是指通过无线技术构建的无线局域网络。
  - 这里指的无线技术不仅仅包含Wi-Fi，还有红外、蓝牙、ZigBee等等。
  - 通过WLAN技术，用户可以方便地接入到无线网络，并在无线网络覆盖区域内自由移动，摆脱有线网络的束缚。

- 无线网络根据应用范围可分为WPAN、WLAN、WMAN、WWAN。
  - WPAN (Wireless Personal Area Network)：个人无线网络，常用技术有：Bluetooth、Zigbee、NFC、HomeRF、UWB。
  - WLAN (Wireless Local Area Network)：无线局域网，常用技术有：Wi-Fi。(WLAN中也会使用WPAN的相关技术。)
  - WMAN (Wireless Metropolitan Area Network)：无线城域网，常用技术有：WiMax。
  - WWAN (Wireless Wide Area Network)：无线广域网，常用技术有：GSM、CDMA、WCDMA、TD-SCDMA、LTE、5G。

- WLAN的优点：
  - 网络使用自由：凡是自由空间均可连接网络，不受限于线缆和端口位置。在办公大楼、机场候机厅、度假村、商务酒店、体育场馆、咖啡店等场所尤为适用。
  - 网络部署灵活：对于地铁、公路交通监控等难于布线的场所，采用WLAN进行无线网络覆盖，免去或减少了繁杂的网络布线，实施简单，成本低，扩展性好。

### IEEE802.11

|  WI-FI   |      协议      |   速率   |     频率     |
| :------: | :------------: | :------: | :----------: |
| WI- FI 1 |     802.11     |  2Mbps   |    2.4GHz    |
| WI-FI 2  |    802.11b     |  11Mbps  |    2.4GHz    |
| WI-FI 3  |    802.11a     |  54Mbps  |     5GHz     |
| WI-FI 3  |    802.11g     |  54Mbps  |    2.4GHz    |
| WI-FI 4  |    802.11n     | 300Mbps  | 2.4GHz、5GHz |
| WI-FI 5  | 802.11ac wave1 | 1300Mbps |     5GHz     |
| WI-FI 5  | 802.11ac wave2 | 6.9Gbps  |     5GHz     |
| WI-FI 6  |    802.11ax    | 9.6Gbps  | 2.4GHz、5GHz |

### IEEE802与TCP/IP对等模型

![image-20220722024121771](./assets/image-20220722024121771.png)

- WLAN是一种基于IEEE 802.11标准的无线局域网技术。

- 802.11标准聚焦在TCP/IP对等模型的下两层：
  - 数据链路层：主要负责信道接入、寻址、数据帧校验、错误检测、安全机制等内容。
  - 物理层：主要负责在空口（空中接口）中传输比特流，例如规定所使用的频段等。

### Wi-Fi在办公场景的发展趋势

- 第一阶段：初级移动办公时代，无线作为有线的补充
- 第二阶段：无线办公时代，有线无线一体化
- 第三阶段：全无线办公时代，以无线为中心

## WLAN基本概念

- **家庭Wi-Fi路由器：**
  - 通过把有线网络信号转换成无线信号，供家庭电脑、手机等设备接收，实现无线上网功能。
  - 主要为FAT AP。

- **企业WLAN产品：**
  - 无线接入点 (AP, Access Point)
    - 一般支持FAT AP（胖AP）、FIT AP（瘦AP）和云管理AP三种工作模式，根据网络规划的需求，可以灵活地在多种模式下切换。
    - FAT AP：适用于家庭，独立工作，需单独配置，功能较为单一，成本低。独立完成用户接入、认证、数据安全、业务转发和QoS等功能。
    - FIT AP：适用于大中型企业，需要配合AC使用，由AC统一管理和配置，功能丰富，对网络维护人员的技能要求高。用户接入、AP上线、认证、路由、AP管理、安全协议、QoS等功能需要同AC配合完成。
  - 云管理：适用于中小型企业，需要配合云管理平台使用，由云管理平台统一管理和配置，功能丰富，即插即用，对网络维护人员的技能要求低。
  - 无线接入控制器 (AC, Access Controller)
    - 一般位于整个网络的汇聚层，提供高速、安全、可靠的WLAN业务。
    - 提供大容量、高性能、高可靠性、易安装、易维护的无线数据控制业务，具有组网灵活、绿色节能等优势。


**POE与POE交换机**

- PoE（Power over Ethernet，以太网供电）是指通过以太网网络进行供电，也被称为基于局域网的供电系统PoL（Power over LAN）或有源以太网（Active Ethernet）。

- PoE允许电功率通过传输数据的线路或空闲线路传输到终端设备。

- 在WLAN网络中，可以通过PoE交换机对AP设备进行供电。

**WLAN网络架构**

- WLAN网络架构分有线侧和无线侧两部分，有线侧是指AP上行到Internet的网络使用以太网协议，无线侧是指STA到AP之间的网络使用802.11协议。
- 无线侧接入的WLAN网络架构为集中式架构。从最初的FAT AP架构，演进为AC+FIT AP架构。

  - FAT AP (胖AP)架构

    - 这种架构不需要专门的设备集中控制就可以完成无线用户的接入、业务数据的加密和业务数据报文的转发等功能，因此又称为自治式网络架构。
    - 适用范围：家庭
    - 特点：AP独立工作，需要单独配置，功能较为单一，成本低。
    - 缺点：随着WLAN覆盖面积增大，接入用户增多，需要部署的FAT AP数量也会增多，但FAT AP是独立工作的，缺少统一的控制设备，因此管理维护这些FAT AP就十分麻烦。

  - AC+FIT AP (瘦AP)架构

    - 这种架构中，AC负责WLAN的接入控制、转发和统计、AP的配置监控、漫游管理、AP的网管代理、安全控制；FIT AP负责802.11报文的加解密、802.11的物理层功能、接受AC的管理等简单功能。
    - 适用范围：大中型企业
    - 特点：AP需要配合AC使用，由AC统一管理和配置，功能丰富，对网络运维人员的技能要求高。

**WLAN基本概念：**

- 工作站STA (Station)：
  - 支持802.11标准的终端设备。例如带无线网卡的电脑、支持WLAN的手机等。

- 无线接入控制器AC (Access Controller)：
  - 在AC+FIT AP网络架构中，AC对无线局域网中的所有FIT AP进行控制和管理。例如，AC可以通过与认证服务器交互信息来为WLAN用户提供认证服务。

- 无线接入点AP (Access Point)：
  - 为STA提供基于802.11标准的无线接入服务，起到有线网络和无线网络的桥接作用。

- 无线接入点控制与规范CAPWAP (Control And Provisioning of Wireless Access Points)：
  - 由RFC5415协议定义的，实现AP和AC之间的互通的一个通用封装和传输机制。

- 射频信号 (无线电磁波)：
  - 提供基于802.11标准的WLAN技术的传输介质，是具有远距离传输能力的高频电磁波。本课程指的射频信号是2.4G或5G频段的无线电磁波。

### CAPWAP协议

**什么是CAPWAP隧道**

- CAPWAP（Control And Provisioning of Wireless Access Points Protocol Specification，无线接入点控制和配置协议）：该协议定义了如何对AP进行管理、业务配置，即AC通过CAPWAP隧道来实现对AP的集中管理和控制。

**CAPWAP隧道的功能**

- AP与AC间的状态维护。

- AC通过CAPWAP隧道对AP进行管理、业务配置下发。

- 当采用隧道转发模式时，AP将STA发出的数据通过CAPWAP隧道实现与AC之间的交互。

**CAPWAP是基于UDP进行传输的应用层协议。**

CAPWAP协议在传输层运输两种类型的消息：

- 业务数据流量，封装转发无线数据帧 。——通过CAPWAP数据隧道。
- 管理流量，管理AP和AC之间交换的管理消息 。——通过CAPWAP控制隧道。

CAPWAP数据和控制报文基于不同的UDP端口发送：

- 管理流量端口为**UDP端口5246**。
- 业务数据流量端口为**UDP端口5247**。

### AP-AC组网

- AP-AC组网：二层是指AP和AC之间是二层组网，三层是指AC和AP之间是三层组网；
  - 二层组网AP可以通过二层广播，或者DHCP过程，即插即用上线；
  - 三层网络下，AP无法直接发现AC，需要通过DHCP或DNS方式动态发现，或者配置静态IP。

- 在实际组网中，一台AC可以连接几十甚至几百台AP，组网一般比较复杂。
- 因此，在大型组网中一般采用三层组网。

### AC连接方式

AC连接方式：直连模式下AC部署在用户的转发路径上，旁挂则相反；直连模式用户流量要经过AC，会消耗AC转发能力，旁挂一般流量不会经过AC。

- 直连式组网：
  - 采用这种组网方式，对AC的吞吐量以及处理数据能力比较高，否则AC会是整个无线网络带宽的瓶颈。
  - 但用此种组网，组网架构清晰，组网实施起来简单。

- 旁挂式组网：
  - 由于实际组网中，大部分不是早期就规划好无线网络，无线网络的覆盖架设大部分是后期在现有网络中扩展而来。而采用旁挂式组网就比较容易进行扩展，只需将AC旁挂在现有网络中，比如旁挂在汇聚交换机上，就可以对终端AP进行管理。所以此种组网方式使用率比较高。
  - 在旁挂式组网中，AC只承载对AP的管理功能，管理流封装在CAPWAP隧道中传输。数据业务流可以通过CAPWAP数据隧道经AC转发，也可以不经过AC转发直接转发，后者无线用户业务流经汇聚交换机由汇聚交换机传输至上层网络。

### 无线通信系统

无线通信系统中，信息可以是图像、文字、声音等。信息需要先经过信源编码转换为方便于电路计算和处理的数字信号，再经过信道编码和调制，转换为无线电波发射出去。

**信源——编码——调制——空口——信道——空口——解调——解码——信宿**

- 信源编码：将最原始的信息，经过对应的编码，转换为数字信号的过程。

- 信道编码：是一种对信息纠错、检错的技术，可以提升信道传输的可靠性。信息在无线传输过程中容易受到噪声的干扰，导致接收信息出错，引入信道编码能够在接收设备上最大程度地回复信息，降低误码率。

- 调制：将数字信号叠加到高频振荡电路产生的高频信号上，才能通过天线转换成无线电波发射出去。叠加动作就是调制的过程。

- 信道：传输信息的通道，无线信道就是空间中的无线电波。

- 空中接口：简称空口，无线信道使用的接口。发送设备和接收设备使用接口和信道连接，对于无线通信，接口是不可见的，连接着不可见的空间。

### 无线电磁波

无线电磁波是频率介于3赫兹和约300G赫兹之间的电磁波，也叫作射频电波，或简称射频、射电。

WLAN技术就是通过无线电磁波在空间中传输信息。当前我们使用的频段是：

- 2.4GHz频段 (2.4GHz~2.4835GHz）；

- 5GHz频段（5.15GHz~5.35GHz，5.725GHz~5.85GHz）。

**无线电磁波频谱：**

- 极低频 (3Hz–30Hz)：潜艇通讯或直接转换成声音。

- 超低频 (30Hz–300Hz) ：直接转换成声音或交流输电系统（50-60赫兹)。

- 特低频 (300Hz–3KHz) ：矿场通讯或直接转换成声音。

- 甚低频 (3KHz–30KHz) ：直接转换成声音、超声、地球物理学研究。

- 低频 (30KHz–300KHz) ：国际广播。

- 中频 (300KHz–3MHz) ：调幅(AM)广播、海事及航空通讯。

- 高频 (3MHz–30MHz) ：短波、民用电台。

- 甚高频 (30MHz–300MHz) ：调频(FM)广播、电视广播、航空通讯。

- 特高频 (300MHz–3GHz) ：电视广播、无线电话通讯、无线网络、微波炉。

- 超高频 (3GHz–30GHz) ：无线网络、雷达、人造卫星接收。

- 极高频 (30GHz–300GHz) ：射电天文学、遥感、人体扫描安检仪。

- 300GHz以上：红外线、可见光、紫外线、射线等。

### 无线信道

信道是传输信息的通道，无线信道就是空间中的无线电磁波。

- 2.4GHz频段被划分为14个有重叠的、频率宽度是22MHz的信道。其中包含重叠信道和非重叠信道。
  - 重叠信道：在一个空间内同时存在重叠信道，则会产生干扰问题。
  - 非重叠信道：在一个空间内可以同时存在非重叠信道，不会产生干扰问题。

- 对于5G频段，支持更宽频谱，频率资源更为丰富，AP不仅支持20MHz带宽的信道，还支持40MHz、80MHz及更大带宽的信道。

### BSS/SSID/BSSID/VAP/ESS

- BSS (Basic Service Set)：

  - 一个AP所覆盖的范围。

  - 无线网络的基本服务单元，通常由一个AP和若干STA组成。
  - 由于无线介质共享性，BSS中报文收发需携带BSSID（MAC地址）。
  - 在一个BSS的服务区域内，STA可以相互通信。

- 基本服务集标识符BSSID（Basic Service Set Identifier）：
  - AP上的数据链路层MAC地址。
  - 终端要发现和找到AP，需要通过AP的一个身份标识，这个身份标识就是BSSID。
  - 为了区分BSS，要求每个BSS都有唯一的BSSID，因此使用AP的MAC地址来保证其唯一性。

- 服务集标识符SSID（Service Set Identifier）：
  - 表示无线网络的标识，用来区分不同的无线网络。
  - 如果一个空间部署了多个BSS，终端就会发现多个BSSID，只要选择加入的BSSID就行。
  - 为了使得AP的身份更容易辨识，则用一个字符串来作为AP的名字。这个字符串就是SSID。

- 虚拟接入点VAP（Virtual Access Point）：
  - VAP就是在一个物理实体AP上虚拟出的多个AP。
  - 每一个被虚拟出的AP就是一个VAP。
  - 每个VAP提供和物理实体AP一样的功能。
  - 每个VAP对应1个BSS。这样1个AP，就可以提供多个BSS，可以再为这些BSS，设置不同的SSID。
  - VAP并不等同于真正的AP，所有的VAP都共享这个AP的软件和硬件资源，所有VAP的用户都共享相同的信道资源，所以AP的容量是不变的，并不会随着VAP数目的增加而成倍的增加。

- ESS (Extend Service Set)：
  - 采用相同的SSID的多个BSS组成的更大规模的虚拟BSS。
  - 用户可以带着终端在ESS内自由移动和漫游，不管用户移动到哪里，都可以认为使用的同一个WLAN。

- WLAN漫游：
  - 指STA在同属一个ESS的不同AP的覆盖范围之间移动且保持用户业务不中断的行为。
  - WLAN网络的最大优势就是STA不受物理介质的影响，可以在WLAN覆盖范围内四处移动并且能够保持业务不中断。
  - 同一个ESS内包含多个AP设备，当STA从一个AP覆盖区域移动到另外一个AP覆盖区域时，利用WLAN漫游技术可以实现STA用户业务的平滑切换。

## WALN的组网架构

### FAT AP架构

- FAT AP架构不需要专门的设备集中控制就可以完成无线用户的接入、业务数据的加密和业务数据报文的转发等功能，因此FAT AP架构又称为自治式网络架构。
- 当部署单个AP时，由于FAT AP具备较好的独立性，不需要另外部署集中控制设备，部署起来很方便，成本较低廉，所以家庭部署WLAN，FAT AP架构往往是最适合的选择。但是，在企业中，FAT AP的独立自治就变成了缺点。

- 随着WLAN覆盖面积增大，接入用户增多，需要部署的FAT AP数量也会增多。而每个FAT AP又是独立工作的，缺少统一的控制设备，因此管理、维护这些FAT AP就变得十分麻烦。例如，如果需要升级软件版本，每一台FAT AP都需要单独升级一次，耗时耗力。FAT AP架构无法满足更大覆盖范围内的用户漫游诉求。另外，对于复杂业务，例如，针对网络用户的不同数据类型进行优先级策略控制，FAT AP架构也无法支持统一控制。

- 所以对于企业而言，不推荐FAT AP架构，更合适的选择是下面要介绍的AC+FIT AP架构、云管理架构等。

### AC+FIT AP架构

- AC和AP之间使用的通信协议是CAPWAP协议，CAPWAP协议定义的主要内容有：
  - AP自动发现AC，AC对AP进行安全认证，AP从AC获取软件，AP从AC获得初始和动态配置等。
  - 通过该协议，AP和AC之间建立起CAPWAP隧道。
  - CAPWAP隧道有两种：控制隧道和数据隧道。
    - 控制隧道主要传输控制报文（也称管理报文，是AC管理控制AP的报文）
    - 数据隧道主要传输数据报文。
    - CAPWAP隧道可以进行数据传输层安全（Datagram Transport Layer Security，DTLS）加密，因此传输的报文更加安全。

- 相比于FAT AP架构，AC+FIT AP架构的优点如下。
  - 配置与部署：通过AC进行集中地网络配置和管理，不再需要对每个AP进行单独配置操作，同时对整网AP进行信道、功率的自动调整，免去了烦琐的人工调整过程。
  - 安全性：由于FAT AP无法进行统一的升级操作，无法保证所有AP版本都有最新的安全补丁，而AC+FIT AP架构主要的安全能力是在AC上的，软件更新和安全配置仅需在AC上进行，从而可以快速进行全局安全设置；
  - 同时，为了防止加载恶意代码，设备会对软件进行数字签名认证，增强了更新过程的安全性。AC也实现了FAT AP架构无法支持的一些安全功能，包括病毒检测、统一资源定位地址（Uniform Resource Locater，URL）过滤、状态检测防火墙等高级安全特性。

- 更新与扩展：架构的集中管理模式使得同一AC下的AP有着相同的软件版本。当需要更新时，先由AC获取更新包或补丁，然后由AC统一更新AP版本。AP和AC的功能拆分也减少了对AP版本的频繁更新，有关用户认证、网管和安全等功能的更新只需在AC上进行。

### 敏捷分布式AP

- AP的一种特殊架构，将AP拆分为中心AP和敏分AP两部分，中心AP可管理多台敏分AP，在适用的场景下，成本低，覆盖好。
- 敏捷分布式AP可以用于FAT AP、AC+FIT AP、云管理架构。

- 适用范围：房间分布密集的场景。

### 云管理架构

- 传统方案的弊端：
  - 在部署网络时，传统网络解决方案会存在部署成本高、后期运维困难等问题，尤其是对于分支站点数量多、站点地域分散的企业，这些问题尤为明显。

- 云管理架构：
  - 云管理架构可以很好的解决以上问题，通过云管理平台，实现任意地点对设备进行集中的管理和维护，大大降低网络部署运维成本。
  - 当云AP布放完成后，无须网络管理员到安装现场对云AP进行软件调试，云AP上电后即可自动连接到指定的云管理平台加载指定的配置文件、软件包和补丁文件等系统文件，实现云AP零配置上线。网络管理员可以随时随地通过云管理平台统一给AP下发配置，使业务批量配置更快捷。

## WLAN的工作原理

**WLAN工作流程**

- AP上线：AP获取IP地址并发现AC，与AC建立连接

- WLAN业务配置下发：AC将WLAN业务配置下发到AP生效

- STA接入：STA搜索到AP发射的SSID并连接、上线，接入网络

- WLAN业务数据转发：WLAN网络开始转发业务数据

### AP上线

- AP获取IP地址
- AP发现AC并建立CAPWAP隧道
  - Discovery Request/Response
- AP接入控制

  - Join Request/Response
- AP版本升级

  - Image Data Request/Response
- CAPWAP隧道维持

  - Keepalive/Keepalive（数据隧道维持）
  - Echo Request/Response（控制隧道维持）

**AP获取IP地址**

- 静态方式：登录到AP设备上手工配置IP地址。
- DHCP方式：通过配置DHCP服务器，使AP作为DHCP客户端向DHCP服务器请求IP地址。

**AP发现AC并与之建立CAPWAP隧道**

- AP通过发送Discovery Request报文，找到可用的AC。
- AP发现AC有两种方式：

  - 静态方式：AP上预先配置AC的静态IP地址列表。

    - AP上线时，AP分别发送Discovery Request单播报文到所有预配置列表对应IP地址的AC。
    - 然后AP通过接收到AC返回的Discovery Response报文，选择一个AC开始建立CAPWAP隧道。

  - 动态方式：DHCP方式、DNS方式和广播方式。

    - DHCP方式：
- 通过DHCP的四步交互过程，获取AC的IP地址：
  
  - 在没有预配置AC的IP列表时，则启动AP动态AC发现机制。通过DHCP获取IP地址，并通过DHCP协议中的Option返回AC地址列表（在DHCP服务器上配置DHCP响应报文中携带Option 43，且Option 43携带AC的IP地址列表）。
    
  - 首先是AP发送DHCP Discover广播报文，请求DHCP Server响应
    
  - 在DHCP服务器侦听到DHCP Discover报文后，它会从没有租约的地址范围中，选择最前面的闲置IP，连同其他TCP/IP设定，响应AP一个DHCP Offer报文，该报文中会包含一个租约期限的信息。
    
  - 由于DHCP Offer报文既可以是单播报文，也可以是广播报文，当AP端收到多台DHCP Server的响应时，只会挑选其中一个Offer(通常是最先抵达的那个)，然后向网络中发送一个DHCP Request广播报文，告诉所有的Offer，并重新发送DHCP，将指定接收哪一台服务器提供的IP地址。
    
  - 当DHCP Server接收到AP的Request报文之后，会向AP发送一个DHCP Ack响应，该报文中携带的信息包括了AP的IP地址，租约期限，网关信息，以及DNS Server IP等，以此确定租约的正式生效，就此完成DHCP的四步交互工作。
    
  - AP通过DHCP服务获取AC的IP地址后，使用AC发现机制来获知哪些AC是可用的，决定与最佳AC来建立CAPWAP的连接。
    
  - AP启动CAPWAP协议的发现机制，以单播或广播的形式发送发现请求报文试图关联AC，AC收到AP的Discovery Request以后，会发送一个单播Discover Response 给AP，AP可以通过Discover Response中所带的AC优先级或者AC上当前AP的个数等，确定与哪个AC建立会话。
    - 广播方式：
- 当AP启动后，如果DHCP方式和DNS方式均未获得AC的IP或AP发出发现请求报文后未收到响应，则AP启动广播发现流程，以广播包方式发出发现请求报文。
- 接收到发现请求报文的AC检查该AP是否有接入本机的权限（已经授权的MAC地址或者序列号），如果有则发回响应。如果该AP没有接入权限，AC则拒绝请求。
- **广播发现方式只适用于AC/AP间为二层可达的网络场景**。
- AP与AC关联，完成CAPWAP隧道建立。包括数据隧道和控制隧道：
  - 数据隧道：AP接收的业务数据报文经过CAPWAP数据隧道集中到AC上转发。
  - 同时还可以选择对数据隧道进行数据传输层安全DTLS（Datagram Transport Layer Security）加密，使能DTLS加密功能后，CAPWAP数据报文都会经过DTLS加解密。
  - 控制隧道：通过CAPWAP控制隧道实现AP与AC之间的管理报文的交互。
  - 同时还可以选择对控制隧道进行数据传输层安全DTLS加密，使能DTLS加密功能后，CAPWAP控制报文都会经过DTLS加解密。

**AP接入控制**

- 在收到AP发送的Join Request报文之后，AC会进行AP合法性的认证，认证通过则添加相应的AP设备。
- AC上支持三种对AP的认证方式：
  - MAC认证
  - 序列号（SN）认证
  - 不认证

- AC上添加AP的方式有三种：
  - 离线导入AP：预先配置AP的MAC地址和SN，当AP与AC连接时，如果AC发现AP和预先增加的AP的MAC地址和SN匹配，则AC开始与AP建立连接。
  - 自动发现AP：当配置AP的认证模式为不认证或配置AP的认证模式为MAC或SN认证且将AP加入AP白名单中，则当AP与AC连接时，AP将被AC自动发现并正常上线。
  - 手工确认未认证列表中的AP：当配置AP的认证模式为MAC或SN认证，但AP没有离线导入且不在已设置的AP白名单中，则该AP会被记录到未授权的AP列表中。需要用户手工确认后，此AP才能正常上线。

**AP版本升级**

- AP根据收到的Join Response报文中的参数判断当前的系统软件版本是否与AC上指定的一致。

- 如果不一致，则AP通过发送Image Data Request报文请求软件版本，然后进行版本升级，升级方式包括AC模式、FTP模式和SFTP模式。

- AP在软件版本更新完成后重新启动，重复进行前面三个步骤。

- 在AC上给AP升级方式：

  - 自动升级：主要用于AP还未在AC中上线的场景。通常先配置好AP上线时的自动升级参数，然后再配置AP接入。AP在之后的上线过程中会自动完成升级。如果AP已经上线，配置完自动升级参数后，任意方式触发AP重启，AP也会进行自动升级。但相比于自动升级，使用在线升级方式升级能够减少业务中断的时间。

    - AC模式：AP升级时从AC上下载升级版本，适用于AP数量较少时的场景。

    - FTP模式：AP升级时从FTP服务器上下载升级版本，适用于网络安全性要求不是很高的文件传输场景中，采用明文传输数据，存在安全隐患。

    - SFTP模式：AP升级时从SFTP服务器上下载升级版本，适用于网络安全性要求高的场景，对传输数据进行了严格加密和完整性保护。

  - 在线升级：主要用于AP已经在AC中上线并已承载了WLAN业务的场景。

  - 定时升级：主要用于AP已经在AC中上线并已承载了WLAN业务的场景。通常指定在网络访问量少的时间段升级。

**CAPWAP隧道维持**

- 数据隧道维持：
  - AP与AC之间交互Keepalive **(UDP端口号为5247)**报文来检测数据隧道的连通状态。
- 控制隧道维持：
  - AP与AC交互Echo **(UDP端口号为5246)**报文来检测控制隧道的连通状态。

**CAPWAP隧道可以实现：**

- AP与AC间的状态维护；

- AC对AP进行管理和业务配置下发；

- 业务数据经过CAPWAP隧道集中到AC上转发。

#### AC预先配置

**为确保AP能够上线，AC需预先配置如下内容**

![image-20220722134706037](./assets/image-20220722134706037.png)

- 域管理模板：
  - 域管理模板提供对AP的国家码、调优信道集合和调优带宽等的配置
  - 国家码用来标识AP射频所在的国家，不同国家码规定了不同的AP射频特性，包括AP的发送功率、支持的信道等。配置国家码是为了使AP的射频特性符合不同国家或区域的法律法规要求。

- 配置AC的源接口或源地址：
  - 每台AC都必须唯一指定一个IP地址、VLANIF接口或者Loopback接口，该AC设备下挂接的AP学习到此IP地址或者此接口下配置的IP地址，用于AC和AP间的通信。此IP地址或者接口称为源地址或源接口。
  - 只有为每台AC指定唯一一个源接口或源地址，AP才能与AC建立CAPWAP隧道。
  - 设备支持使用VLANIF接口或Loopback接口作为源接口，支持使用VLANIF接口或Loopback接口下的IP地址作为源地址。

- 添加AP设备：即配置AP认证模式，AP上线
  - 添加AP有三种方式：离线导入AP、自动发现AP以及手工确认未认证列表中的AP。

### WLAN业务配置下发

- AP上线后，会主动向AC发送Configuration Status Request报文，该信息中包含了现有AP的配置，为了做AP的现有配置和AC设定配置的匹配检查。当AP的当前配置与AC要求不符合时，AC会通过Configuration Status Response通知AP。

说明：AP上线后，首先会主动向AC获取当前配置，而后统一由AC对AP进行集中管理和业务配置下发。

- WLAN业务配置下发：
- AC向AP发送Configuration Update Request请求消息，
  - AP回应Configuration Update Response消息，
- AC再将AP的业务配置信息下发给AP。

#### 配置模板

![配置模板](./assets/image-20220722141228.png)

#### VAP模板

![VAP模板](./assets/image-2022-07-22 142812.png)

- VAP模板：通过配置VAP模板下的参数，使AP实现为STA提供不同无线业务服务的能力。
  - VAP模板能够引用：SSID模板和安全模板。

- SSID模板：主要用于配置WLAN网络的SSID名称，还可以配置其他功能，主要包括如下功能：
  - 隐藏SSID功能：用户在创建无线网络时，为了保护无线网络的安全，可以对无线网络名称进行隐藏设置。这样，只有知道网络名称的无线用户才能连接到这个无线网络中。
  - 单个VAP下能够关联成功的最大用户数：单个VAP下接入的用户数越多，每个用户能够使用的平均网络资源就越少，为了保证用户的上网体验，可以根据实际的网络状况配置合理的最大用户接入数。
  - 用户数达到最大时自动隐藏SSID的功能：使能用户数达到最大时自动隐藏SSID的功能后，当WLAN网络下接入的用户数达到最大时，SSID会被隐藏，新用户将无法搜索到SSID。

- 安全模板：配置WLAN安全策略，可以对无线终端进行身份验证，对用户的报文进行加密，保护WLAN网络和用户的安全。
  - WLAN安全策略支持开放认证、WEP、WPA/WPA2-PSK、WPA/WPA2-802.1X等，在安全模板中选择其中一种进行配置。

- 数据转发方式：
  - 控制报文是通过CAPWAP的控制隧道转发的，
  - 用户的数据报文分为隧道转发（又称为“集中转发”）方式、直接转发（又称为“本地转发”）方式。

- 业务VLAN：
  - 由于WLAN无线网络灵活的接入方式，STA可能会在某个地点（例如办公区入口或体育场馆入口）集中接入到同一个WLAN无线网络中，然后漫游到其它AP覆盖的无线网络环境下。
  - 业务VLAN配置为单个VLAN时，在接入STA数众多的区域容易出现IP地址资源不足、而其它区域IP地址资源浪费的情况。
  - 业务VLAN配置为VLAN pool时，可以在VLAN pool中加入多个VLAN，然后通过将VLAN pool配置为VAP的业务VLAN，实现一个SSID能够同时支持多个业务VLAN。新接入的STA会被动态的分配到VLAN pool中的各个VLAN中，减少了单个VLAN下的STA数目，缩小了广播域；同时每个VLAN尽量均匀的分配IP地址，减少了IP地址的浪费。

### STA接入

STA接入过程分为六个阶段：扫描阶段、链路认证阶段、关联阶段、接入认证阶段、DHCP、用户认证。

**扫描**

- 主动扫描

  - 携带有指定SSID的主动扫描方式：适用于STA通过主动扫描接入指定的无线网络。
  - 客户端发送携带有指定SSID的Probe Request：
    - STA依次在每个信道发出Probe Request帧，寻找与STA有相同SSID的AP，只有能够提供指定SSID无线服务的AP接收到该探测请求后才回复探查响应。
  - 携带空SSID的主动扫描方式：适用于STA通过主动扫描可以获知是否存在可使用的无线服务。
      - 客户端发送广播Probe Request，客户端会定期地在其支持的信道列表中，发送Probe Request帧扫描无线网络。
      - 当AP收到Probe Request帧后，会回应Probe Response帧通告可以提供的无线网络信息。
- 被动扫描：
  - STA也支持被动扫描搜索无线网络。
  - 被动扫描是指客户端通过侦听AP定期发送的Beacon帧（信标帧，包含：SSID、支持速率等信息）发现周围的无线网络，缺省状态下AP发送Beacon帧的周期为100TUs（1TU=1024us）。

**链路认证**

- 开放系统认证：即不认证，任意STA都可以认证成功。

- 共享密钥认证：STA和AP预先配置相同的共享密钥，AP在链路认证过程验证两边的密钥配置是否相同。如果一致，则认证成功；否则，认证失败。

- 认证过程：

  - STA向AP发送认证请求（Authentication Request）。

  - AP随即生成一个“挑战短语（Challenge）”发给STA。
  - STA使用预先设置好的密钥加密“挑战短语”（EncryptedChallenge）并发给AP。
  - AP接收到经过加密的“挑战短语”，用预先设置好的密钥解密该消息，然后将解密后的“挑战短语”与之前发送给STA的进行比较。如果相同，认证成功；否则，认证失败。

**关联**

- 瘦接入点（FIT AP）架构中关联阶段处理过程：
  - STA向AP发送Association Request请求，请求帧中会携带STA自身的各种参数以及根据服务配置选择的各种参数（主要包括支持的速率、支持的信道、支持的QoS的能力等）。
  - AP收到Association Request请求帧后将其进行CAPWAP封装，并上报AC。
  - AC收到关联请求后判断是否需要进行用户的接入认证，并回应Association Response。
  - AP收到Association Response后将其进行CAPWAP解封装，并发给STA。

**接入认证**

- 接入认证即对用户进行区分，并在用户访问网络之前限制其访问权限。
- 接入认证相当于在无线侧的接口做认证，让终端用户有权限在无线链路上发送数据。
- 相对于链路认证，接入认证安全性更高。
- 主要包含：PSK认证和802.1X认证。
- 数据加密：
  - 除了用户接入认证外，对数据报文还需要使用加密的方式来保证数据安全，也是在接入认证阶段完成的。
  - 数据报文经过加密后，只有持有密钥的特定设备才可以对收到的报文进行解密，其他设备即使收到了报文，也因没有对应的密钥，无法对数据报文进行解密。

#### 无线接入安全协议

|         安全策略       | 链路认证方式 | 接入认证方式 | 数据加密方式 |                    说明                   |
| :--------------------------: | :--------------: | :--------------: | :--------------: | :--------------------------------------------: |
|           **WEP**            |       Open       |      不涉及      | 不加密或WEP加密  |                不安全的安全策略                |
| **WEP** |      Shared-key    Authentication      |     不涉及   | WEP加密 | 不安全的安全策略 |
|  **WPA/**  **WPA2-802.1X**   |       Open       |  802.1X（EAP）   |    TKIP或CCMP    |       安全性高的安全策略，适用于大型企业       |
|    **WPA/**  **WPA2-PSK**    |       Open       |       PSK        |    TKIP或CCMP    | 安全性高的安全策略，适用于中小型企业或家庭用户 |

WLAN安全提供了WEP、WPA、WPA2等安全策略机制。每种安全策略体现了一整套安全机制，包括无线链路建立时的链路认证方式，无线用户上线时的用户接入认证方式和无线用户传输数据业务时的数据加密方式。

- WEP（Wired Equivalent Privacy）
  - 有线等效加密WEP协议是由802.11标准定义的，用来保护无线局域网中的授权用户所传输的数据的安全性，防止这些数据被窃听。WEP的核心是采用RC4算法，加密密钥长度有64位、128位和152位，其中有24bit的IV（初始向量）是由系统产生的，所以WLAN服务端和WLAN客户端上配置的密钥长度是40位、104位或128位。WEP加密采用静态的密钥，接入同一SSID下的所有STA使用相同的密钥访问无线网络。

- WPA/WPA2 (Wi-Fi Protected Access)
  - 由于WEP共享密钥认证采用的是基于RC4对称流的加密算法，需要预先配置相同的静态密钥，无论从加密机制还是从加密算法本身，都很容易受到安全威胁。为了解决这个问题，在802.11i标准没有正式推出安全性更高的安全策略之前，Wi-Fi联盟推出了针对WEP改良的WPA。WPA的核心加密算法还是采用RC4，在WEP基础上提出了临时密钥完整性协议TKIP（Temporal Key Integrity Protocol）加密算法，采用了802.1X的身份验证框架，支持EAP-PEAP、EAP-TLS等认证方式。随后802.11i安全标准组织又推出WPA2，区别于WPA，WPA2采用安全性更高的区块密码锁链-信息真实性检查码协议CCMP（Counter Mode with CBC-MAC Protocol）加密算法。

- 为了实现更好的兼容性，在目前的实现中，WPA和WPA2都可以使用802.1X的接入认证、TKIP或CCMP的加密算法，他们之间的不同主要表现在协议报文格式上，在安全性上几乎没有差别。

**综上所述，WPA/WPA2安全策略涉及了链路认证阶段、接入认证阶段、密钥协商和数据加密阶段。**

**DHCP**

- STA获取到自身的IP地址，是STA正常上线的前提条件。

- 如果STA是通过DHCP方式获取IP地址，可以用AC设备或汇聚交换机作为DHCP服务器为STA分配IP地址。一般情况下使用汇聚交换机作为DHCP服务器。

**用户认证**

用户认证是一种“端到端”的安全结构，包括：802.1X认证、MAC认证和PoR1l认证。

- PoR1l认证也称Web认证，一般将PoR1l认证网站称为门户网站。

- 用户上网时，必须在门户网站进行认证。只有认证通过后才可以使用网络资源。

### WLAN业务数据转发

- CAPWAP中的数据包括控制报文（管理报文）和数据报文。

- 控制报文是通过CAPWAP的控制隧道转发的；

- 用户的数据报文分为隧道转发（又称为“集中转发”）方式和直接转发（又称为“本地转发”）方式。

**隧道转发方式：**

- 优点：AC集中转发数据报文，安全性好，方便集中管理和控制。

- 缺点：业务数据必须经过AC转发，报文转发效率比直接转发方式低，AC所受压力大。

**直接转发方式：**

- 优点：数据报文不需要经过AC转发，报文转发效率高，AC所受压力小。

- 缺点：业务数据不便于集中管理和控制。

## WLAN配置命令

```
#配置AP上线

#配置AC作为DHCP服务器，配置Option 43字段
[AC-ip-pool-pool1] option <code> [ sub-option <sub-code> ] 
{ ascii <ascii-string> | hex <hex-string> | 
cipher <cipher-string> | ip-address <ip-address> }

#创建域管理模板，并配置国家码
[AC] wlan 进入WLAN视图
[AC-wlan-view] regulatory-domain-profile name <profile-name> 创建域管理模板
[AC-wlan-regulate-domain-profile-name] country-code <country-code> 配置设备的国家码标识。
[AC-wlan-view] ap-group name <group-name> 创建AP组
AC-wlan-ap-group-group-name] regulatory-domain-profile <profile-name> 
将指定的域管理模板引用到AP或AP组。

#配置源接口或源地址
[AC] capwap source interface { loopback <loopback-number> | vlanif <vlan-id> } 
配置AC与AP建立CAPWAP隧道的源接口。
[AC] capwap source ip-address <ip-address> 配置AC的源IP地址。

#添加AP设备 – 离线导入AP
[AC-wlan-view] ap auth-mode { mac-auth | sn-auth } 
配置AP认证模式为MAC地址认证，或SN认证，缺省为MAC地址认证。
[AC-wlan-view] ap-id <ap-id> [ [ type-id <type-id> | ap-type <ap-type> ] 
{ ap-mac <ap-mac> | ap-sn <ap-sn> | ap-mac <ap-mac> ap-sn <ap-sn> } ]离线增加AP设备
[AC-wlan-ap-ap-id] ap-name <ap-name> 配置单个AP的名称
[AC-wlan-view] ap-id 0
[AC-wlan-ap-0] ap-group <ap-group> 配置AP所加入的组

# 检查AP上线结果
[AC] display ap { all | ap-group <ap-group> }} 查看AP信息

#配置射频

#进入射频视图
[AC-wlan-view] ap-id 0
[AC-wlan-ap-0] radio <radio-id>
[AC-wlan-radio-0]

#配置指定射频的工作带宽和信道
[AC-wlan-radio-0/0] channel {20mhz|40mhz-minus|40mhz-plus|80mhz|160mhz} <channel>
Warning: This action may cause service interruption. Continue?[Y/N]y
[AC-wlan-radio-0/0] channel 80+80mhz <channel1> <channel2>
Warning: This action may cause service interruption. Continue?[Y/N]y
配置AP组中所有AP或单个AP指定射频的工作带宽和信道。

#配置天线的增益
[AC-wlan-radio-0/0] antenna-gain <antenna-gain> 整数类型，取值范围：0～30，单位：dB
配置AP组中所有AP或单个AP指定射频的天线增益。

#配置射频的发射功率
[AC-wlan-radio-0/0] eirp <eirp> 整数形式，取值范围是1～127，单位：dBm
配置AP组中所有AP或单个AP指定射频的发射功率。
每个射频覆盖距离参数对应一组slottime、acktimeout和ctstimeout数值。
根据AP间的实际距离配置射频覆盖距离参数后，
AP设备根据此参数值调整对应的slottime、acktimeout和ctstimeout数值。

#配置射频覆盖距离参数
[AC-wlan-radio-0/0] coverage distance <distance> 整数类型，取值范围：1～400，单位为100m。
配置AP组中所有AP或单个AP指定射频的射频覆盖距离参数。

#配置射频工作的频段
[AC-wlan-radio-0/0] frequency { 2.4g | 5g }
缺省情况下，射频0工作在2.4GHz频段，射频2工作在5GHz频段

#创建射频模板
[AC-wlan-view] radio-2g-profile name <profile-name> 创建2G射频模板

#引用射频模板
[AC-wlan-view] ap-group name <group-name>
[AC-wlan-ap-group-group-name] radio-2g-profile <profile-nam>e radio { <radio-id> | all }
在AP组中，将指定的2G射频模板引用到2G射频。

#配置VAP

#创建VAP模板
[AC-wlan-view] vap-profile name <profile-name> 创建VAP模板

#配置数据转发方式
[AC-wlan-vap-prof-profile-name] forward-mode { direct-forward | tunnel }
配置VAP模板下的数据转发方式，可以是直接转发或隧道转发。

#配置业务VLAN
[AC] vlan pool <pool-name> 创建VLAN pool
[AC-wlan-vap-prof-profile-name] service-vlan {vlan-id <vlan-id>|vlan-pool <pool-name>}
配置VAP的业务VLAN。

#配置安全模板
[AC-wlan-view] security-profile name <profile-name> 创建安全模板
缺省情况下，系统已经创建名称为default、default-wds和default-mesh的安全模板。
[AC-wlan-vap-prof-profile-name] security-profile <profile-name> 在指定VAP模板中引用安全模板。

#配置SSID模板
[AC-wlan-view] ssid-profile name <profile-name> 创建SSID模板
缺省情况下，系统上存在名为default的SSID模板。
[AC-wlan-ssid-prof-profile-name] ssid <ssid> 
配置当前SSID模板中的服务组合识别码SSID（Service Set Identifier）。
[AC-wlan-vap-prof-profile-name] ssid-profile <profile-name> 在指定VAP模板中引用SSID模板。

#引用VAP模板
[AC-wlan-view] ap-group name <group-name>
[AC-wlan-ap-group-group-name] vap-profile <rofile-name> 
wlan <wlan-id> radio { <radio-id> | all } 
[ service-vlan { vlan-id <vlan-id> | vlan-pool <pool-name> } ]
在AP组中，将指定的VAP模板引用到射频

#查看VAP信息
[AC] display vap { ap-group <ap-group-name> | 
{ ap-name <ap-name> | ap-id <ap-id> } 
[ radio <radio-id> ] } [ ssid <ssid> ]
[AC] display vap { all | ssid <ssid> }
```

## 新一代WLAN解决方案

**全场景**

- 面对复杂多样的应用场景，采用场景定制化解决方案

- 园区网络、分支网络均有完整的WLAN部署、管理方案

**大带宽**

- 支持802.11ac wave2协议，双5G射频覆盖，无线接入带宽最高可达3.46 Gbps

- 华为主导制定下一代802.11ax标准（Wi-Fi 6），单5G速率高达9.6 Gbps

- 支持无线漫游及WMM等多种无线QoS协议，保证业务质量

**高安全**

- 支持WPA/WPA2/WPA3/WAPI等主流认证/加密方式

- 支持无线入侵检测

- 可通过PoR1l、802.1x技术对用户进行进行身份认证，保护内网安全

**易部署**

- AP支持即插即用，自动升级，信道自主选择，设备速率和功率动态调整，支持负载均衡

- 物联网融合AP、内置高密天线AP等特色产品，简化安装，快速部署

- 支持云管理模式，AP采用双栈设计，本地管理与云管理平滑切换

### Wi-Fi 6 VS Wi-Fi 5

**大带宽（1024-QAM、8x8 MU-MIMO）**

带宽提升4倍，是按理论速率进行对比，目前所有Wi-Fi 5产品实现理论（wave2）速率为2.5G；Wi-Fi 6标准理论速率为9.6G。

**高并发（UL/DL OFDMA、UL/DL MU-MIMO）**

并发用户数提升4倍，实际测试人均2M情况下，Wi-Fi 5并发100用户，Wi-Fi 6并发用户400用户。

**低时延（OFDMA、Spatial Reuse）**

Wi-Fi 6中平均时延在20 ms左右（Wi-Fi 5中平均时延在30 ms左右），后面利用华为SmartRadio智能应用加速技术后，业务时延可再降低至10ms。

**低耗电（TWT、20MHz-Only）**

TWT：Wi-Fi 5不支持。

![image-20220722155648163](./assets/image-20220722155648163.png)

# 广域网

广域网技术的发展，伴随着带宽不断的升级：

- 早期出现的X.25只能提供64 kbit/s的带宽，
- 其后DDN（Digital Data Network，数字数据网）和FR（Frame Relay，帧中继）提供的带宽提高到2 Mbit/s，
- SDH（Synchronous Digital Hierachy，同步数字结构）和ATM（Asynchronous Transfer Mode，异步传输模式）进一步把带宽提升到10 Gbit/s，
- 最后发展到当前以IP为基础的10 Gbit/s甚至更高带宽的广域网络。

## 早期广域网技术概述

### 广域网与局域网的区别

- 局域网带宽高但是传输距离短，无法满足广域网长距离传输；

- 局域网带宽高但是传输距离短，无法满足广域网长距离传输；

- 局域网设备通常都是交换机，广域网设备大多都是路由器；

- 局域网属于某一个单位或者组织，广域网服务大多由ISP提供；

- 广域网与局域网一般仅在物理层和数据链路层采用不同的协议或技术，其他层次基本没有差异；

- 银行、政府、军队、大型公司的专用网络也属于广域网，且与Internet实现物理隔离；

- Internet只是广域网的一种，小企业借用Internet作为广域网连接。

### 早期广域网技术介绍

初期广域网常用的物理层标准有：

- EIA（Electronic Industries Alliance，电子工业协会）和TIA（Telecommunications Industry Association，电信工业协会）制定的公共物理层接口标准EIA/TIA-232（即RS-232）
-  ITU（International Telecommunication Union，国际电信联盟）制定的串行线路接口标准V.24和V.35
- 有关各种数字接口的物理和电气特性的G.703标准等。

**广域网常见的数据链路层标准有：**

- HDLC（High-level Data Link Control，高级数据链路控制）

- PPP（Point-to-Point Protocol，点到点协议）

- FR（Frame Relay，帧中继）

- ATM异步传输模式等

**其中：**

- HDLC协议是一种通用的协议，工作在数据链路层。数据报文加上头开销和尾开销后封装成HDLC帧，只支持在点到点的同步链路上的数据传输，不支持IP地址协商与认证，过于追求高可靠性，导致数据帧开销较大，传输效率较低。

- PPP协议工作在数据链路层，主要用在支持全双工的同、异步链路上，进行点到点之间的数据传输。由于它能够提供用户认证，易于扩充，并且支持同、异步通信，因而获得广泛应用。

- 帧中继是一种工业标准的、交换式的数据链路协议，通过使用无差错校验机制，加快了数据转发速度。

- ATM是建立在电路交换和分组交换基础上的一种面向连接的交换技术，ATM传送信息的基本载体是53 Byte固定长度ATM信元。

### 广域网络设备角色介绍

广域网络设备基本角色有三种，CE（Customer Edge，用户边缘设备） 、PE （Provider Edge，服务提供商边缘设备） 和P（Provider ，服务提供商设备） 。

**具体定义是：**

- CE：用户端连接服务提供商的边缘设备。CE连接一个或多个PE，实现用户接入。

- PE：服务提供商连接CE的边缘设备。PE同时连接CE和P设备，是重要的网络节点。

- P：服务提供商不连接任何CE的设备。

### 早期广域网技术的应用

早期的广域网技术主要是针对不同的物理链路类型，在数据链路层进行不同的二层封装。

- 在**CE与PE之间**常用的广域网封装协议有**PPP/HDLC/FR**等，用于解决用户接入广域网的长距离传输问题。

- 在**ISP内部**常用的广域网协议主要是**ATM**，它用于解决骨干网高速转发的问题。

## PPP

### PPP协议概述

- PPP（Point-to-Point Protocol，点到点协议）是一种常见的广域网数据链路层协议，主要用于在全双工的链路上进行点到点的数据传输封装。

- PPP提供了安全认证协议族PAP（Password Authentication Protocol，密码验证协议）和CHAP（Challenge Handshake Authentication Protocol，挑战握手认证协议）。

- PPP协议具有良好的扩展性，例如，当需要在以太网链路上承载PPP协议时，PPP可以扩展为PPPoE。

- PPP协议提供LCP（Link Control Protocol，链路控制协议），用于各种链路层参数的协商，例如最大接收单元，认证模式等。

- PPP协议提供各种NCP（Network Control Protocol，网络控制协议），如IPCP（IP Control Protocol ，IP控制协议），用于各网络层参数的协商，更好地支持了网络层协议。

### PPP链路建立流程

**PPP链路的建立有三个阶段的协商过程**

- 链路层协商：通过LCP报文进行链路参数协商，建立链路层连接。
- 认证协商（可选）：通过链路建立阶段协商的认证方式进行链路认证。
- 网络层协商：通过NCP协商来选择和配置一个网络层协议并进行网络层参数协商。

#### **PPP链路接口状态机**

正常PPP链路建立需要经历链路建立阶段、认证阶段和网络层协商阶段，详细过程如下：

- 通信双方开始建立PPP链路时，先进入到Establish阶段。

- 在Establish阶段，进行LCP协商：协商通信双方的MRU（Maximum Receive Unit，最大接收单元）、认证方式和魔术字（Magic Number）等选项。协商成功后进入Opened状态，表示底层链路已建立。

- 如果配置了认证，将进入Authenticate阶段。否则直接进入Network阶段。

- 在Authenticate阶段，会根据连接建立阶段协商的认证方式进行链路认证。认证方式有两种：PAP和CHAP。如果认证成功，进入Network阶段，否则进入Terminate阶段，拆除链路，LCP状态转为Down。

- 在Network阶段，PPP链路进行NCP协商。通过NCP协商来选择和配置一个网络层协议并进行网络层参数协商。最常见的NCP协议是IPCP，用来协商IP参数。

- 在Terminate阶段，如果所有的资源都被释放，通信双方将回到Dead阶段。

PPP运行过程中，可以随时中断连接，物理链路断开、认证失败、超时定时器时间到、管理员通过配置关闭连接等动作都可能导致链路进入Terminate阶段。

#### LCP报文格式

![image-20220722234227323](./assets/image-20220722234227323.png)

**PPP帧格式：**

- Flag字段标识一个物理帧的起始和结束，该字节为二进制序列01111110（0X7E）。

- PPP帧的Address字段字节固定为11111111 （0XFF），是一个广播地址。

- PPP数据帧的Control字段默认为00000011（0X03），表明为无序号帧。

- 帧校验序列（FCS）字段是个16 bit的校验和，用于检查PPP帧的完整性。

- Protocol字段用来说明PPP所封装的协议报文类型，0XC021代表LCP报文，0XC023代表PAP报文，0XC223代表CHAP报文。

- Information字段包含Protocol字段中指定协议的内容，该字段的最大长度被称为最大接收单元MRU，缺省值为1500。

- 当Protocol字段为0XC021时，Information结构如下：

  - Identifier字段为1个字节，用来匹配请求和响应。

  - Length域的值就是该LCP报文的总字节数据。

  - Data字段则承载各种TLV（Type/Length/Value）参数用于协商配置选项，包括最大接收单元，认证协议等等。

**LCP报文携带的一些常见的配置参数有MRU、认证协议和魔术字。**

- 在VRP（Versatile Routing Platform，通用路由平台）平台上，MRU参数使用接口上配置的MTU（Maximum Transmission Unit，最大传输单元）值来表示。

- 常用的PPP认证协议有PAP和CHAP，一条PPP链路的两端可以使用不同的认证协议认证对端，但是被认证方必须支持认证方要求使用的认证协议并正确配置用户名和密码等认证信息。

- LCP使用魔术字来检测链路环路和其他异常情况。魔术字是随机产生的一个数字，随机机制需要保证两端产生相同魔术字的可能性几乎为0。

#### LCP协商过程

**正常协商**

LCP协商由不同的LCP报文交互完成。协商由任意一方发送**Configure-Request**报文发起。如果对端接收此报文且参数匹配，则通过回复**Configure-Ack**响应协商成功。

- R1首先发送一个Configure-Request报文，此报文中包含R1上配置的链路层参数
- 当R2收到此Configure-Request报文之后，如果R2能识别并接受此报文中的所有参数，则向R1回应一个Configure-Ack报文。
- 同样的，R2也需要向R1发送Configure-Request报文，使R1检测R2上的参数是不是可接受的。

- R1在没有收到Configure-Ack报文的情况下，会每隔3秒重传一次Configure-Request报文，如果连续10次发送Configure-Request报文仍然没有收到Configure-Ack报文，则认为对端不可用，停止发送Configure-Request报文。

**参数不匹配**

在LCP报文交互中出现LCP参数不匹配时，接收方回复**Configure-Nak**响应告知对端修改参数然后重新协商。

- 当R2收到R1发送的Configure-Request报文之后，如果R2能识别此报文中携带的所有链路层参数，但是认为部分或全部参数的取值不能接受，即参数的取值协商不成功，则R2需要向R1回应一个Configure-Nak报文。

- 在这个Configure-Nak报文中，只包含不能接受的链路层参数，并且此报文所包含的链路层参数将被修改为R2上可以接受的取值（或取值范围）。

- 在收到Configure-Nak报文之后，R1需要根据此报文中的链路层参数重新选择本地配置的其他参数，并重新发送一个Configure-Request。

**参数不识别**

在LCP报文交互中出现LCP参数不识别时，接收方回复**Configure-Reject**响应告知对端删除不识别的参数然后重新协商。

- 当R2收到R1发送的Configure-Request报文之后，如果R2不能识别此报文中携带的部分或全部链路层参数，则R2需要向R1回应一个Configure-Reject报文。在此Configure-Reject报文中，只包含不能被识别的链路层参数。

- 在收到Configure-Reject报文之后，R1需要向R2重新发送一个Configure-Request报文，在新的Configure-Request报文中，不再包含不被对端（R2）识别的参数。

#### PPP认证模式

**PAP**

- LCP协商完成后，认证方要求被认证方使用PAP进行认证。

- PAP认证协议为**两次握手**认证协议，密码以明文方式在链路上发送，过程如下：
  - 被认证方将配置的用户名和密码信息使用Authenticate-Request报文以明文方式发送给认证方。
  - 认证方收到被认证方发送的用户名和密码信息之后，根据本地配置的用户名和密码数据库检查用户名和密码信息是否匹配；如果匹配，则返回Authenticate-Ack报文，表示认证成功。否则，返回Authenticate-Nak报文，表示认证失败。

**CHAP**

- LCP协商完成后，认证方要求被认证方使用CHAP进行认证。

- CHAP认证过程需要**三次**报文的交互。过程如下：
  - 认证方主动发起认证请求，认证方向被认证方发送Challenge报文，报文内包含随机数（Random）和ID。
  - 被认证方收到此Challenge报文之后，进行一次加密运算，运算公式为MD5{ ID＋随机数＋密码}，意思是将Identifier、随机数和密码三部分连成一个字符串，然后对此字符串做MD5运算，得到一个16 Byte长的摘要信息，然后将此摘要信息和端口上配置的CHAP用户名一起封装在Response报文中发回认证方。
  - 认证方接收到被认证方发送的Response报文之后，按照其中的用户名在本地查找相应的密码信息，得到密码信息之后，进行一次加密运算，运算方式和被认证方的加密运算方式相同；然后将加密运算得到的摘要信息和Response报文中封装的摘要信息做比较，相同则认证成功，不相同则认证失败。
  - 使用CHAP认证方式时，被认证方的密码是被加密后才进行传输的，这样就极大的提高了安全性。

**加密算法声明**

- 使用加密算法时，MD5（数字签名场景和口令加密）加密算法安全性低，存在安全风险，在协议支持的加密算法选择范围内，建议使用更安全的加密算法，例如**AES/RSA（2048位以上）/SHA2/HMAC-SHA2**。

#### NCP协商

NCP主要用来建立和配置不同的网络层协议，协商在该数据链路上所传输的数据包的格式与类型。常见的有IPCP等。

- 静态IP地址商过程如下：
  - 每一端都要发送Configure-Request报文，在此报文中包含本地配置的IP地址；
  -  每一端接收到此Configure-Request报文之后，检查其中的IP地址，如果IP地址是一个合法的单播IP地址，而且和本地配置的IP地址不同（没有IP冲突），则认为对端可以使用该地址，回应一个Configure-Ack报文。

- 动态协商IP地址的过程如下：
  - R1向R2发送一个Configure-Request报文，此报文中会包含一个IP地址0.0.0.0，表示向对端请求IP地址；
  - R2收到上述Configure-Request报文后，认为其中包含的地址（0.0.0.0）不合法，使用Configure-Nak回应一个新的IP地址10.1.1.1；
  - R1收到此Configure-Nak报文之后，更新本地IP地址，并重新发送一个Configure-Request报文，包含新的IP地址10.1.1.1；
  - R2收到Configure-Request报文后，认为其中包含的IP地址为合法地址，回应一个Configure-Ack报文；
  - 同时，R2也要向R1发送Configure-Request报文请求使用地址10.1.1.2，R1认为此地址合法，回应Configure-Ack报文。

- 静态IP地址协商需要手动在链路两端配置IP地址
- 动态IP地址协商支持PPP链路一端为对端配置IP地址。

### PPP配置命令

```
[Huawei-Serial0/0/0]link-protocol ppp 配置接口封装ppp协议
[Huawei-Serial0/0/0]ppp timer negotiate <seconds> 配置协商超时时间间隔，超时重发

#配置验证方以PAP方式认证对端
[Huawei]aaa
[Huawei-aaa]local-user <user-name> password {cipher|irreversible-cipher} <pwd>
[Huawei-aaa]local-user <user-name> service-type ppp
[Huawei-Serial0/0/0]ppp authentication-mode pap (接口视图)
#配置被验证方以PAP方式被对端认证
[Huawei-Serial0/0/0]ppp pap local-user <user-name> password {cipher|simple} <pwd>

#配置验证方以CHAP方式认证对端
[Huawei]aaa
[Huawei-aaa]local-user <user-name> password {cipher|irreversible-cipher} <pwd>
[Huawei-aaa]local-user <user-name> service-type ppp
[Huawei-Serial0/0/0] ppp authentication-mode chap (接口视图)
#配置被验证方以CHAP方式被对端认证
[Huawei-Serial0/0/0]ppp chap local-user <user-name>
[Huawei-Serial0/0/0]ppp chap password {cipher|simple} <pwd>
```

## PPPoE

### PPPoE概述

- PPPoE（PPP over Ethernet，以太网承载PPP协议）是一种把PPP帧封装到以太网帧中的链路层协议。
- PPPoE可以使以太网网络中的多台主机连接到远端的宽带接入服务器。

- PPPoE集中了PPP和Ethernet两个技术的优点。既有以太网的组网灵活优势，又可以利用PPP协议实现认证、计费等功能

PPPoE帧结构：DMAC+SMAC+Eth-Type+PPPoE-Packet+FCS

### PPPoE会话建立

PPPoE的会话建立有三个阶段，PPPoE发现阶段、PPPoE会话阶段和PPPoE终结阶段。

- PPPoE发现：PPPoE协商——用户接入，创建PPPoE虚拟链路
- PPPoE会话：PPP协商——包括LCP协商，PAP/CHAP认证，NCP协商等阶段
- PPPoE终结：PPPoE断开——用户下线，客户端断开连接或服务端断开连接

#### PPPoE报文

![image-20220723002903027](./assets/image-20220723002903027.png)

**PPPoE报文封装在Ethernet帧中，Ethernet中各字段解释如下：**

- DMAC：表示目的设备的MAC地址，通常为以太网单播目的地址或者以太网广播地址（0xFFFFFFFF）。

- SMAC：表示源设备的以太网MAC地址。

- Eth-Type：表示协议类型字段，当值为**0x8863**时表示承载的是**PPPoE发现阶段**的报文。当值为**0x8864**时表示承载的是**PPPoE会话阶段**的报文。

**PPPoE字段中的各个字段解释如下：**

- VER：表示PPPoE版本号，值为0x01。

- Type：表示类型，值为0x01。

- Code：表示PPPoE报文类型，不同取值标识不同的PPPoE报文类型。

- PPPoE会话ID，与以太网SMAC和DMAC一起定义了一个PPPoE会话。

- Length：表示PPPoE报文的长度。

#### PPPoE发现阶段

PPPoE协议发现有四个步骤：客户端发送请求、服务端响应请求、客户端确认响应和建立会话。

- PPPoE客户端在本地以太网中广播一个PADI报文，此PADI报文中包含了客户端需要的服务信息。
  - PADI报文的目的MAC地址是一个广播地址，Code字段为0x09，Session ID字段为0x0000。
  - 所有PPPoE服务器端收到PADI报文之后，会将报文中所请求的服务与自己能够提供的服务进行比较。

- 如果服务器端可以提供客户端请求的服务，就会回复一个PADO报文。
  - PADO报文的目的地址是发送PADI报文的客户端MAC地址，Code字段为0x07，Session ID字段为0x0000。

- 客户端可能会收到多个PADO报文，此时将选择最先收到的PADO报文对应的PPPoE服务器端，并发送一个PADR报文给这个服务器端。
  - PADR报文的目的地址是选中的服务器端的MAC地址，Code字段为0x19，Session ID字段为0x0000。

- PPPoE服务器端收到PADR报文后，会生成一个唯一的Session ID来标识和PPPoE客户端的会话，并发送PADS报文。
  - PADS报文的目的地址是PPPoE客户端的MAC地址，Code字段为0x65，Session ID字段是PPPoE服务器端为本PPPoE会话产生的Session ID。

- 会话建立成功后，PPPoE客户端和服务器端进入PPPoE会话阶段。

#### PPPoE会话阶段

PPPoE会话阶段会进行PPP协商，分为LCP协商、认证协商、NCP协商三个阶段。

PPPoE会话阶段可分为两部分：PPP协商阶段和PPP报文传输阶段。

- PPPoE Session上的PPP协商和普通的PPP协商方式一致，分为LCP、认证、NCP三个阶段。
  - LCP阶段主要完成建立、配置和检测数据链路连接。
  - LCP协商成功后，开始进行认证，认证协议类型由LCP协商结果决定。
  - 认证成功后，PPP进入NCP阶段，NCP是一个协议族，用于配置不同的网络层协议，常用的是IP控制协议（IPCP），它负责配置用户的IP地址和DNS服务器地址等。

- PPPoE Session的PPP协商成功后，就可以承载PPP数据报文。在这一阶段传输的数据包中必须包含在发现阶段确定的Session ID并保持不变。

#### PPPoE会话终结阶段

- 当PPPoE客户端希望关闭连接时，会向PPPoE服务器端发送一个PADT报文，用于关闭连接。

- 同样，如果PPPoE服务器端希望关闭连接时，也会向PPPoE客户端发送一个PADT报文。

- 在PADT报文中，目的MAC地址为单播地址，Session ID为希望关闭的连接的Session ID。一旦收到一个PADT报文之后，连接随即关闭。

### PPPoE配置命令

```
[Huawei] dialer-rule 通过拨号规则配置发起PPPoE会话条件
[Huawei-Dialer1]dialer user <username> 配置拨号接口用户名，必须与对端服务器相同
[Huawei-Dialer1]dialer-group <group-num> 将接口置于一个拨号访问组
[Huawei-Dialer1]dialer-bundle <number> 指定当前拨号接口使用的拨号绑定
[Huawei-Ethernet0/0/0]pppoe-client dial-bundle-number <num> 将物理端口与dialer-bundle进行绑定

#配置实例
#PPPoE客户端
#创建拨号接口并配置被认证方用户名和密码
[R1]dialer-rule 
[R1-dialer-rule]dialer-rule 1 ip permit
[R1-dialer-rule]quit
[R1]interface dialer 1 
[R1-Dialer1] dialer user enterprise
[R1-Dialer1] dialer-group 1 
[R1-Dialer1] dialer bundle 1
[R1-Dialer1] ppp chap user enterprise@huawei
[R1-Dialer1] ppp chap password cipher huawei123
[R1-Dialer1] ip address ppp-negotiate
#将拨号接口绑定出接口
[R1]interface GigabitEthernet 0/0/1 
[R1-GigabitEthernet0/0/1]pppoe-client dial-bundle-number 1 
[R1-GigabitEthernet0/0/1]quit
#配置本端到达服务器端的缺省路由
[R1]ip route-static 0.0.0.0  0.0.0.0  dialer 1

#PPPoE服务器端
#创建地址池与虚拟模板
[R2]ip pool pool1	#创建地址池，指定分配的IP地址和网关
[R2-ip-pool-pool1]network 192.168.1.0 mask 255.255.255.0
[R2-ip-pool-pool1]gateway-list 192.168.1.254
[R2]interface Virtual-Template 1          #创建虚拟模板接口
[R2-Virtual-Template1]ppp authentication-mode chap 
[R2-Virtual-Template1]ip address 192.168.1.254 255.255.255.0
[R2-Virtual-Template1]remote address pool pool1
#将物理接口与虚拟模板绑定
[R2]interface GigabitEthernet 0/0/0
[R2-GigabitEthernet0/0/0]pppoe-server bind virtual-template 1
[R2-GigabitEthernet0/0/0]quit
#创建访问用户
[R2]aaa 	#添加认证用户信息
[R2-aaa]local-user huawei1 password cipher huawei123
[R2-aaa]local-user huawei1 service-type ppp

display interface Dialer 1  查看拨号接口详细信息
display pppoe-client session summary 查看PPPoE-client会话状态信息
```

**PPPoE客户端配置包括三个步骤。**

- 第一步配置一个拨号接口。
  - **dialer-rule**命令用于进入Dialer-rule视图，在该视图下，可以通过拨号规则来配置发起PPPoE会话的条件。
  - **interface dialer** *number*命令用来创建并进入Dialer接口。
  - **dialer user** *user-name*命令用于配置对端用户名，这个用户名必须与对端服务器上的PPP用户名相同。
  - **dialer-group** *group-number*命令用来将接口置于一个拨号访问组。
  - **dialer bundle** *number*命令用来指定Dialer接口使用的Dialer bundle。设备通过Dialer bundle将物理接口与拨号接口关联起来。

- 第二步是在接口上将Dialer Bundle和接口绑定：
  - **pppoe-client dial-bundle-number** *number*命令来实现Dialer Bundle和物理接口的绑定，用来指定PPPoE会话对应的Dialer Bundle，其中number是与PPPoE会话相对应的Dialer Bundle编号。

- 第三步配置一条缺省静态路由，该路由允许在路由表中没有相应匹配表项的流量都能通过拨号接口发起PPPoE会话。

**PPPoE服务器端配置**

- **interface virtual-template**命令用来创建虚拟模板接口，或者进入一个已经创建的虚拟模板接口视图。

- **pppoe-server bind**命令用来配置PPPoE接入用户上线绑定的虚拟模板接口。

## 广域网技术的发展

- 早期广域网常用的数据链路层协议包括PPP、HDLC和ATM等。
- 后期随着全网IP化的演进，基于IP技术的Internet快速普及，但基于最长匹配算法的IP技术必须使用软件查找路由，转发性能低下，因此IP技术的转发性能成为当时限制网络发展的瓶颈。

- MPLS（Multiprotocol Label Switching，多协议标记交换）最初是为了提高路由器的转发速度而提出的。
- 与传统IP路由方式相比，它在数据转发时，只在网络边缘解析IP报文头，后续节点只基于标签转发，而不用在每一跳都解析IP报文头，减少软件处理流程节约了处理时间。

- 随着路由器性能的提升，路由查找速度已经不是阻碍网络发展的瓶颈。
- 这使得MPLS在提高转发速度方面不再具备明显的优势。
- 但是MPLS支持多层标签和转发平面面向连接的特性，使其在VPN（Virtual Private Network，虚拟专用网）、TE（Traffic Engineering，流量工程）、QoS（Quality of Service，服务质量）等方面得到广泛应用。

### 传统IP路由转发

传统的IP转发采用的是逐跳转发。数据报文经过每一台路由器，都要被解封装查看报文网络层信息，然后根据路由最长匹配原则查找路由表指导报文转发。各路由器重复进行解封装查找路由表和再封装的过程，所以转发性能低。

**传统IP路由转发的特点：**

- 所有路由器需要知道全网的路由。

- 传统IP转发是面向无连接的，无法提供较好的端到端QoS保证。

### MPLS标签转发

**MPLS（Multiprotocol Label Switching）多协议标记交换**

- MPLS是一种IP骨干网技术。

- MPLS是一种隧道技术，在IP路由和控制协议的基础上，向网络层提供面向连接的交换。能够提供较好的QoS保证。

- MPLS标签指导报文转发的过程中，使用本地标签查找替代传统IP转发的路由查找，大大提高转发效率。

- MPLS转发过程中使用的标签，既可以通过手工静态配置，又可以通过动态标签分发协议分配。

**MPLS的标签分发有静态和动态两种方式，均面临着不同的问题：**

- 静态标签分发为手工配置。随着网络规模不断的扩大，网络拓扑易变化，静态手工配置标签不适应大型网络需求。

- 动态标签分发的问题，一方面在于部分动态标签协议本身并无算路能力，需依赖IGP进行路径计算，同时控制面协议复杂，设备之间需要发送大量的消息来维持邻居及路径状态，浪费了链路带宽及设备资源。另一方面部分标签分发协议虽然支持流量工程，但是配置复杂，不支持负载分担，需要大量协议报文维护路径正常工作；同时每台设备都是独立存在，只知道自己的状态，设备之间需要交互信令报文，也会浪费链路带宽及设备资源。

### Segment Routing

为解决传统IP转发和MPLS转发的问题，业界提出了SR （Segment Routing，分段路由）。

SR的转发机制有很大改进，主要体现在以下几个方面：

- 基于现有协议进行扩展：
  - 扩展后的IGP/BGP具有标签分发能力，因此网络中无需其他任何标签分发协议，实现协议简化。

- 引入源路由机制：
  - 基于源路由机制，支持通过控制器进行集中算路。

- 由业务来定义网络：
  - 业务驱动网络，由应用提出需求（时延、带宽、丢包率等），控制器收集网络拓扑、带宽利用率、时延等信息，根据业务需求计算显式路径。

#### Segment Routing转发原理

- SR将网络路径分成一个个的段（Segment），并且为这些段分配SID（Segment ID）。

- SID的分配对象有两种，转发节点或者链路。本例中转发节点SID 1600X，X为路由器编号；链路SID 160XX，XX表示链路两端的节点编号。
- SID用于标识Segment，它的格式取决于具体的技术实现，例如可以使用MPLS标签、MPLS标签空间中的索引、IPv6报文头部。例如使用MPLS标签被称为SR-MPLS，使用IPv6被称为SRv6。

- 链路和网络节点的SID有序排列形成段序列（Segment List），它代表一条转发路径。SR由源节点将段序列编码在数据包头部，随数据包传输。SR的本质是指令，指引报文去哪里和怎么去。

- 接收端收到数据包后，对段序列进行解析，如果段序列的顶部段标识是本节点时，则弹出该标识，然后进行下一步处理；如果不是本节点，则使用ECMP（Equal Cost Multiple Path）方式将数据包转发到下一节点。

#### SR的部署方式

SR的部署方式分可以以有无控制器配合区分。控制器配合方式由控制器收集信息，预留路径资源和计算路径，最后将结果下发到头结点，是更为推荐的部署方式。

PCEP：Path Computation Element Communication Protocol，路径计算单元通信协议

NETCONF：Network Configuration Protocol，网络配置协议

#### Segment Routing的应用

SR可以简易的指定的报文转发路径，在现网中可以为不同业务定义不同的路径。

# 网络管理与运维

网络管理是通过对网络中设备的管理，保证设备工作正常，使通信网络正常地运行，以提供高效、可靠和安全的通信服务，是通信网络的重要组成部分。

**网络管理（Network Management）分为两类：**

- 第一类是对网络应用程序、用户账号（例如文件的使用）和存取权限（许可）的管理。

- 第二类是对构成网络的硬件即网元的管理，包括防火墙、交换机、路由器等等。

NE（Network Element，网元）：即网络单元，包含硬件设备及运行其上的软件。

通常一个网络单元至少具有一块主控板，负责整个网络单元的管理和监控。主机软件运行在主控板上。

## 网络管理基本功能

OSI定义了网络管理的五大功能模型：

- **配置管理**（Configuration Management）：配置管理负责监控网络的配置信息，使网络管理人员可以生成、查询和修改硬件、软件的运行参数和条件，并可以进行相关业务的配置。

- **性能管理**（Performance Management）：性能管理以网络性能为准则，保证在使用较少网络资源和具有较小时延的前提下，网络能够提供可靠、连续的通信能力。

- **故障管理**（Fault Management）：故障管理的主要目标是确保网络始终可用，并在发生故障时尽快将其修复。

- **安全管理**（Security Management）：安全管理可以保护网络和系统免受未经授权的访问和安全攻击。

- **计费管理**（Accounting Management）：记录用户使用网络资源的情况并核收费用，同时也统计网络的利用率。

## 网络管理方式

- 传统网络管理：
  - Web网管方式：利用设备内置的Web服务器，为用户提供图形化的操作界面。用户需要从终端通过HTTPS（Hypertext Transfer Protocol Secure ，HTTPS 加密协定）登录到设备进行管理。
  - CLI方式：用户利用设备提供的命令行，通过Console口、Telnet或SSH等方式登录到设备，对设备进行管理与维护。此方式可以实现对设备的精细化管理，但是要求用户熟悉命令行。
  - 基于SNMP集中管理：SNMP（Simple Network Management Protocol，简单网络管理协议）提供了一种通过运行网络管理软件的中心计算机（即网络管理站）来管理网元（如路由器、交换机）的方法。此方式可以实现对全网设备集中式、统一化管理，大大提升了管理效率。

- 基于iMaster NCE的网络管理：
  - iMaster NCE是集管理、控制、分析和AI智能功能于一体的网络自动化与智能化平台，包括四大关键能力：全生命周期自动化、基于大数据和AI的智能闭环、开放可编程使能场景化APP生态、超大容量全云化平台。
  - iMaster NCE采用NETCONF（Network Configuration Protocol，网络配置协议）、RESTCONF等协议对设备下发配置，使用Telemetry监控网络流量。

### 传统网络管理

#### 通过CLI或Web进行管理

当网络规模较小时，CLI和Web方式是常见的网络管理方式。

- 网络管理员可以通过HTTPS、Telnet、Console等方式登录设备后，对设备逐一进行管理。

- 这种管理方式不需要在网络中安装任何程序或部署服务器，成本较低。

- 网络管理员自身需要熟练掌握网络理论知识、各设备厂商网络配置命令。

- 当网络规模较大，网络拓扑较为复杂时，这种方式的局限性较大。

#### 基于SNMP的集中式管理

SNMP（Simple Network Management Protocol，简单网络管理协议）是广泛用于TCP/IP网络的网络管理标准协议，提供了一种通过运行网络管理软件的中心计算机，即NMS（Network Management Station，网络管理工作站）来管理网元的方法。

- 网络管理员可以利用NMS在网络上的任意节点完成信息查询、信息修改和故障排查等工作，提升工作效率。

- 屏蔽了不同产品之间的差异，实现了不同种类和厂商的网络设备之间的统一管理。

**SNMP共有三个版本：SNMPv1、SNMPv2c和SNMPv3。**

- 1990年5月，RFC 1157定义了SNMP的第一个版本SNMPv1。RFC 1157提供了一种监控和管理计算机网络的系统方法。SNMPv1基于团体名认证，安全性较差，且返回报文的错误码也较少。

- 1996年，IETF颁布了RFC 1901，定义了SNMP的第二个版本SNMPv2c。SNMPv2c中引入了GetBulk和Inform操作，支持更多的标准错误码信息，支持更多的数据类型（Counter64、Counter32）。

- 鉴于SNMPv2c在安全性方面没有得到改善，IETF又颁布了SNMPv3的版本，提供了基于USM（User-Based Security Model，用户安全模块）的认证加密和VACM（View-based Access Control Model，基于视图的访问控制模型）功能。

**SNMP典型架构**

- 在基于SNMP进行管理的网络中，NMS是整个网络的网管中心，在它之上运行管理进程。每个被管理设备需要运行代理（Agent）进程。管理进程和代理进程利用SNMP报文进行通信。

- NMS是一个采用SNMP协议对网络设备进行管理/监控的系统，运行在NMS服务器上。

- 被管理设备是网络中接受NMS管理的设备。

- 代理进程运行于被管理设备上，用于维护被管理设备的信息数据并响应来自NMS的请求，把管理数据汇报给发送请求的NMS。

NMS和被管理设备的信息交互分为两种：

- NMS通过SNMP协议给被管理设备发送修改配置信息请求或查询配置信息请求。被管理设备上运行的代理进程根据NMS的请求消息做出响应。

- 被管理设备可以主动向NMS上报告警信息（Trap）以便网络管理员及时发现故障。

- 被管理对象（Managed object）：每一个设备可能包含多个被管理对象，被管理对象可以是设备中的某个硬件，也可以是在硬件、软件（如路由选择协议）上配置的参数集合。

- SNMP规定通过MIB（Management Information Base，管理信息库）去描述可管理实体的一组对象。

**MIB**

MIB是一个数据库，指明了被管理设备所维护的变量（即能够被代理进程查询和设置的信息）。

**MIB在数据库中定义了被管理设备的一系列属性：**

- 对象标识符（Object IDentifier，OID）

- 对象的状态

- 对象的访问权限

- 对象的数据类型等

MIB给出了一个数据结构，包含了网络中所有可能的被管理对象的集合。因为数据结构与树相似，MIB又被称为对象命名树。

**MIB可以分为公有MIB和私有MIB两种。**

- 公有MIB：一般由RFC定义，主要用来对各种公有协议进行结构化设计和接口标准化处理。大多数的设备制造商都需要按照RFC的定义来提供SNMP接口。

- 私有MIB：是公有MIB的必要补充，当公司自行开发私有协议或者特有功能时，可以利用私有MIB来完善SNMP接口的管理功能，同时对第三方网管软件管理存在私有协议或特有功能的设备提供支持。如华为公司企业节点为：1.3.6.1.4.1.2011。

**MIB节点的最大访问权限表明网管能够通过该MIB节点对设备进行的操作：**

- not-accessible：无法进行任何操作。

- read-only：可以读取信息。

- read-write：可以读取信息和修改配置。

- read-create：可以读取信息、修改配置、新增配置和删除配置。

设备在生成告警时，不仅会上报当前发生的告警类型，同时会绑定一些变量。比如当发送接口linkDown告警时，需要同时绑定接口索引，接口的当前配置状态等变量。

**SNMP管理模型**

- 查询/修改操作：
  - NMS作为管理者，向代理进程发送SNMP请求报文。
  - 代理进程通过设备端的MIB找到所要查询或修改的信息，向NMS发送SNMP响应报文。

- 告警操作：
  - 设备端的模块由于达到模块定义的告警触发条件，通过代理进程向NMS发送消息，告知设备侧出现的情况，这样便于网络管理人员及时对网络中出现的情况进行处理。

#### SNMPv1

SNMPv1定义了5种协议操作：

- Get-Request：NMS从被管理设备的代理进程的MIB中提取一个或多个参数值。

- Get-Next-Request：NMS从代理进程的MIB中按照字典式排序提取下一个参数值。

- Set-Request：NMS设置代理进程MIB中的一个或多个参数值。

- Response：代理进程返回一个或多个参数值。它是前三种操作的响应操作。

- rap：代理进程主动向NMS发送报文，告知设备上发生的紧急或重要事件。

#### SNMPv2c

SNMPv2c新增了2种协议操作：

- GetBulk：相当于连续执行多次GetNext操作。在NMS上可以设置被管理设备在一次GetBulk报文交互时，执行GetNext操作的次数。

- Inform：被管理设备向NMS主动发送告警。与Trap告警不同的是，被管理设备发送Inform告警后，需要NMS进行接收确认。如果被管理设备没有收到确认信息则会将告警暂时保存在Inform缓存中，并且会重复发送该告警，直到NMS确认收到了该告警或者发送次数已经达到了最大重传次数。

#### SNMPv3

SNMPv3增加了身份验证和加密处理的功能。

- 身份验证：身份验证是指代理进程（NMS）接收到信息时首先必须确认信息是否来自有权限的NMS（代理进程）并且信息在传输过程中未被改变。

- 加密处理：SNMPv3报文中添加了报头数据和安全参数字段。比如当管理进程发出SNMPv3版本的Get-Request报文时可以携带用户名、密钥、加密参数等安全参数，代理进程回复Response报文时也采用加密的Response报文。这种安全加密机制特别适用于管理进程和代理进程之间需要经过公网传输数据的场景。

**SNMP的特点如下：**

-  简单：SNMP采用轮询机制，提供基本的功能集，适合快速、低价格的场景使用，而且SNMP以**UDP**报文为承载，因而得到绝大多数设备的支持。

- 强大：SNMP的目标是保证管理信息在任意两点传送，便于管理员在网络上的任何节点检索信息，进行故障排查。

- SNMPv1版本适用于小型网络。组网简单、安全性要求不高或网络环境比较安全且比较稳定的网络，比如校园网，小型企业网。

- SNMPv2c版本适用于大中型网络。安全性要求不高或者网络环境比较安全，但业务比较繁忙，有可能发生流量拥塞的网络。

- SNMPv3版本作为推荐版本，适用于各种规模的网络。尤其是对安全性要求较高，只有合法的管理员才能对网络设备进行管理的网络。

#### SNMP配置命令

```
#使能snmp代理
[Huawei]snmp-agent 
#配置SNMP版本，使用侧必须与管理侧一致
[Huawei]anmp-agent sys-info version [v1|v2c|v3] 
#创建或更新MIB视图的信息
[Huawei]snmp-agent mib-view <view-name> {exclude|include} <subtree-name> [mask <mask>] 

#增加一个新的SNMP组，将该组用户映射到SNMP视图
[Huawei]snmp-agent group v3 <group-name> {authentication|noauth|privacy} 
[read-view <view-name>|write-view <view-name>|notify-view <view-name>] 
用于SNMPv3版本中创建SNMP组，指定认证加密方式、只读视图、读写视图、通知视图

#为一个snmp组添加一个新用户
[Huawei]snmp-agent usm-user v3 <user-name> group <group-name> 
#配置SNMPv3用户认证密码
[Huawei]snmp-agent usm-user v3 <user-name> authentication-mode{md5|sha|sha2-256} 
#配置SNMPv3用户加密密码
[Huawei]snmp-agent usm-user v3 <user-name> privacy-mode {aes128|ses56} 

#配置设备发送Trap报文的参数信息
[Huawei]snmp-agent target-host trap-paramsname <paramsname> v3 
securityname <securityname> {authentication|noauth|privacy} 
#配置Trap报文的目的主机
[Huawei]snmp-agent target-host trap-hostname <hostname> address <ipv4-address> 
trap-paramsname <paramsname> [ notify-filter-profile <profile-name> ] 

#打开设备的所有告警开关
[Huawei]snmp-agent trap enable 
#配置发送告警的源接口。源接口必须是已经配置了IP地址的接口
[Huawei]snmp-agent trap source <interface-type>  <interface-number> 
```

## iMaster NCE

华为iMaster NCE是一款集管理、控制、分析和AI智能功能于一体的网络自动化与智能化平台。

- 在管理与控制方面，iMaster NCE支持：
  - CLI和SNMP等传统技术实现传统设备的管理和控制。
  - NETCONF（基于YANG模型）协议实现对支持SDN的网络的管理和控制。

- iMaster NCE通过SNMP、Telemetry等协议采集网络数据，结合AI算法进行大数据智能分析，通过Dashboard、报表等方式多维度呈现设备及网络状态、帮助运维人员快速发现设备及网络异常情况并处理，保障设备和网络的正常运作。

**iMaster NCE包含四大关键能力：**

- 全生命周期自动化：以统一的资源建模和数据共享服务为基础，提供跨多网络技术域的全生命周期的自动化能力，实现设备即插即用、网络即换即通、业务自助服务、故障自愈和风险预警。

- 基于大数据和AI的智能闭环：基于意图、自动化、分析和智能四大子引擎构建完整的智能化闭环系统。基于Telemetry采集并汇聚海量的网络数据，iMaster NCE实现实时网络态势感知，通过统一的数据建模构建基于大数据的网络全局分析和洞察，并注入基于华为30多年电信领域经验积累的AI算法，面向用户意图进行自动化闭环的分析、预测和决策，提升客户满意度，持续提升网络的智能化水平。

- 开放可编程使能场景化APP生态：iMaster NCE对外提供可编程的集成开发环境Design Studio和开发者社区，实现南向与第三方网络控制器或网络设备对接，北向与云端AI训练平台和IT应用快速集成，并支持客户灵活选购华为原生APP，客户自行开发或寻求第三方系统集成商的支持进行APP的创新与开发。

- 大容量全云化平台：基于Cloud Native的云化架构，iMaster NCE支持在私有云、公有云中运行，也支持On-premise部署模式，具备大容量和弹性可伸缩能力，支持大规模系统容量和用户接入，让网络从数据分散、多级运维的离线模式转变为数据共享、流程打通的在线模式。

### NETCONF

NETCONF（Network Configuration Protocol，网络配置协议），提供一套管理网络设备的机制。

用户可以使用这套机制增加、修改、删除网络设备的配置，获取网络设备的配置和状态信息。

**NETCONF有三个对象：**

- NETCONF客户端

- NETCONF服务器端

- NETCONF消息

**NETCONF规定客户端与服务器端之间的消息通信必须采用XML编码。**

- NETCONF客户端（Client）：Client 利用NETCONF协议对网络设备进行系统管理。一般由网络管理系统（NMS）作为NETCONF Client。Client向Server发送<rpc>请求，查询或修改一个或多个具体的参数值。Client可以接收Server发送的告警和事件，以获取被管理设备的状态。

- NETCONF服务器端（Server）：Server用于维护被管理设备的信息数据并响应Client的请求，把管理数据汇报给Client。一般由网络设备（例如交换机、路由器等）作为NETCONF Server。Server收到Client 的请求后会进行数据解析，并在CMF（Configuration Manager Frame，配置管理框架）的帮助下处理请求，然后给Client 返回响应。当设备发生故障或其他事件时，Server利用Notification机制将设备的告警和事件通知给Client，向网络管理系统报告设备的当前状态变化。

- Client与Server之间建立基于SSH（Secure Shell，安全外壳）或TLS（Transport Layer Security，传输层安全性协议）等安全传输协议的连接，然后通过Hello报文交换双方支持的能力后建立NETCONF会话，Client即可与Server之间进行交互请求，网络设备必须至少支持一个NETCONF会话。Client从运行的Server上获取的信息包括配置数据和状态数据。

**NETCONF的优势**

|   功能   |                           NETCONF                            |     SNMP     |   CLI    |
| :------: | :----------------------------------------------------------: | :----------: | :------: |
| 接口类型 | 机机接口：接口定义完善、规范、标准，便于接口控制和使用。 | 机机接口 | 人机接口 |
| 操作效率 | 高：基于对象建模，对象操作一次交互即可，支持过滤、批量等操作。 |  中   |  低    |
| 扩展能力 |  可以扩展协议私有能力。 |      弱      |   一般   |
| 事务处理 |   支持：试运行、出错回滚、配置回退等事务处理机制。    |  不支持    | 部分支持 |
| 安全传输 |   多种安全协议：SSH，TLS，BEEP/TLS，SOAP/HTTP/TLS   | 仅SNMPv3支持 | 支持SSH  |

NETCONF使用SSH实现安全传输，使用RPC（Remote Procedure Call，远程过程调用）实现客户端和服务器端的通信。

### YANG语言概述

YANG（Yet Another Next Generation）是一种数据建模语言，实现了NETCONF数据内容的标准化。

YANG模型定义了数据的层次化结构，可用于基于NETCONF的操作。建模对象包括配置、状态数据、远程过程调用和通知。它可以对NETCONF客户端和服务器端之间发送的所有数据进行一个完整的描述。

YANG起源于NETCONF，但不仅用于NETCONF。虽然统一了YANG建模语言，但是YANG文件没有统一。

- YANG文件可以简单分为三类：
  - 厂家私有YANG文件
  - IETF标准YANG
  - OpenConfig YANG

- YANG模型的最终呈现是.yang为后缀的文件。

- YANG模型的特点：
  - 基于层次化的树状结构建模。
  - 数据模型以模块和子模块呈现。
  - 可以和基于XML的语法的YIN（YANG Indepent Notation）模型无损转换。
  - 定义内置的数据类型和允许可扩展类型。

- 在NETCONF客户端（例如网管平台/SDN控制器）加载YANG文件。

- 通过YANG文件将数据转换为XML格式的NETCONF消息发送到设备。

- 在NETCONF服务器（例如路由器/交换机等）加载YANG文件。

- 通过YANG文件将接收到的XML格式的NETCONF消息转换为数据并做后续处理。

### Telemetry

- Telemetry也作Network Telemetry，即网络遥测技术，是一项远程地从物理设备或虚拟设备上高速采集数据的技术。

- 设备通过推模式（Push Mode）周期性地主动向采集器上送设备的接口流量统计、CPU或内存数据等信息，相对传统拉模式（Pull Mode）的一问一答式交互，提供了更实时更高速的数据采集功能。

- 业界也有一种看法，将SNMP认为是传统的Telemetry技术，把当前Telemetry叫做Streaming Telemetry或Model-Driven Telemetry。

- Telemetry将上送数据打包一起发送，提升传输效率。

# IPV6

## IPV6概述

- IANA，是负责全球互联网IP地址编号分配的机构。
- IANA将部分IPv4地址分配给大洲级的RIR，再由各RIR进行所辖区域内地址分配，五大RIR包括：
  - RIPE：Reseaux IP Europeans，欧洲IP地址注册中心，服务于欧洲、中东地区和中亚地区；
  - LACNIC：Latin American and Caribbean Internet Address Registry，拉丁美洲和加勒比海Internet地址注册中心，服务于中美、南美以及加勒比海地区；
  - ARIN：American Registry for Internet Numbers，美国Internet编号注册中心，服务于北美地区和部分加勒比海地区；
  - AFRINIC：Africa Network Information Centre，非洲网络信息中心，服务于非洲地区；
  - APNIC：Asia Pacific Network Information Centre，亚太互联网络信息中心，服务于亚洲和太平洋地区。

### IPV6优势

![image-20220723152357807](./assets/image-20220723152357807.png)

### IPV6基本包头

- IPv6包头由一个IPv6基本包头（必须存在）和多个扩展包头（可能不存在）组成。

- 基本包头提供报文转发的基本信息，会被转发路径上的所有设备解析。

![image-20220723152440780](./assets/image-20220723152440780.png)



**IPv6基本包头字段解释如下：**

- Version：版本号，长度为4 bit。对于IPv6，该值为6。

- Traffic Class：流类别，长度为8 bit。等同于IPv4中的ToS字段，表示IPv6数据包的类或优先级，主要应用于QoS。
- Flow Label：流标签，长度为20 bit。IPv6中的新增字段，用于区分实时流量，不同的流标签+源地址可以唯一确定一条数据流，中间网络设备可以根据这些信息更加高效率的区分数据流。
- Payload Length：有效载荷长度，长度为16 bit。有效载荷是指紧跟IPv6包头的数据包的其他部分（即扩展包头和上层协议数据单元）。
- Next Header：下一个包头，长度为8 bit。该字段定义紧跟在IPv6包头后面的第一个扩展包头（如果存在）的类型，或者上层协议数据单元中的协议类型（类似于IPv4的Protocol字段）。
- Hop Limit：跳数限制，长度为8 bit。该字段类似于IPv4中的Time to Live字段，它定义了IP数据包所能经过的最大跳数。每经过一个路由器，该数值减去1，当该字段的值为0时，数据包将被丢弃。
- Source Address：源地址，长度为128 bit。表示发送方的地址。
- Destination Address：目的地址，长度为128 bit。表示接收方的地址。

### IPV6扩展包头

![image-20220723152533142](./assets/image-20220723152533142.png)

- IPv4包头包含可选字段Options，内容涉及Security、Timestamp、Record route等，这些Options可以将IPv4包头长度从20 Byte扩充到60 Byte。携带这些Options的IPv4报文在转发过程中往往需要中间路由转发设备进行软件处理，对于性能是个很大的消耗，因此实际中也很少使用。

- IPv6将这些Options从IPv6基本包头中剥离，放到了扩展包头中，扩展包头被置于IPv6基本包头和上层协议数据单元之间。一个IPv6报文可以包含0个、1个或多个扩展包头，仅当需要路由器或目的节点做某些特殊处理时，才由发送方添加一个或多个扩展头。与IPv4不同，IPv6扩展头长度任意，不受40 Byte限制，这样便于日后扩充新增选项。这一特征加上选项的处理方式使得IPv6选项能得以真正的利用。但是为了提高处理选项头和传输层协议的性能，扩展包头总是8 Byte长度的整数倍。

- 当使用多个扩展包头时，前面包头的Next Header字段指明下一个扩展包头的类型，这样就形成了链状的包头列表。

- 当超过一种扩展包头被用在同一个IPv6报文里时，包头必须按照下列顺序出现：

  - 逐跳选项包头：主要用于为在传送路径上的每跳转发指定发送参数，传送路径上的每台中间节点都要读取并处理该字段。

  - 目的选项包头：携带了一些只有目的节点才会处理的信息。

  - 路由包头：IPv6源节点用来强制数据包经过特定的设备。

  - 分段包头：当报文长度超过MTU（Maximum Transmission Unit，最大传输单元）时就需要将报文分段发送，而在IPv6中，分段发送使用的是分段包头。

  - 认证包头（AH）：该包头由IPsec使用，提供认证、数据完整性以及重放保护。

  - 封装安全净载包头（ESP）：该包头由IPsec使用，提供认证、数据完整性以及重放保护和IPv6数据包的保密。

### IPv6报文处理机制

![image-20220723153643165](./assets/image-20220723153643165.png)

## IPv6地址

IPv6地址的长度为128 bit。一般用冒号分割为8段，每一段16 bit，每一段内用十六进制表示。

### 缩写规范

- 每组16 bit的单元中的前导0可以省略，但是如果16 bit单元的所有比特都为0，那么至少要保留一个“0”字符；拖尾的0不能被省略。
- 一个或多个连续的16 bit字符为0时，可用“**::**”表示，但整个IPv6地址缩写中只允许有一个“**::**”。
- 若缩写后的IPv6地址出现两个“::”，会导致无法还原为原始IPv6地址。

### 地址分类

根据IPv6地址前缀，可将IPv6地址分为为单播地址、组播地址和任播地址。

IPV6地址

- 单播地址
  - 全球单播地址：2000::/3
  - 唯一本地地址：FD00::/8
  - 链路本地地址：FE80::/10
  - 特殊地址
    - 未指定地址：::/128
    - 环回地址：::1/128
  - 其他单播地址
- 组播地址
- 任播地址

单播地址（Unicast Address）：

- 标识一个接口，目的地址为单播地址的报文会被送到被标识的接口。

组播地址（Multicast Address）：

- 标识多个接口，目的地址为组播地址的报文会被送到被标识的所有接口。
- 只有加入相应组播组的设备接口才会侦听发往该组播地址的报文。

任播地址（Anycast Address）：

- 任播地址标识一组网络接口（通常属于不同的节点）。
- 目标地址是任播地址的数据包将发送给其中路由意义上最近的一个网络接口。

### 地址结构

**一个IPv6单播地址可以分为如下两部分：**

- 网络前缀（Network Prefix）：n bit，相当于IPv4地址中的网络ID。
- 接口标识（Interface Identify）：（128-n）bit ，相当于IPv4地址中的主机ID。

- 常见的IPv6单播地址如全球单播地址、链路本地地址等，要求网络前缀和接口标识必须为64 bit。
- 全球单播地址中，高位前3 bit为000的地址可以采用非64 bit的网络前缀。

**接口标识可通过三种方法生成**：

- 手工配置
- 系统自动生成
- 通过IEEE EUI-64规范生成

其中EUI-64规范最为常用，此规范将接口的MAC地址转换为IPv6接口标识。

**第7bit取反，中间插入FF-FE**

### 单播地址

- GUA（Global Unicast Address）全球单播地址：2000::/3
  
  - 001+45bit全局路由前缀+16bit子网ID+64b接口标志
  
- ULA(Unique Local Address)唯一本地地址：FC00::/7,目前仅使用FD00::/8，FC00::/8预留
  
  - IPV6私网地址，只能够在内网中使用。
  
  - 11111101+40bit伪随机+16bit子网ID+64b接口标志
  
- LLA（Link-Local Address）链路本地地址：FE80::/10
  
  - 1111111010+54bit ‘0’ +64bit接口标志
  - 每一个IPv6接口都必须具备一个链路本地地址
  - 链路本地地址的有效范围为本地链路

### 组播地址

- IPv6组播地址标识多个接口，一般用于“一对多”的通信场景。

- IPv6组播地址只可以作为IPv6报文的目的地址。

- FF+4bit Flags+4bit Scope+80bit Reserved（必须为0）+32bit Group ID

**IPv6组播地址各字段值对应的组播组类型和范围：**

- Flags：
  - 0000表示永久分配或众所周知 ；
  - 0001表示 临时的。

- Scope：

  - 0：预留；

  - 1：节点本地范围；单个接口有效，仅用于Loopback通讯。

  - 2：链路本地范围；例如FF02::1。

  - 5：站点本地范围；

  - 8：组织本地范围；

  - E：全球范围；

  - F：预留。

**被请求节点组播地址：**

- 当一个节点具有了单播或任播地址，就会对应生成一个被请求节点组播地址，并且加入这个组播组
- 该地址主要用于**邻居发现机制**和**地址重复检测**功能。
- 被请求节点组播地址的有效范围为**本地链路范围。**
- FF02::1:FF+24bit(单播地址或任播地址末24bit)

**在IPv6中，ARP及广播都被取消**，当设备需要请求某个IPv6地址对应的MAC地址时，设备依然需要发送请求报文，但是该报文是一个组播报文，其目的IPv6地址是目标IPv6单播地址对应的被请求节点组播地址，由于只有目标节点才会侦听这个被请求节点组播地址，所以该组播报文可以被目标节点所接收，同时不会占用其他非目标节点的网络性能。

### 任播地址

- 任播地址标识一组网络接口（通常属于不同的节点）。

- 任播地址可以作为IPv6报文的源地址，也可以作为目的地址。

**任播过程涉及一个任播报文发起方和一个或多个响应方。**

- 任播报文的发起方通常为请求某一服务（例如，Web服务）的主机。

- 任播地址与单播地址在格式上无任何差异，唯一的区别是一台设备可以给多台具有相同地址的设备发送报文。

**网络中运用任播地址有很多优势：**

- 业务冗余。
  - 比如，用户可以通过多台使用相同地址的服务器获取同一个服务（例如，Web服务）。这些服务器都是任播报文的响应方。
  - 如果不是采用任播地址通信，当其中一台服务器发生故障时，用户需要获取另一台服务器的地址才能重新建立通信。
  - 如果采用的是任播地址，当一台服务器发生故障时，任播报文的发起方能够自动与使用相同地址的另一台服务器通信，从而实现业务冗余。

- 提供更优质的服务。
  - 比如，某公司在A省和B省各部署了一台提供相同Web服务的服务器。
  - 基于路由优选规则，A省的用户在访问该公司提供的Web服务时，会优先访问部署在A省的服务器，提高访问速度，降低访问时延，大大提升了用户体验。

## IPV6地址配置

### 主机和路由器的IPv6地址

一般情况下，主机和路由器的单播IPv6地址以及加入的组播地址如下所示：

![image-20220723222030441](./assets/image-20220723222030441.png)

### IPv6单播地址业务流程

一个接口在发送IPv6报文之前要经历地址配置、DAD、地址解析这三个阶段，NDP（Neighbor Discovery Protocol，邻居发现协议）扮演了重要角色。

![image-20220723222123490](./assets/image-20220723222123490.png)

#### NDP

NDP使用ICMPv6报文实现其功能

![image-20220723222358706](./assets/image-20220723222358706.png)

- 无状态自动配置是IPv6的一个亮点功能，它使得IPv6主机能够非常便捷地接入到IPv6网络中，即插即用，无需手工配置繁冗的IPv6地址，无需部署应用服务器（例如DHCP服务器）为主机分发地址。
- 无状态自动配置机制使用到了ICMPv6中的路由器请求报文（Router Solicitation）及路由器通告报文（Router Advertisement）。

- 地址解析过程中使用了两种ICMPv6报文：邻居请求（Neighbor Solicitation）和邻居通告（Neighbor Advertisement）。

- 重复地址检测使用ICMPv6 NS和ICMPv6 NA报文确保网络中无两个相同的单播地址，所有接口在使用单播地址前都需要做DAD。

#### IPv6动态地址配置

Pv6支持地址有状态（stateful）和无状态（stateless）两种自动配置方式，通过ICMPv6 RA报文中的M标记（Managed Address Configuration Flag）和O标记（Other Stateful Configuration Flag）来控制终端自动获取地址的方式。

- 有状态地址配置（DHCPv6 ），M=1，O=1：
  - 采用DHCPv6协议，IPv6客户端将从DHCPv6服务器端获取完整的128 bit IPv6地址，同时包括DNS、SNTP服务器等地址参数。
  - 此外，DHCPv6服务器端将会记录该地址的分配情况（这也是为什么被称为有状态）。
  - 此方法配置较为复杂，且对DHCPv6服务器端的性能要求较高。
  - 有状态地址配置多用于公司内部有线终端的地址分配，便于对地址进行管理。

- 无状态地址配置，M=0，O=0：
  - 采用ICMPv6协议
  - 使能了ICMPv6 RA功能的路由器会周期性的通告该链路上的IPv6地址前缀。
  - 另一种情况，主机发送路由器查询（ICMPv6 RS）报文，路由器回复RA报文告知该链路IPv6地址前缀。
  - 主机根据路由器回应的RA报文，获得IPv6地址前缀信息，使用该地址前缀，加上本地产生的接口标识，形成单播IPv6地址。
  - 若主机还想获得其他配置信息，可以通过DHCPv6来获得除地址外的其他信息。当使用这种方式时，M=0，O=1。
  - 无状态地址配置的关键在于路由器完全不关心主机的状态如何，是否在线等，所以称为无状态。
  - 无状态地址配置多用于物联网等终端较多，且终端不需要除地址外其他参数的场景。

- DNS（Domain Name System，域名系统）：一种将用户容易记忆的域名映射为网络设备能够识别的IPv6地址的机制。

- NIS（Network Information System，网络信息服务）：用来管理电脑网络中所有与电脑系统管理相关配置文件的系统。

- SNTP（Simple Network Time Protocol，简单网络时钟协议 ）：由 NTP 改编而来，主要用来同步因特网中计算机的时钟。

**有状态地址配置（DHCPv6 ）**

- 通过DHCPv6报文交互，DHCPv6服务器端自动配置IPv6地址/前缀**及其他**网络配置参数（DNS、NIS、SNTP服务器地址等参数）。

**无状态地址配置**

- 主机根据RA中的地址前缀，并结合本地生成的64 bit接口标识（例如EUI-64），生成单播地址。

- **仅可以获得IPv6地址信息**，无法获得NIS、SNTP服务器等参数，需要配合DHCPv6或者手工配置来获取其他配置信息。

#### DAD

无论通过何种方式配置了IPv6单播地址，主机或路由器都会：

- 通过ICMPv6报文进行DAD

- 仅当DAD通过之后才会使用该单播地址

假设R1为已在线设备，IPv6地址为2001::FFFF/64。PC上线之后，也配置了相同的IPv6地址，在正式使用这个地址之前，PC会对此地址做DAD，过程如下:

- .PC向链路上以组播的方式发送一个NS报文，该NS的源IPv6地址为“::”，目的IPv6地址为要进行DAD的2001::FFFF对应的被请求节点组播地址，也就是FF02::1:FF00:FFFF。这个NS里包含着要做DAD的目标地址2001::FFFF。

- 链路上的节点都会收到这个组播的NS报文，没有配置2001::FFFF的节点接口由于没有加入该地址对应的被请求节点组播组，因此在收到这个NS的时候默默丢弃。而R1在收到这个NS后，由于它的接口配置了2001::FFFF地址，因此接口会加入组播组FF02::1:FF00:FFFF，而此刻所收到的报文又是以该地址为目的地址，因此它会解析该报文，它发现对方进行DAD的目标地址与自己本地接口地址相同，于是立即回送一个NA报文，该报文的目的地址是FF02::1，也就是所有节点组播地址，同时在报文内写入目标地址2001::FFFF，以及自己接口的MAC地址。

- .当PC收到这个NA后，它就知道2001::FFFF在链路上已经有人在用了，因此将该地址标记为Duplicate（重复的），该地址将不能用于通信。若未收到NA报文，则PC判断这个IPv6地址可以用，DAD机制有点类似于IPv4中的免费ARP检测重复地址。

#### 地址解析

IPv6的地址解析不再使用ARP，也不再使用广播方式，而采用和DAD相同的NS和NA报文解析数据链路层地址。

假设PC想要解析R1的2001::2这个地址对应的MAC地址，详细过程如下：

- PC将发送一个NS报文达到这个目的。这个NS报文的源地址是2001::1，目的地址则是2001::2对应的被请求节点组播地址。

- R1接收此NS报文，根据报文内的源IPv6地址和源MAC，记录下PC这个邻居，同时根据自身的IPv6和MAC，回复单播NA报文。

- PC收到此NA报文之后，获取其中的源IPv6地址和源MAC。这样双方都可以建立一条关于对方的邻居信息表项。

#### IPv6 VS IPv4

|    对比项    |                            IPv6                            |                        IPv4                        |
| :----------: | :--------------------------------------------------------: | :------------------------------------------------: |
|   地址长度   |                          128  bit                          |                      32  bit                       |
|   报文格式   | 固定40  Byte的基本包头，变长的拓展字段来实现一些IPv6的特性 | 通过在基本头部上增加option字段的方式支持  拓展特性 |
|   地址类型   |                      单播、组播、任播                      |                  单播、组播、广播                  |
|   地址配置   |                     静态、DHCP、SLAAC                      |                     静态、DHCP                     |
| 重复地址检测 |                       通过ICMPv6实现                       |                  通过免费ARP实现                   |
|   地址解析   |                       通过ICMPv6实现                       |                    通过ARP实现                     |

## IPv6基本配置 

```
#使能IPv6
[Huawei] ipv6
#在接口视图下，在接口上使能该接口的IPv6功能
[Huawei-GigabitEthernet0/0/0] ipv6 enable

#配置接口的链路本地地址
[Huawei-GigabitEthernet0/0/0] ipv6 address <ipv6-address>  link-local 手工
[Huawei-GigabitEthernet0/0/0] ipv6 address auto link-local 自动

#配置接口的全球单播地址
[Huawei-GigabitEthernet0/0/0] ipv6 address { <ipv6-address> <prefix-length> | <ipv6-address>/<prefix-length> }  
[Huawei-GigabitEthernet0/0/0] ipv6 address auto { global | dhcp }
在接口视图下，通过手工或者自动（有状态或无状态）的方式，配置接口的全球单播地址。

#配置IPv6静态路由
[Huawei] ipv6 route-static <dest-ipv6-address> <prefix-length> 
{ <interface-type> <interface-number> [ <nexthop-ipv6-address> ] 
| <nexthop-ipv6-address> } [ preference <preference> ] 

#查看接口的IPv6信息
[Huawei] display ipv6 interface [ <interface-type> <interface-number> | brief ] 

#查看邻居表项信息
[Huawei] display ipv6 neighbors 

#使能系统发布RA报文功能
[Huawei-GigabitEthernet0/0/0] undo ipv6 nd ra halt
默认情况下，华为路由器接口不发送ICMPv6 RA报文，则该接口所连链路上的其他设备无法进行无状态地址自动配合。
若想进行IPv6无状态地址配置，需要手工开启发送RA报文。
```

# SDN和NFV

## SDN概述

SDN（Software Defined Networking）即软件定义网络。是由斯坦福大学Clean Slate研究组提出的一种新型网络创新架构。 其核心理念通过将网络设备控制平面与数据平面分离，从而实现了网络控制平面的集中控制，为网络应用的创新提供了良好的支撑。

**SDN起源提出了三个特征， “转控分离”、“集中控制”和“开放可编程接口”。**

### OpenFlow基本概念

OpenFlow是控制器与交换机之间的一种南向接口协议。它定义了三种类型的消息，Controller-to-Switch、 Asynchronous 和 Symmetric。每一种消息又包含了更多的子类型。

**OpenFlow：**

- Controller-to-Switch
  - 该消息由Controller发送。用于管理Switch和查询Switch的相关信息。

- Asynchronous
  - 该消息由Switch发起。当Switch状态发生改变时，发送该消息告诉Controller状态变化。
- Symmetric
  - 该消息没有固定发起方，可由Switch或者Controller发起。例如Hello、Echo、Error等。

**Controller-to-Switch子类型：**

- Features消息：在SSL/TCP会话建立后，Controller给Switch发送Features请求Switch的相关信息。Switch必须应答自己支持的功能，包括接口名、接口MAC地址、接口支持的速率等等基本信息。

- Configuration消息：Controller可以设置或查询Switch的状态。

- Modify-State消息：Controller发送该消息给Switch，来管理Switch的状态，即增加/删除、更改流表，并设置Switch的端口属性。

- Read-State消息：Controller用该消息收集Switch上的统计信息。

- Send-Packet消息：Controller发送该消息到Switch的特定端口。

**Asynchronous子类型：**

- Packet-in消息：当Flow Table中没有匹配的表项或者匹配“send to Controller”，Switch将给Controller发送packet-in消息。

- Packet-out消息：从控制器回复的消息。

- Flow-Removed消息：当给Switch增加一条表项时，会设定超时周期。当时间超时后，该条目就会被删除。这时Switch就会给Controller发送Flow-Removed消息；当流表中有条目要删除时，Switch也会给Controller发送该消息。

- Port-status消息：当数据路径接口被添加、删除、修改的时候，此消息用于通知控制器。

**Symmetric子类型：**

- Hello消息：当一个OpenFlow连接建立时，Controller和Switch都会立刻向对端发送OFPT_HELLO消息，该消息中的version域填充发送方支持的OpenFlow协议最高的版本号；接收方收到该消息后，接收方会计算协议版本号，即在发送方和接收方的版本号中选择一个较小的；如果接收方支持该版本，则继续处理连接，连接成功；否则，接收者回复一个OFPT_ERROR消息，类型域中填充ofp_error_type.OFPET_HELLO_FAILED

- Echo消息： Switch和Controller任何一方都可以发起Echo request消息，但收到的一方必须回应Echo reply消息。这个消息可以来测量latency、Controller-Switch之间的连接性，即心跳消息；

- Error消息：当交换机需要通知控制器发生问题或错误时，Switch给Controller 发送Error消息。

**OpenFlow协议仍在持续更新。更多更全的消息类型请参考ONF最新发布《OpenFlow Switch Speciﬁcation》标准。**

### Flow Table简介

OpenFlow交换机基于流表（Flow Table）转发报文。

每个流表项由匹配字段、优先级、计数器、指令、超时、Cookie、Flags这七部分组成。

其中关于转发的关键的两个内容是**匹配字段**和**指令**。

- 匹配字段是匹配规则，支持自定义。

- 指令是用来描述匹配后的处理方式。

![image-20220724003947490](./assets/image-20220724003947490.png)

- Match Fields：流表项匹配项（OpenFlow 1.5.1版本支持45个可选匹配项），可以匹配入接口、物理入接口，流表间数据，二层报文头，三层报文头，四层端口号等报文字段等。

- Priority：流表项优先级，定义流表项之间的匹配顺序，优先级高的先匹配。

- Counters：流表项统计计数，统计有多少个报文和字节匹配到该流表项。

- Instructions：流表项动作指令集，定义匹配到该流表项的报文需要进行的处理。当报文匹配流表项时，每个流表项包含的指令集就会执行。这些指令会影响到报文、动作集以及管道流程。

- Timeouts：流表项的超时时间，包括了Idle Time和Hard Time。
  - Idle Time：在Idle Time时间超时后如果没有报文匹配到该流表项，则此流表项被删除。
  - Hard Time：在Hard Time时间超时后，无论是否有报文匹配到该流表项，此流表项都会被删除。

- Cookie：Controller下发的流表项的标识。

- Flags：该字段改变流条目的管理方式。

### 转发方式对比

- 经典路由协议基于路由表转发
  - 经典的网络转发方式是网络设备通过查询路由表指导流量转发。
  - 路由表的条目由网络设备之间运行路由协议而计算生成。
  - 路由表是定长的。路由表通过最长匹配原则执行报文转发。一台网络设备只有一张路由表。

- OpenFlow基于流表转发
  - OpenFlow是一个网络协议。运行OpenFlow的交换机通过查询流表指导流量转发。
  - 流表一般是由OF控制器统一计算，然后下发到交换机。
  - 流表是变长的，拥有丰富的匹配规则和转发规则。一台网络设备有多张流表。

- 流表的匹配原则是对于存在的“table0-table255”，优先从table0开始匹配。同一table内部按照优先级匹配，优先级高优先匹配。

- 当前OpenFlow的主流应用是用于数据中心的软件交换机，例如OVS、CE1800V等，而不是实现硬件交换机的转控分离。

### SDN的本质诉求

SDN的本质诉求是让网络更加开放、灵活和简单。它的实现方式是为网络构建一个集中的大脑，通过全局视图集中控制，实现或业务快速部署、或流量调优、或网络业务开放等目标。

**SDN的价值是：**

- 集中管理，简化网络管理与运维；
- 屏蔽技术细节，降低网络复杂度，降低运维成本；
- 自动化调优，提高网络利用率；
- 快速业务部署，缩短业务上线时间；
- 网络开放，支撑开放可编程的第三方应用。

**SDN是一个更为广泛的概念而不局限于OpenFlow。转控分离是实现SDN的一种方法而不是本质。**

### SDN网络架构

SDN网络架构分为协同应用层、控制器层和设备层。不同层次之间通过开放接口连接。以控制器层为主要视角，区分面向设备层的南向接口和面向协同应用层的北向接口。OpenFlow属于南向接口协议的一种。

- 协同应用层：主要完成用户意图的各种上层应用，典型的协同层应用包括OSS、OpenStack等。OSS可以负责整网的业务协同，OpenStack云平台一般用于数据中心负责网络、计算、存储的业务协同。还有其他的协同层应用，比如用户希望部署一个安全APP，这个安全APP不关心设备具体部署位置，只是调用了控制器的北向接口，例如Block（Source IP，DestIP），然后控制器会给各网络设备下发指令。这个指令根据南向协议不同而不同。

- 控制器层：控制器层的实体就是SDN控制器，是SDN网络架构下最核心的部分。控制层是SDN系统的大脑，其核心功能是实现网络业务编排。

- 设备层：网络设备接收控制器指令，执行设备转发。

- **NBI北向接口**：北向接口为控制器对接协同应用层的接口，主要为**RESTful**。

- **SBI南向接口**：南向接口为控制器与设备交互的协议，包括**NETCONF、SNMP、OpenFlow、OVSDB**等。

## 华为SDN

### 华为SDN网络架构

![image-20220724005406629](./assets/image-20220724005406629.png)

- 云平台：云数据中心内资源管理平台。云平台包含对网络资源、计算资源和存储资源的管理。OpenStack是最主流的开源云平台。
- EMS（Element Management System，网元管理系统）是管理特定类型的一个或多个电信NE（Network Element，网络单元）的系统。
- Orchestration（容器编排）：容器编排工具也可以包含网络业务编排功能。Kubernetes是主流的工具。
- MTOSI/CORBA用于对接BSS/OSS。Kafka/SFTP可用于对接大数据平台。

### 华为SDN解决方案-管、控、析构建智简网络

![image-20220724005512672](./assets/image-20220724005512672.png)

### iMaster NCE

iMaster NCE，自动驾驶网络管理与控制系统，是华为集管理、控制、分析和AI智能功能于一体的网络自动化与智能化平台。

![image-20220724005613474](./assets/image-20220724005613474.png)

- iMaster NCE能做什么？它有效连接了物理网络与商业意图。南向实现全局网络的集中管理、控制和分析。面向商业和业务意图使能资源云化、全生命周期网络自动化，以及数据分析驱动的智能闭环。北向提供开放网络API与IT快速集成。

- iMaster NCE用在哪里？可以在企业领域数据中心网络（DCN）、企业园区（Campus）、企业分支互联（SD-WAN）等场景，让企业网络更加简单、智慧、 开放和安全，加速企业的业务转型和创新。

![image-20220724005703438](./assets/image-20220724005703438.png)

**华为数据中心CloudFabric自动驾驶解决方案**

![image-20220724005907195](./assets/image-20220724005907195.png)

**华为园区网络CloudCampus自动驾驶解决方案**

![image-20220724005945255](./assets/image-20220724005945255.png)

**关键特性：**

- 设备即插即用
- 构建一网多用的虚拟化园区
- 业务随行，基于安全组的策略管理
- 有线与无线融合
- 终端智能识别，安全接入
- 园区网络AI智能运维

## NFV概述

网络功能虚拟化被称为NFV（Network Functions Virtualization），而虚拟化之后的网络功能被称为VNF（Virtualized Network Function）。

当我们谈“VNF”时，我们指运营商IMS、CPE这些传统网元在虚拟化之后的实现。在硬件通用化后，传统的网元不再是嵌入式的软硬结合的产品，而是以纯软件的方式安装在通用硬件（即NFVI）上。

### NFV的价值

NFV（Network Functions Virtualization ）是运营商为了解决电信网络硬件繁多、部署运维复杂、业务创新困难等问题而提出的。NFV在重构电信网络的同时，给运营商带来的价值如下：

- 缩短业务上线时间
- 降低建网成本
- 提升网络运维效率
- 构建开放的生态系统

### NFV关键技术：虚拟化

在NFV的道路上，虚拟化是基础，云化是关键。

传统电信网络中，各个网元都是由专用硬件实现，成本高、运维难。虚拟化具有分区、隔离、封装和相对于硬件独立的特征，能够很好匹配NFV的需求。运营商引入此模式，将网元软件化，运行在通用基础设施上。

### NFV关键技术：云化

美国国家标准与技术研究院（NIST）定义：云计算是一种模型，它可以实现随时随地，便捷地，随需应变地从可配置计算资源共享池中获取所需的资源（例如，网络、服务器、存储、应用、及服务），资源能够快速供应并释放，使管理资源的工作量和与服务提供商的交互减小到最低限度。

云计算拥有诸多好处。运营商网络中网络功能的云化更多的是利用了资源池化和快速弹性伸缩两个特征。

**美国国家标准和技术研究院的定义，云计算服务应该具备以下几条特征：**

按需自助服务（On-demand Self-service）：云计算实现了IT资源的按需自助服务，不需要IT管理员的介入即可申请和释放资源。

- 广泛网络接入（Broad Network Access）：有网络即可随时、随地的使用。
- 资源池化（Resource Pooling）：资源池中的资源包括网络、服务器、存储等资源，提供给用户使用。
- 快速弹性伸缩（Rapid Elasticity）：资源能够快速的供应和释放。申请即可使用，释放立即回收资源。
- 可计量服务（Measured Service）：计费功能。计费依据就是所使用的资源可计量。例如按使用小时为时间单位，以服务器CPU个数、占用存储的空间、网络的带宽等综合计费。

### NFV架构简介

NFV架构分**NFVI** （Network Functions Virtualization Infrastructure，基础设施层）、 **VNF**（ Virtualized Network Function，虚拟化网络功能层）和**MANO**（Management and Orchestration，管理编排域），同还要支持现有的BSS/OSS（Business support system/ Operation support system）。

![image-20220724011218949](./assets/image-20220724011218949.png)

- NFV架构每一层都可以由不同的厂商提供解决方案，在提高系统开发性的同时增加了系统集成的复杂度。
- NFV价值是通过设备归一和软硬件解耦实现资源的高效利用，可以降低运营商TCO，缩短业务上线时间，打造开放的产业生态。
- NFVI包含硬件层和虚拟化层，业界也有说法称作COTS和CloudOS：
  - COTS（commercial off-the-shelf，商用现货），即通用硬件，强调了易获得性和通用性。例如Huawei FusionServer系列硬件服务器。
  - CloudOS：设备云化的平台软件，可以理解为电信业的操作系统。CloudOS提供了硬件设备的虚拟化能力，将物理的计算/存储/网络资源变成虚拟资源供上层的软件使用。例如华为的云操作系统FusionSphere。
- VNF：VNF可以理解为各种不同网络功能的APP，是运营商传统网元（IMS，EPC，BRAS，CPE…）的软件实现。
- MANO：MANO的引入是要解决NFV多CT/IT厂家环境下的网络业务的发放问题，包括：分配物理/虚拟资源，垂直打通管理各层，快速适配对接新厂家新网元。MANO包括NFVO（Network Functions Virtualization Orchestrator，负责网络服务的生命周期的管理）、VNFM（Virtualized Network Function Manager, 负责VNF的生命周期管理）、VIM（Virtualized Infrastructure Manager，负责NFVI的资源管理）三部分。

#### NFV的标准架构

ETSI定义了NFV标准架构，由NFVI、VNF以及MANO主要组件组成。NFVI包括通用的硬件设施及其虚拟化，VNF使用软件实现虚拟化网络功能，MANO实现NFV架构的管理和编排。

![image-20220724011515604](./assets/image-20220724011515604.png)

#### NFV架构功能模块

![image-20220724011607388](./assets/image-20220724011607388.png)

- BSS：Business support system 业务支撑系统。
- OSS：Operation support system 运营支撑系统。
- Hypervisor：是一种运行在物理服务器和虚拟机操作系统之间的中间软件层，可允许多个操作系统和应用共享一套基础物理硬件。因此也可以看作是虚拟环境中的“元”操作系统，它可以协调访问服务器上的所有物理设备和虚拟机，也叫虚拟机监视器（Virtual Machine Monitor VMM）。Hypervisor是所有虚拟化技术的核心。目前主流的Hypervisor有KVM，VMWare ESXi，Xen，HyperV等。

#### NFV架构接口

**NFV标准架构的主要接口：**

![image-20220724011726098](./assets/image-20220724011726098.png)

#### 华为NFV解决方案

华为NFV架构中，虚拟化层及VIM的功能由华为云Stack NFVI平台实现。华为云Stack可以实现计算资源、存储资源和网络资源的全面虚拟化，并能够对物理硬件虚拟化资源进行统一的管理、监控和优化。

华为提供运营商无线网、承载网、传输网、接入网、核心网等全面云化的解决方案。

![image-20220724011815567](./assets/image-20220724011815567.png)

- DSL（Digital Subscriber Line）数字用户线路
- OLT（Optical Line Terminal）光线路终端

# 网络编程与自动化

## 网络自动化

- 网络自动化，通过工具实现网络自动化地部署、运行和运维，逐步减少对“人”的依赖。这能够很好地解决传统网络运维的问题。

- 业界有很多实现网络自动化的开源工具，例如Ansible、SaltStack、Puppet、Chef等。从网络工程能力构建的角度考虑，更推荐工程师具备代码编程能力。

## 编程语言概述

- 编程语言（Programming Language），是一种用于编写计算机程序的语言，用于控制计算机的行为。

- 按照语言在执行之前是否需要编译区分，可以将编程语言分为需要编译的编译型语言（Compiled Language），不需要编译的解释型语言（Interpreted Language） 。

![image-20220724012602722](./assets/image-20220724012602722.png)

### 计算技术栈与程序执行过程

![image-20220724012626670](./assets/image-20220724012626670.png)

### 高级编程语言-编译型语言

- **编译型语言**：编译型语言的程序在执行之前有一个编译过程，把程序编译成为机器语言的文件。运行时不需要重新翻译，直接使用编译的结果。典型的如C/C++/Go语言，都属于编译型语言。

- **从源码到程序的过程**：源码需要由编译器、汇编器翻译成机器指令，再通过链接器链接库函数生成机器语言程序。机器语言必须与CPU的指令集匹配，在运行时通过加载器加载到内存，由CPU执行指令。

编译型语言编译的时候直接编译成机器可以执行的格式（例如.exe .dll .ocx）。编译和执行是分开的，不能跨平台执行，例如X86程序不能在ARM架构服务器上运行。

![image-20220724012816865](./assets/image-20220724012816865.png)

### 高级编程语言 - 解释型语言

- **解释型语言**：解释型语言的程序不需要在运行前编译，在运行程序的时候才逐行翻译。典型的如Java/Python语言，都属于解释型语言。

- **从源码到程序的过程**：解释型语言的源代码由编译器生成字节码，然后再由虚拟机（JVM/PVM）解释执行。虚拟机将不同CPU指令集的差异屏蔽，因此解释型语言的可移植性相对较好。

![image-20220724012902557](./assets/image-20220724012902557.png)

- JVM：Java虚拟机。
- PVM：Python虚拟机。

## Python

Python是一门完全开源的高级编程语言。它的作者是Guido Van Rossum。

Python同时也是动态类型语言。动态类型语言是指在程序运行的过程中自动决定对象的类型，不需要声明变量的类型。

**Python的优点：**

- Python拥有优雅的语法、动态类型具有解释性质。能够让学习者从语法细节的学习中抽离，专注于程序逻辑。
- Python同时支持面向过程和面向对象的编程。
- Python拥有丰富的第三方库。
- Python可以调用其他语言所写的代码，又被称为胶水语言。

**Python的缺点：**

- 运行速度慢。Python是解释型语言，不需要编译即可运行。代码在运行时会逐行地翻译成CPU能理解的机器码，这个翻译过程非常耗时。

由于Python具有非常丰富的第三方库，加上Python语言本身的优点，所以Python可以在非常多的领域内使用：人工智能、数据科学、APP、自动化运维脚本等。

**Python代码执行过程**

![image-20220724013251199](./assets/image-20220724013251199.png)

对于Python而言，Python源码不需要编译成二进制代码，它可以直接从源代码运行程序。当我们运行Python代码的时候，Python解释器首先将源代码转换为字节码，然后再由Python虚拟机来执行这些字节码。

Python虚拟机（Python VM）不是一个独立的程序，不需要独立安装。

### 初识Python代码

Python有两种运行方式，交互式运行和脚本式运行。

- 交互式编程不需要创建脚本文件，是通过 Python 解释器的交互模式编写代码。

- 脚本模式里的代码可以在各种Python编译器或者集成开发环境上运行。例如Python自带的IDLE、Atom、Visual Studio、Pycharm和Anaconda等。

### Python编码规范

![image-20220724013930059](./assets/image-20220724013930059.png)

#### 标识符命名

- Python标识符用于表示常量、变量、函数以及其他对象的名称。

- 标识符通常由字母、数字和下划线组成，但不能以数字开头。
- 标识符大小写敏感，不允许重名。
- 如果标识符不符合规则，编译器运行代码时会输出**SyntaxError**语法错误。
- Python最基本的数据类型有布尔型（True/False）、整数、浮点型、字符串型。Python里的所有数据（布尔值、整数、浮点、字符串，甚至大型数据结构、函数以及程序）都是以对象（object）的形式存在的。这使得Python语言有很强的统一性。

#### 代码缩进

- 在Python程序中，代码缩进代表代码块的作用域。
- 如果一个代码块包含两个或更多的语句，则这些语句必须具有相同的缩进量。
- 对于Python而言代码缩进是一种语法规则，它使用代码缩进和冒号来区分代码之间的层次。

- 编写代码时候，建议使用4个空格来生成缩进。
- 如果程序代码中使用了错误的缩进，则会在运行中发出**IndentationError**错误信息。

#### 使用注释

- 注释就是在程序中添加解释说明，能够增强程序的可读性。
- 在Python程序中，注释分为单行注释和多行注释。

- 单行注释以 # 字符开始直到行尾结束。

- 多行注释内容可以包含多行，这些内容包含在一对三引号内（’’’…’’’或者”””…”””）。

#### 源码文件结构

- 一个完整的Python源码文件一般包含几个组成部分：解释器和编码格式声明、文档字符串、模块导入和运行代码。

- 如果会在程序中调用标准库或其他第三方库的类时，需要先使用import或from… import语句导入相关的模块。导入语句始终在文件的顶部。在模块注释或文档字符串(docstring)之后。

![image-20220724014337196](./assets/image-20220724014337196.png)

- 解释器声明的作用是指定运行本文件的编译器的路径（非默认路径安装编译器或有多个Python编译器）。Windows操作系统上可以省略本例中第一行解释器声明。

- 编码格式声明的作用是指定本程序使用的编码类型，以指定的编码类型读取源代码。Python 2 默认使用的是 ASCII 编码 (不支持中文)，Python 3 默认支持 UTF-8 编码 ( 支持中文)。

- 文档字符串的作用是对本程序功能的总体介绍。

- time为Python内置模块，作用是提供处理时间相关的函数。

### Python的函数与模块

- 函数(Function)是组织好的、可重复使用的一段代码。它能够提高程序的模块化程度和代码利用率。**函数使用关键字 def 定义**。

- 模块(Module)是一个保存好的Python文件。模块可以由函数或者类组成。模块和常规Python程序之间的唯一区别是用途不同：模块用于被其他程序调用。因此，**模块通常没有main函数**。

### Python的类与方法

- 类(Class)是用来描述具有一类相同的属性和方法的集合。**类的定义使用关键字 class**。

- 被实例化的类的”函数”被称作方法(Method)。**类定义方法时候必须携带 self 关键字**，它表示类的实例本身。

### telnetlib介绍

telnetlib是Python标准库中的模块。它提供了实现Telnet功能的类telnetlib.Telnet。

这里通过调用telnetlib.Telnet类里的不同方法实现不同功能。

![image-20220724014919771](./assets/image-20220724014919771.png)

- Telnet定义了网络虚拟终端（NVT，Network Virtual Terminal）。它描述了数据和命令序列在Internet上传输的标准表示方式，以屏蔽不同平台和操作系统的差异，例如不同平台上换行的指令不一样。

- Telnet通信采用带内信令方式，即Telnet命令在数据流中传输。为了区分Telnet命令和普通数据，Telnet采用转义序列。每个转移序列由两个字节构成，前一个字节是(0xFF)叫做IAC（Interpret As Command）“解释为命令”，标识了后面一个字节是命令。EOF也是一种Telnet命令，十进制编码是236。

- 套接字（socket）是一个抽象层，应用程序通常通过"套接字"向网络发出请求或者应答网络请求。

# 园区网络典型组网架构

## 什么是园区网

园区网络是限定区域内，连接人与物的局域网络；园区网络通常只有一个管理主体；如果有多个管理主体，通常被认为为多个园区网络。

![image-20220724125630868](./assets/image-20220724125630868.png)

## 园区网络典型架构

![image-20220724125721968](./assets/image-20220724125721968.png)

- 园区网络典型层次和区域：
  - 核心层：是园区网骨干，是园区数据交换的核心，联接园区网的各个组成部分，如数据中心、管理中心、园区出口等。
  - 汇聚层：处于园区网的中间层次，完成数据汇聚或交换的功能，可以提供一些关键的网络基本功能，如路由、 QoS、安全等。
  - 接入层：为终端用户提供园区网接入服务，是园区网的边界。
  - 出口区：园区内部网络到外部网络的边界，用于实现内部用户接入到公网，外部用户接入到内部网络。一般会在此区域中部署大量的网络安全设备来抵御外部网络的攻击，如IPS（intrusion prevention system，入侵防御系统）、Anti-DDoS设备、Firewall（防火墙）等。
  - 数据中心区：部署服务器和应用系统的区域，为企业内部和外部用户提供数据和应用服务。
  - 网络管理区：部署网络管理系统的区域，包括SDN控制器，无线控制器，eLOG（日志服务器）等，管理监控整个园区网络。

### 小型园区网络典型架构

![image-20220724125840316](./assets/image-20220724125840316.png)

### 中型园区网络典型架构

![image-20220724125906457](./assets/image-20220724125906457.png)

### 大型园区网络典型架构

![image-20220724125933005](./assets/image-20220724125933005.png)

## 园区网络主要协议/技术

![image-20220724130004217](./assets/image-20220724130004217.png)

## 园区网络项目生命周期

![image-20220724130125512](./assets/image-20220724130125512.png)

- 网络的规划与设计是一个项目的起点，完善细致的规划工作将为后续的项目具体工作打下坚实的基础。 
- 项目实施是工程师交付项目的具体操作环节，系统的管理和高效的流程是确保项目实施顺利完成的基本要素。
- 要保证网络各项功能正常运行、从而支撑用户业务的顺利开展，需要对网络进行日常的维护工作和故障处理。
- 用户的业务在不断发展，因此用户对网络功能的需求也会不断变化。当现有网络不能满足业务需求，或网络在运行过程中暴露出了某些隐患时，就需要通过网络优化来解决。

## 小型园区网络设计

![image-20220724130253698](./assets/image-20220724130253698.png)

**规划与设计**

- 组网方案设计
  - 设备选型
  - 物理拖布
- 网络设计
  - 基础业务设计
    - VLAN设计
    - IP地址设计
    - IP地址分配方式设计
    - 路由设计
  - WLAN设计
  - 可靠性设计
  - 二层环路避免
  - 出口NAT设计
- 安全设计

- 运维管理设计

**部署与实施**

- 项目的部署与实施需要按照一定流程进行，内容包括：
  - 方案制定
  - 设备安装
  - 网络调试
  - 割接并网
  - 转维培训
  - 项目验收
- 具体流程按照项目实际情况进行确定。

**网络调试**

- 联通性测试
  - 基础链路对接测试
  - 二层互通测试
  - 三层互通测试
- 高可靠性能力调试
  - 防环功能测试
  - 路径切换测试
  - 双机热备测试
- 业务性能测试
  - 业务流量测试
  - 访问控制测试

**网络运维**

- 项目上线运行之后，就进入到了运维阶段，常见的运维手段包括：
  - 设备环境检查
  - 设备基本信息检查
  - 设备运行状态检查
  - 业务检查
  - 告警处理
- 当网络达到一定规模，可以采用网络管理软件进行管理和运维，提升效率。

**网络优化**

- 通过网络优化，能够整体提升网络的可靠性、健壮性，更好的支撑企业业务的发展。常见的优化方案包括但不限于：
  - 设备性能优化，如升级硬件设备、更新设备软件版本等。
  - 网络基础优化，如网络架构优化、路由协议调整等。
  - 业务质量优化，如针对语音、视频业务的优先转发等。
- 应从网络需求出发，结合实际情况制定适合的优化方案。

**VLAN设计**

- VLAN编号建议连续分配，以保证VLAN资源合理利用。
- VLAN划分需要区分业务VLAN、 管理VLAN和互联VLAN。 
- 最常用的划分方式是基于接口的方式。

| VLAN编号 |           VLAN描述            |
| :------: | :---------------------------: |
|    1     |    访客VLAN/WLAN的业务VLAN    |
|    2     |          研发部VLAN           |
|    3     |          市场部VLAN           |
|    4     |          行政部VLAN           |
|   100    |      二层设备的管理VLAN       |
|   101    |        WLAN的管理VLAN         |
|   102    | Agg-S1与CORE-R1之间的互联VLAN |

**IP地址设计**

- 业务IP地址
  - 网关IP地址推荐统一使用相同的末位数字，如.254。
  - 各业务IP地址范围要清晰区分，每一类业务终端IP地址连续、可聚合。
  - 建议使用掩码为24位的IP地址段。
- 管理IP地址
  - 二层设备使用VLANIF地址作为管理IP地址，建议网关下的所有二层交换机使用同一网段。
- 网络设备互联IP地址
  - 互联IP地址推荐使用30位掩码的IP地址，核心设备使用主机地址较小的IP地址。

|   IP网段/掩码    |    网关地址     |                  网段描述                   |
| :--------------: | :-------------: | :-----------------------------------------: |
|  192.168.1.0/24  |  192.168.1.254  |    无线接入访客所属网段，网关位于Agg-S1     |
|  192.168.2.0/24  |  192.168.2.254  |       研发部所属网段，网关位于Agg-S1        |
|  192.168.3.0/24  |  192.168.3.254  |       市场部所属网段，网关位于Agg-S1        |
|  192.168.4.0/24  |  192.168.4.254  |       行政部所属网段，网关位于Agg-S1        |
| 192.168.100.0/24 | 192.168.100.254 |     二层设备的管理网段，网关位于Agg-S1      |
| 192.168.101.0/24 |       N/A       |               WLAN的管理网段                |
| 192.168.102.0/30 |       N/A       |         Agg-S1与CORE-R1之间互联网段         |
|    1.1.1.1/32    |       N/A       | CORE-R1上的Loopback接口地址，作为管理IP使用 |

**IP地址分配方式设计**

- IP地址分配时可以使用动态IP分配或者静态IP绑定。在中小型园区中， IP地址具体的分配原则如下：

- 出口网关设备： WAN侧接口的IP地址由运营商进行分配，可以通过静态IP地址、 DHCP、 或者PPPoE方式分配，对于出口网关的IP地址需要提前与运营商沟通获取。

- 服务器、特殊终端设备（打卡机、打印服务器、 IP视频监控设备等）建议采用静态IP地址绑定方式分配。

- 用户终端：用户办公用PC、IP电话等设备建议通过在网关设备上部署DHCP Server后，统一通过DHCP方式动态分配

|                         IP网段/接口                          | 分配方式 |                         分配方式描述                         |
| :----------------------------------------------------------: | :------: | :----------------------------------------------------------: |
| 192.168.1.0/24  192.168.2.0/24  192.168.3.0/24  192.168.4.0/24 |   DHCP   | 由网关Agg-S1分配，还应分配给服务器及打印机等固定设备分配固定IP地址。 |
|                       192.168.100.0/24                       |   静态   |                     设备管理IP，静态配置                     |
|                       192.168.101.0/24                       |   DHCP   |              AC地址静态配置，AP地址由Agg-S1分配              |
|                       192.168.102.0/30                       |   静态   |                       互联IP，静态配置                       |
|                       CORE-R1的GE0/0/0                       |  PPPoE   |                      运营商分配的IP地址                      |

**路由设计**

- 中小型园区网络的路由设计包括园区内部的路由设计及园区出口与Internet/广域设备之间的路由设计。

- 园区内部的路由设计：主要满足园区内部设备/终端的互通需求，并且可以与外部路由交互。由于中小型园 区的网络规模比较小，网络结构也比较简单。 
  - AP设备：通过DHCP分配IP地址后默认会生成一条缺省路由。
  - 交换机、网关设备：通过静态路由即可满足需求，无需部署复杂的路由协议。 

- 园区出口的路由设计：出口路由设计主要满足园区内部用户访问Internet和广域网的需求。出口设备与 Internet或者WAN连接时，建议在出口设备上配置静态路由来满足需求。

**WLAN设计**

除了要规划组网和数据转发方式外，仍需进行：

- 网络覆盖设计：针对无线网络覆盖的区域设计规划，保证区域覆盖范围内的信号强度能满足用户的要求，并且解决相邻AP间的同频干扰问题。

- 网络容量设计：根据无线终端的带宽要求、终端数目、并发率、单AP性能等数据来设计部署网络所需的AP数量，确保无线网络性能可以满足所有终端的上网业务需求。

- AP布放设计：在网络覆盖设计的基础上，根据实际情况对AP的实际布放位置、布放方式和供电走线原则进行修正确认。

- 此外还需进行WLAN安全设计、漫游设计等。

|          配置项          |                           配置内容                           |
| :----------------------: | :----------------------------------------------------------: |
|        AP管理VLAN        |                           VLAN101                            |
|        STA业VLAN         |                            VLAN1                             |
|        DHCP服务器        | Agg-S1作为DHCP服务器为AP和STA分，STA的默认网关为192.168.1.254 |
|       AP的IP地址池       |               192.168.101.2~192.168.101.253/24               |
|      STA的IP地址池       |                 192.168.1.1~192.168.1.253/24                 |
| AC的源接口        IP地址 |                 VLANIF101：192.168.101.1/24                  |
|           AP组           | 名称：ap-group1     引用模板：VAP模板WLAN-Guest、域管理模板default |
|        域管理模板        |                 名称：default     国家码：CN                 |
|         SSID模板         |          名称：WLAN-Guest     SSID名称：WLAN-Guest           |
|         安全模板         | 名称：WLAN-Guest     安全策略：WPA-WPA2+PSK+AES     密码：WLAN@Guest123 |
|         VAP模板          | 名称：WLAN-Guest     转发模式：直接转发     业务VLAN：VLAN1     引用模板：SSID模板WLAN-Guest、安全模板WLAN-Guest |

